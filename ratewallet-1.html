<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>利率优惠签报 · 智能生成器</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
:root{
  --ink:#0b1220; --muted:#667085; --line:#e6e9ef;
  --mario-red:#e11d48; --sky:#38bdf8; --coin:#f59e0b; --green:#10b981;
  --paper:rgba(255,255,255,.9); --radius:18px;
  --shadow:0 14px 34px rgba(2,6,23,.12), 0 2px 8px rgba(2,6,23,.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;color:var(--ink);
  font:15.5px/1.6 -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Hiragino Sans GB",Segoe UI,Roboto,Helvetica,Arial}
.bg{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg,#e0f2fe 0%, #f0f9ff 40%, #fff 100%)}
.bg::before{content:"";position:absolute;inset:-8% -8%;background-size:cover;background-position:center;filter:blur(16px) opacity(.25)}
.wrap{max-width:1080px;margin:0 auto;padding:22px 16px 120px}
header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.logo{width:42px;height:42px;border-radius:12px;background:
  radial-gradient(40% 40% at 30% 30%,#fff,transparent 70%),
  conic-gradient(from 200deg,var(--mario-red),#ef4444 30%,#fb7185 60%,var(--mario-red));
  box-shadow:0 10px 26px rgba(225,29,72,.28),0 2px 8px rgba(16,24,40,.08)}
h1{margin:0;font-weight:800;font-size:clamp(20px,2.6vw,28px);letter-spacing:.2px}
.sub{color:var(--muted);font-size:13px;margin-top:2px}

.card{background:var(--paper);backdrop-filter:saturate(150%) blur(10px);
  border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow); margin-bottom: 14px;}
.grid2{display:grid;grid-template-columns:1.08fr .92fr;gap:14px}
.row{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:center;margin:10px 0}
label{color:#475569; font-weight: 600;}
input[type=text],input[type=number],select,textarea{
  width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;color:var(--ink);
  padding:10px 12px;outline:none;transition:border .15s,box-shadow .15s}
input:focus,select:focus,textarea:focus{border-color:#bae6fd;box-shadow:0 0 0 5px rgba(56,189,248,.18)}
textarea{min-height:80px}

.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{border:2px solid #e2e8f0;border-radius:14px;padding:8px 14px;background:linear-gradient(180deg,#fff,#f8fafc);
  color:#0b1220;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
.chip:hover{transform:translateY(-1px)}
.chip.sel{background:linear-gradient(180deg,#fef3c7,#fde68a); border-color:#f59e0b; box-shadow:0 6px 14px rgba(245,158,11,.25)}

.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
.pill.ok{background:linear-gradient(180deg,#ecfeff,#dbeafe);border-color:#bfdbfe;color:#1e3a8a}
.pill.warn{background:linear-gradient(180deg,#fff7ed,#ffedd5);border-color:#fed7aa;color:#7c2d12}
.pill.err{background:linear-gradient(180deg,#fef2f2,#fee2e2);border-color:#fecaca;color:#7f1d1d}
.btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;border:none;border-radius:14px;padding:12px 16px;color:#fff;
  background:linear-gradient(90deg,var(--mario-red) 0%, var(--coin) 100%);box-shadow:0 10px 24px rgba(225,29,72,.28);cursor:pointer;font-weight:800;letter-spacing:.2px}
.btn:active{transform:translateY(1px)}
.btn.sky{background:linear-gradient(90deg,#0ea5e9, #22d3ee)}
.btn.ghost{background:#f3f5fb;color:#1f2a44;border:1px solid var(--line);box-shadow:none}
.btn.badge{font-size:13px;padding:8px 12px;border-radius:12px}
.dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:rgba(255,255,255,.86);
  backdrop-filter:saturate(150%) blur(10px);border-top:1px solid var(--line)}
.dock-inner{max-width:1080px;margin:0 auto;padding:12px 16px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
.log{margin-left:auto;color:var(--muted);font-size:12.5px}
#out{white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:12px;border-radius:12px;min-height:160px}
.hints{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.hint{font-size:12px;color:#475569;padding:6px 10px;border:1px dashed #e2e8f0;border-radius:10px;background:#fff}
.subtle{font-size:12px;color:#64748b}
.titlebar{display:flex;align-items:center;gap:8px}
.titlebar .coin{filter:drop-shadow(0 6px 10px rgba(245,158,11,.35))}

@keyframes jump { 0%{transform:translateY(0)} 40%{transform:translateY(-8px)} 100%{transform:translateY(0)} }
.jump{animation:jump .28s ease-out}
.rocket{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);font-size:26px;animation:fly 1.5s ease-out forwards;z-index:50}
@keyframes fly{0%{transform:translate(-50%,0) scale(1);opacity:1}100%{transform:translate(-50%,-82vh) scale(1.2);opacity:0}}
.burst{position:fixed;bottom:0;font-size:22px;animation:fall 1.6s ease-out forwards;z-index:45}
@keyframes fall{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-80vh) scale(1.3);opacity:0}}
.toast{position:fixed;left:50%;bottom:88px;transform:translateX(-50%) scale(.96);opacity:0;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:60}
.toast.show{opacity:1;transform:translateX(-50%) scale(1);transition:all .18s ease}

.brick{height:10px;background:repeating-linear-gradient(90deg,#f59e0b 0 12px,#d97706 12px 24px);opacity:.2;border-radius:10px;margin:6px 0}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:80}
.modal .panel{background:#fff;border-radius:16px;max-width:460px;width:calc(100% - 40px);padding:18px;box-shadow:var(--shadow);position:relative}
.modal .panel .close{position:absolute;right:12px;top:10px;cursor:pointer;color:#64748b;font-size:18px;font-weight:bold;z-index:1}
.modal.show{display:flex}

@media (max-width:860px){
  .grid2{grid-template-columns:1fr}
  .row{grid-template-columns:1fr}
  .btn{padding:12px 14px}
  #out{min-height:220px}
}
</style>
</head>
<body>
<div class="bg" id="bg"></div>

<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <div class="titlebar">
        <h1>利率优惠签报 · 智能生成器</h1>
        <span id="apprBadge" class="pill ok" title="系统按阈值自动判断">
          <span>审批口径</span>
          <span id="apprBadgeText">分行审批权限</span>
        </span>
        <span class="coin" aria-hidden="true">🪙</span>
      </div>
    </div>
  </header>

  <div class="grid2">
    <div class="card">
      <div class="row"><label>分行（用于标题）</label><input id="branch" type="text" value="厦门分行科技业务部" placeholder="如：厦门分行科技业务部"></div>
      <div class="row"><label>客户名称</label><input id="cust" type="text" placeholder="如：厦门某某科技有限公司"></div>
      <div class="row"><label>场景预设</label>
        <div class="chips" id="presetChips"></div>
      </div>
      <div class="row"><label>行业类型</label>
        <select id="industry"></select>
      </div>
      <div class="row"><label>客群 (多选)</label>
        <div class="chips" id="segChips"></div>
      </div>
      <div class="row"><label>授信品种 (多选)</label>
        <div class="chips" id="prodChips"></div>
      </div>
      <div class="row"><label>担保方式</label>
        <select id="gb"></select>
      </div>
      <div class="row"><label>贷款用途</label>
        <select id="use"></select>
      </div>
    </div>

    <div class="card">
      <div class="row"><label>金额（万元）</label><input id="amt" type="number" placeholder="如：500" value="500"></div>
      <div class="row"><label>期限</label>
        <select id="tenor">
          <option>1年</option><option>6个月</option><option>2年</option><option>3年</option><option>4年</option>
        </select>
      </div>
      <div class="row"><label>执行利率(%)</label>
        <div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="rate" type="number" step="0.01" value="2.60" style="width:180px">
            <span class="hint" id="rateHint">建议：—</span>
            <button class="btn badge sky" id="applySuggest" type="button">应用建议</button>
          </div>
        </div>
      </div>
      <div class="row"><label>LPR(一年期%)</label><input id="lpr" type="number" step="0.01" value="3.00"></div>
      <div class="row"><label>FTP(%)</label><input id="ftp" type="number" step="0.01" value="1.90"></div>
      <div class="row"><label>是否存量 (单选)</label>
        <div class="chips" id="stockChips">
            <span class="chip sel" data-v="否">否</span>
            <span class="chip" data-v="是">是</span>
        </div>
      </div>
      <div class="row" id="stockRow" style="display:none">
        <label>存量利率(%)</label><input id="stockRate" type="number" step="0.01" placeholder="如：3.20">
      </div>
      <div class="row"><label>EVA（可手填）</label><input id="eva" type="text" placeholder="如：13.93"></div>
      <div class="row"><label>OCR 识别 EVA</label>
        <div>
          <input id="ocrImg" type="file" accept="image/*" multiple />
          <div class="small" id="ocrLog">（可选；识别失败不影响）</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items: flex-start;"><label>补充说明 (可选)</label>
      <textarea id="note" placeholder="如有其他需要说明的事项，请在此处填写..."></textarea>
    </div>
  </div>

  <div class="card">
    <div class="row" style="grid-template-columns:1fr"><label style="grid-column:1/-1">预览</label>
      <div class="hints" id="smartHints"></div>
      <div class="titlebar" style="justify-content:space-between;margin:6px 0 6px 0">
        <div style="font-weight:700">正文（完整）</div>
      </div>
      <div id="out"></div>
      <div class="brick"></div>
      <div class="titlebar" style="justify-content:space-between;margin:10px 0 6px 0">
        <div style="font-weight:700">OA 摘要（基础要点）</div>
      </div>
      <div id="summaryOut" style="white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:12px;border-radius:12px;min-height:120px"></div>
      <div class="subtle">提示：正文用于附件或完整签报；摘要适配 OA 字段。</div>
    </div>
  </div>
</div>

<div class="dock">
  <div class="dock-inner">
    <button class="btn" id="btnCopy">复制正文<span class="jump">🍄</span></button>
    <button class="btn" id="btnCopySummary">复制摘要</button>
    <button class="btn sky" id="btnOcr">识别EVA</button>
    <button class="btn ghost" id="btnDocx">生成 Word（含图片）</button>
    <button class="btn ghost" id="btnCheer">我爱XD.Hu</button>
    <span class="log" id="log">就绪</span>
  </div>
</div>

<div id="cheerModal" class="modal">
  <div class="panel" style="position:relative">
    <span class="close" id="cheerClose" title="关闭">✖</span>
    <h3 style="margin:0 0 8px 0">我爱XD.Hu</h3>
    <p class="small">你就说棒不棒～！内容记得核对哦，我希望你我都可以更快、更准、更合规地完成日常工作。</p>
    <p class="small">狠狠给我夸！欢迎联系：<b>coolkiy@gmail.com</b></p>
    <p class="small">感谢支持，感谢夸奖，别给建议～改不过来～我会优化～持续优化～么么哒～</p>
  </div>
</div>

<script>
'use strict';

// --- Embedded Data Store ---
const PHRASES = {
  "uiDefaults": {
    "branch": "厦门分行",
    "dept": "科技业务部",
    "email": "coolkiy@gmail.com",
    "showCheer": false
  },
  "titleTemplates": {
    "main": "{branch}关于{cust}贷款利率优惠的申请{zlSuffix}",
    "zlSuffixWhenExempt": "（含自律加点豁免申请）"
  },
  "summaryTemplate": [
    "客户：{cust}",
    "金额：{amt}万元；期限：{tenor}",
    "执行利率：{rate}%",
    "较LPR：{bpLpr}BP；较FTP：{bpFtp}BP",
    "分行权限：{segMain}·{tenor} {thrRef}%"
  ],
  "presets": [
    { "label": "普惠标准", "seg": ["普惠小微"], "tenor": "1年", "prod": ["流动资金贷款"], "gb": "不动产抵押", "use": "日常经营周转" },
    { "label": "短期贴现", "seg": ["普惠小微"], "tenor": "6个月", "prod": ["票据贴现"], "use": "日常营运支出" },
    { "label": "科技/绿色标准", "seg": ["科技", "绿色"], "tenor": "1年", "prod": ["科技贷"], "use": "研发投入" },
    { "label": "国企/台商标准", "seg": ["台商"], "tenor": "1年" },
    { "label": "通用标准", "seg": ["一般客群"], "tenor": "1年" }
  ],
  "THRESH": {
    "6个月": { "国企/总战/台商": 2.28, "科技/绿色": 2.28, "普惠": 2.28, "非上述客群": 2.28 },
    "1年":   { "国企/总战/台商": 2.31, "科技/绿色": 2.50, "普惠": 2.60, "非上述客群": 2.70 },
    "2年":   { "国企/总战/台商": 2.44, "科技/绿色": 2.50, "普惠": 2.60, "非上述客群": 2.70 },
    "3年":   { "国企/总战/台商": 2.54, "科技/绿色": 2.64, "普惠": 2.54, "非上述客群": 2.70 },
    "4年":   { "国企/总战/台商": 2.63, "科技/绿色": 2.63, "普惠": 2.63, "非上述客群": 2.70 }
  },
  "SEG_TEXT": {
    "国企/总战/台商": [
      "股东背景稳健，治理结构完善，主要经营与财务指标稳定向好。",
      "与我行合作持续，账户交易正常，结算相关指标良好。"
    ],
    "科技/绿色": [
      "通过高新/专精特新/绿色等资质认定，技术与业务模式具备壁垒，符合政策导向。",
      "轻资产运营、回款节奏明确，融资需求与产销匹配，偿债来源清晰。"
    ],
    "普惠": [
      "纳入普惠小微口径管理，经营场景真实，主营收入稳定，税务与用工合规。",
      "回款路径清晰、走账规范，近两年无重大不良与失信记录。"
    ],
    "非上述客群": [
      "业务模式清晰、客户基础稳固，主要收入来源稳定，行业对标合理。",
      "资金收付路径明确，异常交易排查未见异常，合规经营。"
    ]
  },
  "segGroupMap": {
    "普惠小微": "普惠",
    "科技": "科技/绿色",
    "绿色": "科技/绿色",
    "台商": "国企/总战/台商",
    "一般客群": "非上述客群",
    "上市公司": "非上述客群"
  },
  "products": [
    "税易贷", "成长伴侣", "科技贷", "流动资金贷款", "项目贷款",
    "厦易贷", "增信基金", "园区授信", "银承", "供应链应收账款", "知识产权质押" 
  ],
  "purposes": [
    "采购备货","支付工资","日常经营周转","设备购置","研发投入","项目建设"
  ],
  "collateral": [
    "不动产抵押", "担保公司100%保证","知识产权质押","信用"
  ],
  "industryTemplates": {
    "通用": {
      "qual": "经营规范，资金收付路径清晰，主要经营指标稳定，具备可持续经营能力。",
      "risk": ["资金用途真实性与回款路径落实情况"],
      "measures": ["加强现金管理与收付管控，确保资金闭环可核。"]
    },
    "制造业": {
      "qual": "具备一定产能与订单基础，成本管控与供应链协同较完善。",
      "risk": ["原材料价格波动导致毛利率波动", "存货周转放缓"],
      "measures": ["以订单/合同为基础控制提款节奏，匹配生产周期。"]
    },
    "贸易流通": {
      "qual": "上下游渠道较稳定，存货与资金周转较快，贸易单证齐全。",
      "risk": ["存货跌价与积压风险", "贸易对手信用风险"],
      "measures": ["完善贸易单证流转与真实性核验，建立对账机制。"]
    }
  }
};

// --- Global Scope Helper Functions ---
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function toast(txt) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = txt;
    document.body.appendChild(t);
    requestAnimationFrame(() => t.classList.add('show'));
    setTimeout(() => {
        t.classList.remove('show');
        setTimeout(() => t.remove(), 260);
    }, 1400);
}

function rocket() {
    const r = document.createElement('div');
    r.className = 'rocket';
    r.textContent = '🚀';
    document.body.appendChild(r);
    setTimeout(() => r.remove(), 1600);
}

function stars(n) {
    const em = ['✨', '⭐️', '💫', '🌟', '🎉', '🍄'];
    for (let i = 0; i < n; i++) {
        const s = document.createElement('span');
        s.className = 'burst';
        s.textContent = em[i % em.length];
        s.style.left = (Math.random() * 100) + 'vw';
        s.style.animationDuration = (1 + Math.random() * 1.2) + 's';
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 1800);
    }
}

async function copyTarget(sel) {
    const txt = $(sel)?.textContent || '';
    if (!txt.trim()) {
        toast('请先生成内容');
        return;
    }
    try {
        await navigator.clipboard.writeText(txt);
    } catch (_) {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
    }
    toast('✔︎ 牛逼牛逼 · 已复制');
    rocket();
    stars(28);
}

// --- Core Application Logic ---

function build() {
    const branch = $('#branch').value.trim() || '厦门分行科技业务部';
    const cust = $('#cust').value.trim() || '厦门某某科技有限公司';
    const prods = $$('#prodChips .chip.sel').map(x => x.dataset.v);
    const segs = $$('#segChips .chip.sel').map(x => x.dataset.v);
    const gb = $('#gb').value;
    const use = $('#use').value;
    const stock = $('#stockChips .chip.sel')?.dataset.v || '否';
    const amt = parseFloat($('#amt').value) || 500;
    const tenor = $('#tenor').value;
    const rate = parseFloat($('#rate').value) || 2.60;
    const lpr = parseFloat($('#lpr').value) || 3.00;
    const ftp = parseFloat($('#ftp').value) || 1.90;
    const stockRate = parseFloat($('#stockRate').value);
    const eva = $('#eva').value.trim();
    const note = $('#note').value.trim();
    const industry = $('#industry')?.value || '通用';

    const dL = Math.round((rate - lpr) * 100);
    const dF = Math.round((rate - ftp) * 100);
    const J = judgeLayer(rate, tenor, segs);
    const segMain = PHRASES.segGroupMap[segs[0]] || '非上述客群';
    const thrRef = (PHRASES.THRESH[tenor] || {})[segMain];

    const title = generateTitle(branch, cust);
    const { part1, part2, part3, part4, part5, part6, part7 } = generateBodyParts({ J, thrRef, rate, lpr, ftp, dL, dF, amt, tenor, prods, gb, use, stock, stockRate, segs, industry, eva, note });
    const summary = generateSummary({ cust, amt, tenor, rate, dL, dF, segMain, thrRef });

    const fullText = [title, part1, part2, part3, part4, part5, part6, part7].join('\n\n');
    $('#out').textContent = fullText;
    $('#summaryOut').textContent = summary;
    updateUI(J, dL, dF, thrRef, segMain, tenor);
}

function generateTitle(branch, cust) {
    const TPL = PHRASES.titleTemplates || {};
    return TPL.main ? TPL.main.replace('{branch}', branch).replace('{cust}', cust).replace('{zlSuffix}', '') : `${branch}关于${cust}贷款利率优惠的申请`;
}

function generateSummary(data) {
    const _tpl = PHRASES.summaryTemplate || [];
    const map = {
        ...data,
        rate: data.rate.toFixed(2),
        bpLpr: (data.dL >= 0 ? '+' : '') + data.dL,
        bpFtp: (data.dF >= 0 ? '+' : '') + data.dF,
        thrRef: (typeof data.thrRef === 'number' ? data.thrRef.toFixed(2) : '')
    };
    return '- ' + _tpl.map(line => line.replace(/\{(\w+)\}/g, (_, k) => (map[k] ?? ''))).filter(Boolean).join('\n- ');
}

function generateBodyParts(data) {
    const { J, thrRef, rate, lpr, ftp, dL, dF, amt, tenor, prods, gb, use, stock, stockRate, segs, industry, eva, note } = data;
    const IT = PHRASES.industryTemplates[industry] || {};
    const segMain = PHRASES.segGroupMap[segs[0]] || '非上述客群';

    const apprRefLine = (typeof thrRef === 'number') ? `对应分行审批权限：${segMain}·${tenor} ${thrRef.toFixed(2)}%。` : '';
    const benchLine = `参考基准：一年期LPR ${lpr.toFixed(2)}%，FTP ${ftp.toFixed(2)}%。`;
    const rateLine = `利率对比：拟执行利率 ${rate.toFixed(2)}%；较一年期LPR（${lpr.toFixed(2)}%）${dL < 0 ? '下浮' : '上浮'}${Math.abs(dL)}BP；与FTP（${ftp.toFixed(2)}%）利差 ${dF >= 0 ? '+' : ''}${dF}BP。`;
    const part1 = ['一、贷款利率要素', `审批权限口径：${J.layer}`, apprRefLine, benchLine, rateLine].filter(Boolean).join('\n');

    const apply = `拟新增/调整授信${amt}万元，期限${tenor}，品种为${prods.join('、') || '流动资金贷款'}，担保方式为${gb}，用途为${use}，拟执行利率${rate.toFixed(2)}%。`;
    const stockExplain = (stock === '是' && !isNaN(stockRate)) ? `存量调整说明：存量执行利率 ${stockRate.toFixed(2)}%，拟调整至 ${rate.toFixed(2)}%，变动幅度 ${Math.abs(Math.round((rate - stockRate) * 100))}BP。` : '';
    const part2 = ['二、申请事项', apply, stockExplain].filter(Boolean).join('\n');

    const segLine = (segs.length ? segs : ['普惠小微']).flatMap(s => PHRASES.SEG_TEXT[PHRASES.segGroupMap[s]] || []).slice(0, 2).join(' ');
    const part3 = ['三、客户资质与经营情况', segLine, IT.qual].filter(Boolean).join('\n');

    const measures = (IT.measures || []).map((x, i) => `（${i + 1}）${x}`).join('\n');
    const part4 = `四、配套措施与协同安排\n${measures}`;

    const evaText = eva ? `经营中台测算：EVA ${Number(eva).toFixed(2)}。` : 'EVA 以中台口径为准。';
    const part5 = `五、收益测算与EVA\n${evaText}`;

    const costLine = (PHRASES.costByAppr && (PHRASES.costByAppr[segMain] || PHRASES.costByAppr['默认'])) || '资金成本经测算可控。';
    const part6 = `六、综合理由与建议\n${costLine}`;

    const fixedNote1 = '1. 已完成关联方查验，非我行关联方。';
    const fixedNote2 = '2. 本次不涉及豁免自律加点。\n请审阅批准。';
    const userNote = note ? `\n\n补充说明：\n${note}` : '';
    const part7 = `七、其他注意事项\n${fixedNote1}\n${fixedNote2}${userNote}`;

    return { part1, part2, part3, part4, part5, part6, part7 };
}

function updateUI(J, dL, dF, thrRef, segMain, tenor) {
    $('#log').textContent = '已实时更新';
    const badge = $('#apprBadge'), bt = $('#apprBadgeText');
    bt.textContent = J.layer;
    badge.className = 'pill'; 
    if (J.layer.startsWith('分行')) badge.classList.add('ok');
    else if (J.layer.startsWith('总行')) badge.classList.add('warn');
    else badge.classList.add('err');

    const hints = $('#smartHints');
    hints.innerHTML = '';
    const addHint = (text) => { const h = document.createElement('div'); h.className = 'hint'; h.textContent = text; hints.appendChild(h); };
    addHint(`审批判断：${J.msg}`);
    addHint(`利差(LPR)：${dL >= 0 ? '+' : ''}${dL}BP；利差(FTP)：${dF >= 0 ? '+' : ''}${dF}BP`);
    
    const rateHint = $('#rateHint');
    rateHint.textContent = (typeof thrRef === 'number') ? `建议：${thrRef.toFixed(2)}%（${tenor}·${segMain}）` : '建议：—';
}

function judgeLayer(rate, tenor, segs) {
    const segMain = PHRASES.segGroupMap[segs[0]] || '非上述客群';
    const thr = (PHRASES.THRESH[tenor] || {})[segMain];
    if (thr == null) return { layer: '分行审批权限', msg: '按制度口径核对。' };
    if (rate >= thr) return { layer: '分行审批权限', msg: '符合分行审批权限。' };
    const floor = 2.28; // Simplified floor
    if (rate >= floor) return { layer: '总行条线负责人审批', msg: '低于分行权限，提请总行条线负责人审批。' };
    return { layer: '超政策下限（不予受理）', msg: `低于当前制度下限（${floor.toFixed(2)}%），不在本批次权限范围。` };
}

// --- UI Interaction & Population ---

function setupEventListeners() {
    document.body.addEventListener('click', e => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (t.classList.contains('chip')) handleChipClick(t);
    });

    $$('input, select, textarea').forEach(el => {
        el.addEventListener('input', build);
    });

    $('#btnCopy').onclick = () => copyTarget('#out');
    $('#btnCopySummary').onclick = () => copyTarget('#summaryOut');
    $('#btnDocx').onclick = buildWord;
    $('#btnOcr').onclick = ocrClick;
    $('#applySuggest').onclick = applySuggestedRate;
    $('#btnCheer').onclick = () => $('#cheerModal').classList.add('show');
    $('#cheerClose').onclick = () => $('#cheerModal').classList.remove('show');
    $('#cheerModal').addEventListener('click', e => { if (e.target === $('#cheerModal')) $('#cheerModal').classList.remove('show'); });
}

function handleChipClick(t) {
    const parent = t.parentElement;
    const isMultiSelect = parent.id === 'segChips' || parent.id === 'prodChips';
    
    if (!isMultiSelect) { // Single-select logic for presets and stock
        if (t.classList.contains('sel')) return;
        parent.querySelectorAll('.chip.sel').forEach(c => c.classList.remove('sel'));
    }

    t.classList.toggle('sel');
    t.classList.add('jump');
    setTimeout(() => t.classList.remove('jump'), 320);

    if (parent.id === 'presetChips') {
        applyPreset(JSON.parse(t.dataset.preset));
    } else {
        if (parent.id === 'stockChips') {
            $('#stockRow').style.display = (t.dataset.v === '是') ? '' : 'none';
        }
        build();
    }
}

function applyPreset(p) {
    const { seg, tenor, prod, gb, use, stock, stockRate, rate } = p || {};
    
    updateChipSelection('segChips', seg, true);
    updateChipSelection('prodChips', prod, true);
    updateChipSelection('stockChips', stock || '否', false);

    $('#gb').value = gb || '不动产抵押';
    $('#use').value = use || '日常经营周转';
    $('#tenor').value = tenor || '1年';
    
    const segMain = PHRASES.segGroupMap[(Array.isArray(seg) ? seg[0] : seg) || '普惠小微'];
    const thr = (PHRASES.THRESH[$('#tenor').value] || {})[segMain || '普惠'];
    $('#rate').value = Number(rate ?? thr ?? 2.60).toFixed(2);

    $('#stockRow').style.display = stock === '是' ? '' : 'none';
    if (stock === '是' && stockRate) $('#stockRate').value = Number(stockRate).toFixed(2);

    build();
    toast('已应用场景预设');
    stars(8);
}

function applySuggestedRate() {
    const segs = $$('#segChips .chip.sel').map(x => x.dataset.v);
    const tenor = $('#tenor').value;
    const segMain = PHRASES.segGroupMap[segs[0]] || '非上述客群';
    const thr = (PHRASES.THRESH[tenor] || {})[segMain];
    if (typeof thr === 'number') {
        $('#rate').value = thr.toFixed(2);
        build();
        toast('已应用建议利率');
    } else {
        toast('暂无建议值，请手动填写');
    }
}

function populateUI(data) {
    const populateSelect = (id, list) => {
        const select = $(`#${id}`);
        select.innerHTML = '';
        list.forEach(item => { const o = document.createElement('option'); o.textContent = item; select.appendChild(o); });
    };

    populateSelect('industry', Object.keys(data.industryTemplates || {}));
    populateSelect('gb', data.collateral || []);
    populateSelect('use', data.purposes || []);

    buildChips('segChips', Object.keys(data.segGroupMap || {}), ['普惠小微'], true);
    buildChips('prodChips', data.products || [], ['流动资金贷款'], true);

    const presetContainer = $('#presetChips');
    presetContainer.innerHTML = '';
    (data.presets || []).forEach(p => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.dataset.preset = JSON.stringify(p);
        chip.textContent = p.label;
        presetContainer.appendChild(chip);
    });
}

function buildChips(containerId, items, selected, isMulti) {
    const container = $(`#${containerId}`);
    if (!container) return;
    container.innerHTML = '';
    items.forEach(item => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.dataset.v = item;
        chip.textContent = item;
        if (isMulti ? selected.includes(item) : selected === item) {
            chip.classList.add('sel');
        }
        container.appendChild(chip);
    });
}

function updateChipSelection(containerId, selection, isMulti) {
    $$(`#${containerId} .chip`).forEach(chip => {
        const value = chip.dataset.v;
        const shouldBeSelected = isMulti 
            ? Array.isArray(selection) && selection.includes(value)
            : selection === value;
        chip.classList.toggle('sel', shouldBeSelected);
    });
}

// --- OCR & DOCX Logic ---
let ocrLoaded = false;
async function ensureOCR() { if (ocrLoaded) return; await new Promise((res, rej) => { const s = document.createElement('script'); s.src = 'https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js'; s.onload = () => { ocrLoaded = true; res(); }; s.onerror = () => rej(new Error('OCR库加载失败')); document.head.appendChild(s); }); }
async function ocrClick() { const fs = $('#ocrImg').files; if (!fs || !fs.length) { alert('请选择包含 EVA 的截图'); return; } $('#ocrLog').textContent = '识别中…'; try { await ensureOCR(); const v = await runOCR(fs); if (v != null) { $('#eva').value = Number(v).toFixed(2); $('#ocrLog').textContent = '已识别：EVA=' + Number(v).toFixed(2); build(); } else { $('#ocrLog').textContent = '未识别到 EVA，可手填'; } } catch (e) { console.warn(e); $('#ocrLog').textContent = '识别失败（可手填）'; } }
async function runOCR(files) { let best = null; for (const f of files) { const url = URL.createObjectURL(f); try { const r = await Tesseract.recognize(url, 'chi_sim+eng'); const text = (r.data.text || '').replace(/\s+/g, ' '); const patterns = [/EVA（整笔业务）[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i, /EVA[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i, /ＥＶＡ[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i]; for (const re of patterns) { const m = text.match(re); if (m) { const val = parseFloat(m[1]); if (!isNaN(val)) { best = val; break; } } } } finally { URL.revokeObjectURL(url); } } return best; }

let docxLoaded = false;
async function ensureDocx() { 
    if (docxLoaded) return; 
    const candidates = [
        'https://unpkg.com/docx@8.5.0/build/index.js',
        'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js',
        './docx.min.js'
    ]; 
    for (const c of candidates) { 
        try { 
            await new Promise((res, rej) => { 
                const s = document.createElement('script'); 
                s.src = c; 
                s.onload = () => { 
                    docxLoaded = true; 
                    res(); 
                }; 
                s.onerror = rej; 
                document.head.appendChild(s); 
            }); 
            if (window.docx) return; 
        } catch (_) { 
            console.warn(`Failed to load docx from ${c}`);
        } 
    } 
    throw new Error('未能加载 docx 库'); 
}

async function buildWord() {
    const txt = $('#out').textContent || '';
    if (!txt.trim()) { toast('请先生成内容'); return; }
    toast('⏳ 正在生成Word文档…');
    rocket();
    try {
        await ensureDocx();
        
        // 检查docx库是否正确加载
        if (!window.docx || !window.docx.Document) {
            throw new Error('docx库未正确加载');
        }
        
        const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, ImageRun, PageBreak } = window.docx;

        const p = (text) => new Paragraph({ 
            children: [new TextRun({ 
                text: text || '', 
                font: '仿宋_GB2312', 
                size: 24 
            })], 
            spacing: { after: 160 } 
        });
        const h1 = (text) => new Paragraph({ 
            text: text || '', 
            heading: HeadingLevel.HEADING_1, 
            alignment: AlignmentType.CENTER, 
            spacing: { after: 240 } 
        });
        const h2 = (text) => new Paragraph({ 
            text: text || '', 
            heading: HeadingLevel.HEADING_2, 
            spacing: { after: 120 } 
        });

        const summary = $('#summaryOut').textContent || '';
        const titleLine = (txt.split('\n')[0] || '').trim();
        const bodyText = txt.substring(titleLine.length).trim();

        const docChildren = [];
        if (titleLine) docChildren.push(h1(titleLine));
        
        docChildren.push(h2('OA 摘要'));
        summary.split(/\n/).forEach(line => {
            if (line.trim()) docChildren.push(p(line));
        });
        
        docChildren.push(new Paragraph({ children: [new PageBreak()] }));
        
        docChildren.push(h2('正文'));
        bodyText.split(/\n/).forEach(line => {
            if (line.trim()) {
                if (/^[一二三四五六七八九十]+、/.test(line.trim())) {
                    docChildren.push(h2(line));
                } else {
                    docChildren.push(p(line));
                }
            }
        });

        const imgs = Array.from($('#ocrImg').files || []);
        if (imgs.length > 0) {
            docChildren.push(h2('附件：EVA截图'));
            for (let i = 0; i < imgs.length; i++) {
                const file = imgs[i];
                try {
                    const buffer = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = e => reject(e.target.error);
                        reader.readAsArrayBuffer(file);
                    });
                    docChildren.push(p(`截图 ${i + 1}`), new Paragraph({ 
                        children: [new ImageRun({ 
                            data: buffer, 
                            transformation: { width: 540, height: 405 } 
                        })] 
                    }));
                } catch (imgError) {
                    console.warn(`Failed to process image ${i + 1}:`, imgError);
                    docChildren.push(p(`截图 ${i + 1} (处理失败)`));
                }
            }
        }

        const doc = new Document({ sections: [{ children: docChildren }] });
        const blob = await Packer.toBlob(doc);
        const ds = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        downloadBlob(`利率优惠签报_${ds}.docx`, blob);
        toast('✔︎ 美丽美丽 · 已生成 Word');
        stars(18);
    } catch (e) {
        console.error('Word generation error:', e);
        toast(`生成Word失败: ${e.message}`);
    }
}

function downloadBlob(name, blob) { const a = document.createElement('a'); const url = URL.createObjectURL(blob); a.href = url; a.download = name; document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1200); }

// --- Initial Load ---
function main() {
    setupEventListeners();
    populateUI(PHRASES);
    build();
}

main();

</script>
</body>
</html>
