<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>åˆ©ç‡ä¼˜æƒ ç­¾æŠ¥ Â· æ™ºèƒ½ç”Ÿæˆå™¨</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
:root{
  --ink:#0b1220; --muted:#667085; --line:#e6e9ef;
  --mario-red:#e11d48; --sky:#38bdf8; --coin:#f59e0b; --green:#10b981;
  --paper:rgba(255,255,255,.9); --radius:18px;
  --shadow:0 14px 34px rgba(2,6,23,.12), 0 2px 8px rgba(2,6,23,.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;color:var(--ink);
  font:15.5px/1.6 -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Hiragino Sans GB",Segoe UI,Roboto,Helvetica,Arial}
.bg{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg,#e0f2fe 0%, #f0f9ff 40%, #fff 100%)}
.bg::before{content:"";position:absolute;inset:-8% -8%;background-size:cover;background-position:center;filter:blur(16px) opacity(.25)}
.wrap{max-width:1080px;margin:0 auto;padding:22px 16px 120px}
header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.logo{width:42px;height:42px;border-radius:12px;background:
  radial-gradient(40% 40% at 30% 30%,#fff,transparent 70%),
  conic-gradient(from 200deg,var(--mario-red),#ef4444 30%,#fb7185 60%,var(--mario-red));
  box-shadow:0 10px 26px rgba(225,29,72,.28),0 2px 8px rgba(16,24,40,.08)}
h1{margin:0;font-weight:800;font-size:clamp(20px,2.6vw,28px);letter-spacing:.2px}
.sub{color:var(--muted);font-size:13px;margin-top:2px}

.card{background:var(--paper);backdrop-filter:saturate(150%) blur(10px);
  border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow); margin-bottom: 14px;}
.grid2{display:grid;grid-template-columns:1.08fr .92fr;gap:14px}
.row{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:center;margin:10px 0}
label{color:#475569; font-weight: 600;}
input[type=text],input[type=number],select,textarea{
  width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;color:var(--ink);
  padding:10px 12px;outline:none;transition:border .15s,box-shadow .15s}
input:focus,select:focus,textarea:focus{border-color:#bae6fd;box-shadow:0 0 0 5px rgba(56,189,248,.18)}
textarea{min-height:80px}

.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{border:2px solid #e2e8f0;border-radius:14px;padding:8px 14px;background:linear-gradient(180deg,#fff,#f8fafc);
  color:#0b1220;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
.chip:hover{transform:translateY(-1px)}
.chip.sel{background:linear-gradient(180deg,#fef3c7,#fde68a); border-color:#f59e0b; box-shadow:0 6px 14px rgba(245,158,11,.25)}

.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
.pill.ok{background:linear-gradient(180deg,#ecfeff,#dbeafe);border-color:#bfdbfe;color:#1e3a8a}
.pill.warn{background:linear-gradient(180deg,#fff7ed,#ffedd5);border-color:#fed7aa;color:#7c2d12}
.pill.err{background:linear-gradient(180deg,#fef2f2,#fee2e2);border-color:#fecaca;color:#7f1d1d}
.btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;border:none;border-radius:14px;padding:12px 16px;color:#fff;
  background:linear-gradient(90deg,var(--mario-red) 0%, var(--coin) 100%);box-shadow:0 10px 24px rgba(225,29,72,.28);cursor:pointer;font-weight:800;letter-spacing:.2px}
.btn:active{transform:translateY(1px)}
.btn.sky{background:linear-gradient(90deg,#0ea5e9, #22d3ee)}
.btn.ghost{background:#f3f5fb;color:#1f2a44;border:1px solid var(--line);box-shadow:none}
.btn.badge{font-size:13px;padding:8px 12px;border-radius:12px}
.dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:rgba(255,255,255,.86);
  backdrop-filter:saturate(150%) blur(10px);border-top:1px solid var(--line)}
.dock-inner{max-width:1080px;margin:0 auto;padding:12px 16px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
.log{margin-left:auto;color:var(--muted);font-size:12.5px}
#out{white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:12px;border-radius:12px;min-height:160px}
.hints{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.hint{font-size:12px;color:#475569;padding:6px 10px;border:1px dashed #e2e8f0;border-radius:10px;background:#fff}
.subtle{font-size:12px;color:#64748b}
.titlebar{display:flex;align-items:center;gap:8px}
.titlebar .coin{filter:drop-shadow(0 6px 10px rgba(245,158,11,.35))}

@keyframes jump { 0%{transform:translateY(0)} 40%{transform:translateY(-8px)} 100%{transform:translateY(0)} }
.jump{animation:jump .28s ease-out}
.rocket{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);font-size:26px;animation:fly 1.5s ease-out forwards;z-index:50}
@keyframes fly{0%{transform:translate(-50%,0) scale(1);opacity:1}100%{transform:translate(-50%,-82vh) scale(1.2);opacity:0}}
.burst{position:fixed;bottom:0;font-size:22px;animation:fall 1.6s ease-out forwards;z-index:45}
@keyframes fall{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-80vh) scale(1.3);opacity:0}}
.toast{position:fixed;left:50%;bottom:88px;transform:translateX(-50%) scale(.96);opacity:0;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:60}
.toast.show{opacity:1;transform:translateX(-50%) scale(1);transition:all .18s ease}

.brick{height:10px;background:repeating-linear-gradient(90deg,#f59e0b 0 12px,#d97706 12px 24px);opacity:.2;border-radius:10px;margin:6px 0}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:80}
.modal .panel{background:#fff;border-radius:16px;max-width:460px;width:calc(100% - 40px);padding:18px;box-shadow:var(--shadow);position:relative}
.modal .panel .close{position:absolute;right:12px;top:10px;cursor:pointer;color:#64748b;font-size:18px;font-weight:bold;z-index:1}
.modal.show{display:flex}

@media (max-width:860px){
  .grid2{grid-template-columns:1fr}
  .row{grid-template-columns:1fr}
  .btn{padding:12px 14px}
  #out{min-height:220px}
}
</style>
</head>
<body>
<div class="bg" id="bg"></div>

<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <div class="titlebar">
        <h1>åˆ©ç‡ä¼˜æƒ ç­¾æŠ¥ Â· æ™ºèƒ½ç”Ÿæˆå™¨</h1>
        <span id="apprBadge" class="pill ok" title="ç³»ç»ŸæŒ‰é˜ˆå€¼è‡ªåŠ¨åˆ¤æ–­">
          <span>å®¡æ‰¹å£å¾„</span>
          <span id="apprBadgeText">åˆ†è¡Œå®¡æ‰¹æƒé™</span>
        </span>
        <span class="coin" aria-hidden="true">ğŸª™</span>
      </div>
    </div>
  </header>

  <div class="grid2">
    <div class="card">
      <div class="row"><label>åˆ†è¡Œï¼ˆç”¨äºæ ‡é¢˜ï¼‰</label><input id="branch" type="text" value="å¦é—¨åˆ†è¡Œç§‘æŠ€ä¸šåŠ¡éƒ¨" placeholder="å¦‚ï¼šå¦é—¨åˆ†è¡Œç§‘æŠ€ä¸šåŠ¡éƒ¨"></div>
      <div class="row"><label>å®¢æˆ·åç§°</label><input id="cust" type="text" placeholder="å¦‚ï¼šå¦é—¨æŸæŸç§‘æŠ€æœ‰é™å…¬å¸"></div>
      <div class="row"><label>åœºæ™¯é¢„è®¾</label>
        <div class="chips" id="presetChips"></div>
      </div>
      <div class="row"><label>è¡Œä¸šç±»å‹</label>
        <select id="industry"></select>
      </div>
      <div class="row"><label>å®¢ç¾¤ (å¤šé€‰)</label>
        <div class="chips" id="segChips"></div>
      </div>
      <div class="row"><label>æˆä¿¡å“ç§ (å¤šé€‰)</label>
        <div class="chips" id="prodChips"></div>
      </div>
      <div class="row"><label>æ‹…ä¿æ–¹å¼</label>
        <select id="gb"></select>
      </div>
      <div class="row"><label>è´·æ¬¾ç”¨é€”</label>
        <select id="use"></select>
      </div>
    </div>

    <div class="card">
      <div class="row"><label>é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label><input id="amt" type="number" placeholder="å¦‚ï¼š500" value="500"></div>
      <div class="row"><label>æœŸé™</label>
        <select id="tenor">
          <option>1å¹´</option><option>6ä¸ªæœˆ</option><option>2å¹´</option><option>3å¹´</option><option>4å¹´</option>
        </select>
      </div>
      <div class="row"><label>æ‰§è¡Œåˆ©ç‡(%)</label>
        <div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="rate" type="number" step="0.01" value="2.60" style="width:180px">
            <span class="hint" id="rateHint">å»ºè®®ï¼šâ€”</span>
            <button class="btn badge sky" id="applySuggest" type="button">åº”ç”¨å»ºè®®</button>
          </div>
        </div>
      </div>
      <div class="row"><label>LPR(ä¸€å¹´æœŸ%)</label><input id="lpr" type="number" step="0.01" value="3.00"></div>
      <div class="row"><label>FTP(%)</label><input id="ftp" type="number" step="0.01" value="1.90"></div>
      <div class="row"><label>æ˜¯å¦å­˜é‡ (å•é€‰)</label>
        <div class="chips" id="stockChips">
            <span class="chip sel" data-v="å¦">å¦</span>
            <span class="chip" data-v="æ˜¯">æ˜¯</span>
        </div>
      </div>
      <div class="row" id="stockRow" style="display:none">
        <label>å­˜é‡åˆ©ç‡(%)</label><input id="stockRate" type="number" step="0.01" placeholder="å¦‚ï¼š3.20">
      </div>
      <div class="row"><label>EVAï¼ˆå¯æ‰‹å¡«ï¼‰</label><input id="eva" type="text" placeholder="å¦‚ï¼š13.93"></div>
      <div class="row"><label>OCR è¯†åˆ« EVA</label>
        <div>
          <input id="ocrImg" type="file" accept="image/*" multiple />
          <div class="small" id="ocrLog">ï¼ˆå¯é€‰ï¼›è¯†åˆ«å¤±è´¥ä¸å½±å“ï¼‰</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items: flex-start;"><label>è¡¥å……è¯´æ˜ (å¯é€‰)</label>
      <textarea id="note" placeholder="å¦‚æœ‰å…¶ä»–éœ€è¦è¯´æ˜çš„äº‹é¡¹ï¼Œè¯·åœ¨æ­¤å¤„å¡«å†™..."></textarea>
    </div>
  </div>

  <div class="card">
    <div class="row" style="grid-template-columns:1fr"><label style="grid-column:1/-1">é¢„è§ˆ</label>
      <div class="hints" id="smartHints"></div>
      <div class="titlebar" style="justify-content:space-between;margin:6px 0 6px 0">
        <div style="font-weight:700">æ­£æ–‡ï¼ˆå®Œæ•´ï¼‰</div>
      </div>
      <div id="out"></div>
      <div class="brick"></div>
      <div class="titlebar" style="justify-content:space-between;margin:10px 0 6px 0">
        <div style="font-weight:700">OA æ‘˜è¦ï¼ˆåŸºç¡€è¦ç‚¹ï¼‰</div>
      </div>
      <div id="summaryOut" style="white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:12px;border-radius:12px;min-height:120px"></div>
      <div class="subtle">æç¤ºï¼šæ­£æ–‡ç”¨äºé™„ä»¶æˆ–å®Œæ•´ç­¾æŠ¥ï¼›æ‘˜è¦é€‚é… OA å­—æ®µã€‚</div>
    </div>
  </div>
</div>

<div class="dock">
  <div class="dock-inner">
    <button class="btn" id="btnCopy">å¤åˆ¶æ­£æ–‡<span class="jump">ğŸ„</span></button>
    <button class="btn" id="btnCopySummary">å¤åˆ¶æ‘˜è¦</button>
    <button class="btn sky" id="btnOcr">è¯†åˆ«EVA</button>
    <button class="btn ghost" id="btnDocx">ç”Ÿæˆ Wordï¼ˆå«å›¾ç‰‡ï¼‰</button>
    <button class="btn ghost" id="btnCheer">æˆ‘çˆ±XD.Hu</button>
    <span class="log" id="log">å°±ç»ª</span>
  </div>
</div>

<div id="cheerModal" class="modal">
  <div class="panel" style="position:relative">
    <span class="close" id="cheerClose" title="å…³é—­">âœ–</span>
    <h3 style="margin:0 0 8px 0">æˆ‘çˆ±XD.Hu</h3>
    <p class="small">ä½ å°±è¯´æ£’ä¸æ£’ï½ï¼å†…å®¹è®°å¾—æ ¸å¯¹å“¦ï¼Œæˆ‘å¸Œæœ›ä½ æˆ‘éƒ½å¯ä»¥æ›´å¿«ã€æ›´å‡†ã€æ›´åˆè§„åœ°å®Œæˆæ—¥å¸¸å·¥ä½œã€‚</p>
    <p class="small">ç‹ ç‹ ç»™æˆ‘å¤¸ï¼æ¬¢è¿è”ç³»ï¼š<b>coolkiy@gmail.com</b></p>
    <p class="small">æ„Ÿè°¢æ”¯æŒï¼Œæ„Ÿè°¢å¤¸å¥–ï¼Œåˆ«ç»™å»ºè®®ï½æ”¹ä¸è¿‡æ¥ï½æˆ‘ä¼šä¼˜åŒ–ï½æŒç»­ä¼˜åŒ–ï½ä¹ˆä¹ˆå“’ï½</p>
  </div>
</div>

<script>
'use strict';

// --- Embedded Data Store ---
const PHRASES = {
  "uiDefaults": {
    "branch": "å¦é—¨åˆ†è¡Œ",
    "dept": "ç§‘æŠ€ä¸šåŠ¡éƒ¨",
    "email": "coolkiy@gmail.com",
    "showCheer": false
  },
  "titleTemplates": {
    "main": "{branch}å…³äº{cust}è´·æ¬¾åˆ©ç‡ä¼˜æƒ çš„ç”³è¯·{zlSuffix}",
    "zlSuffixWhenExempt": "ï¼ˆå«è‡ªå¾‹åŠ ç‚¹è±å…ç”³è¯·ï¼‰"
  },
  "summaryTemplate": [
    "å®¢æˆ·ï¼š{cust}",
    "é‡‘é¢ï¼š{amt}ä¸‡å…ƒï¼›æœŸé™ï¼š{tenor}",
    "æ‰§è¡Œåˆ©ç‡ï¼š{rate}%",
    "è¾ƒLPRï¼š{bpLpr}BPï¼›è¾ƒFTPï¼š{bpFtp}BP",
    "åˆ†è¡Œæƒé™ï¼š{segMain}Â·{tenor} {thrRef}%"
  ],
  "presets": [
    { "label": "æ™®æƒ æ ‡å‡†", "seg": ["æ™®æƒ å°å¾®"], "tenor": "1å¹´", "prod": ["æµåŠ¨èµ„é‡‘è´·æ¬¾"], "gb": "ä¸åŠ¨äº§æŠµæŠ¼", "use": "æ—¥å¸¸ç»è¥å‘¨è½¬" },
    { "label": "çŸ­æœŸè´´ç°", "seg": ["æ™®æƒ å°å¾®"], "tenor": "6ä¸ªæœˆ", "prod": ["ç¥¨æ®è´´ç°"], "use": "æ—¥å¸¸è¥è¿æ”¯å‡º" },
    { "label": "ç§‘æŠ€/ç»¿è‰²æ ‡å‡†", "seg": ["ç§‘æŠ€", "ç»¿è‰²"], "tenor": "1å¹´", "prod": ["ç§‘æŠ€è´·"], "use": "ç ”å‘æŠ•å…¥" },
    { "label": "å›½ä¼/å°å•†æ ‡å‡†", "seg": ["å°å•†"], "tenor": "1å¹´" },
    { "label": "é€šç”¨æ ‡å‡†", "seg": ["ä¸€èˆ¬å®¢ç¾¤"], "tenor": "1å¹´" }
  ],
  "THRESH": {
    "6ä¸ªæœˆ": { "å›½ä¼/æ€»æˆ˜/å°å•†": 2.28, "ç§‘æŠ€/ç»¿è‰²": 2.28, "æ™®æƒ ": 2.28, "éä¸Šè¿°å®¢ç¾¤": 2.28 },
    "1å¹´":   { "å›½ä¼/æ€»æˆ˜/å°å•†": 2.31, "ç§‘æŠ€/ç»¿è‰²": 2.50, "æ™®æƒ ": 2.60, "éä¸Šè¿°å®¢ç¾¤": 2.70 },
    "2å¹´":   { "å›½ä¼/æ€»æˆ˜/å°å•†": 2.44, "ç§‘æŠ€/ç»¿è‰²": 2.50, "æ™®æƒ ": 2.60, "éä¸Šè¿°å®¢ç¾¤": 2.70 },
    "3å¹´":   { "å›½ä¼/æ€»æˆ˜/å°å•†": 2.54, "ç§‘æŠ€/ç»¿è‰²": 2.64, "æ™®æƒ ": 2.54, "éä¸Šè¿°å®¢ç¾¤": 2.70 },
    "4å¹´":   { "å›½ä¼/æ€»æˆ˜/å°å•†": 2.63, "ç§‘æŠ€/ç»¿è‰²": 2.63, "æ™®æƒ ": 2.63, "éä¸Šè¿°å®¢ç¾¤": 2.70 }
  },
  "SEG_TEXT": {
    "å›½ä¼/æ€»æˆ˜/å°å•†": [
      "è‚¡ä¸œèƒŒæ™¯ç¨³å¥ï¼Œæ²»ç†ç»“æ„å®Œå–„ï¼Œä¸»è¦ç»è¥ä¸è´¢åŠ¡æŒ‡æ ‡ç¨³å®šå‘å¥½ã€‚",
      "ä¸æˆ‘è¡Œåˆä½œæŒç»­ï¼Œè´¦æˆ·äº¤æ˜“æ­£å¸¸ï¼Œç»“ç®—ç›¸å…³æŒ‡æ ‡è‰¯å¥½ã€‚"
    ],
    "ç§‘æŠ€/ç»¿è‰²": [
      "é€šè¿‡é«˜æ–°/ä¸“ç²¾ç‰¹æ–°/ç»¿è‰²ç­‰èµ„è´¨è®¤å®šï¼ŒæŠ€æœ¯ä¸ä¸šåŠ¡æ¨¡å¼å…·å¤‡å£å’ï¼Œç¬¦åˆæ”¿ç­–å¯¼å‘ã€‚",
      "è½»èµ„äº§è¿è¥ã€å›æ¬¾èŠ‚å¥æ˜ç¡®ï¼Œèèµ„éœ€æ±‚ä¸äº§é”€åŒ¹é…ï¼Œå¿å€ºæ¥æºæ¸…æ™°ã€‚"
    ],
    "æ™®æƒ ": [
      "çº³å…¥æ™®æƒ å°å¾®å£å¾„ç®¡ç†ï¼Œç»è¥åœºæ™¯çœŸå®ï¼Œä¸»è¥æ”¶å…¥ç¨³å®šï¼Œç¨åŠ¡ä¸ç”¨å·¥åˆè§„ã€‚",
      "å›æ¬¾è·¯å¾„æ¸…æ™°ã€èµ°è´¦è§„èŒƒï¼Œè¿‘ä¸¤å¹´æ— é‡å¤§ä¸è‰¯ä¸å¤±ä¿¡è®°å½•ã€‚"
    ],
    "éä¸Šè¿°å®¢ç¾¤": [
      "ä¸šåŠ¡æ¨¡å¼æ¸…æ™°ã€å®¢æˆ·åŸºç¡€ç¨³å›ºï¼Œä¸»è¦æ”¶å…¥æ¥æºç¨³å®šï¼Œè¡Œä¸šå¯¹æ ‡åˆç†ã€‚",
      "èµ„é‡‘æ”¶ä»˜è·¯å¾„æ˜ç¡®ï¼Œå¼‚å¸¸äº¤æ˜“æ’æŸ¥æœªè§å¼‚å¸¸ï¼Œåˆè§„ç»è¥ã€‚"
    ]
  },
  "segGroupMap": {
    "æ™®æƒ å°å¾®": "æ™®æƒ ",
    "ç§‘æŠ€": "ç§‘æŠ€/ç»¿è‰²",
    "ç»¿è‰²": "ç§‘æŠ€/ç»¿è‰²",
    "å°å•†": "å›½ä¼/æ€»æˆ˜/å°å•†",
    "ä¸€èˆ¬å®¢ç¾¤": "éä¸Šè¿°å®¢ç¾¤",
    "ä¸Šå¸‚å…¬å¸": "éä¸Šè¿°å®¢ç¾¤"
  },
  "products": [
    "ç¨æ˜“è´·", "æˆé•¿ä¼´ä¾£", "ç§‘æŠ€è´·", "æµåŠ¨èµ„é‡‘è´·æ¬¾", "é¡¹ç›®è´·æ¬¾",
    "å¦æ˜“è´·", "å¢ä¿¡åŸºé‡‘", "å›­åŒºæˆä¿¡", "é“¶æ‰¿", "ä¾›åº”é“¾åº”æ”¶è´¦æ¬¾", "çŸ¥è¯†äº§æƒè´¨æŠ¼" 
  ],
  "purposes": [
    "é‡‡è´­å¤‡è´§","æ”¯ä»˜å·¥èµ„","æ—¥å¸¸ç»è¥å‘¨è½¬","è®¾å¤‡è´­ç½®","ç ”å‘æŠ•å…¥","é¡¹ç›®å»ºè®¾"
  ],
  "collateral": [
    "ä¸åŠ¨äº§æŠµæŠ¼", "æ‹…ä¿å…¬å¸100%ä¿è¯","çŸ¥è¯†äº§æƒè´¨æŠ¼","ä¿¡ç”¨"
  ],
  "industryTemplates": {
    "é€šç”¨": {
      "qual": "ç»è¥è§„èŒƒï¼Œèµ„é‡‘æ”¶ä»˜è·¯å¾„æ¸…æ™°ï¼Œä¸»è¦ç»è¥æŒ‡æ ‡ç¨³å®šï¼Œå…·å¤‡å¯æŒç»­ç»è¥èƒ½åŠ›ã€‚",
      "risk": ["èµ„é‡‘ç”¨é€”çœŸå®æ€§ä¸å›æ¬¾è·¯å¾„è½å®æƒ…å†µ"],
      "measures": ["åŠ å¼ºç°é‡‘ç®¡ç†ä¸æ”¶ä»˜ç®¡æ§ï¼Œç¡®ä¿èµ„é‡‘é—­ç¯å¯æ ¸ã€‚"]
    },
    "åˆ¶é€ ä¸š": {
      "qual": "å…·å¤‡ä¸€å®šäº§èƒ½ä¸è®¢å•åŸºç¡€ï¼Œæˆæœ¬ç®¡æ§ä¸ä¾›åº”é“¾ååŒè¾ƒå®Œå–„ã€‚",
      "risk": ["åŸææ–™ä»·æ ¼æ³¢åŠ¨å¯¼è‡´æ¯›åˆ©ç‡æ³¢åŠ¨", "å­˜è´§å‘¨è½¬æ”¾ç¼“"],
      "measures": ["ä»¥è®¢å•/åˆåŒä¸ºåŸºç¡€æ§åˆ¶ææ¬¾èŠ‚å¥ï¼ŒåŒ¹é…ç”Ÿäº§å‘¨æœŸã€‚"]
    },
    "è´¸æ˜“æµé€š": {
      "qual": "ä¸Šä¸‹æ¸¸æ¸ é“è¾ƒç¨³å®šï¼Œå­˜è´§ä¸èµ„é‡‘å‘¨è½¬è¾ƒå¿«ï¼Œè´¸æ˜“å•è¯é½å…¨ã€‚",
      "risk": ["å­˜è´§è·Œä»·ä¸ç§¯å‹é£é™©", "è´¸æ˜“å¯¹æ‰‹ä¿¡ç”¨é£é™©"],
      "measures": ["å®Œå–„è´¸æ˜“å•è¯æµè½¬ä¸çœŸå®æ€§æ ¸éªŒï¼Œå»ºç«‹å¯¹è´¦æœºåˆ¶ã€‚"]
    }
  }
};

// --- Global Scope Helper Functions ---
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function toast(txt) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = txt;
    document.body.appendChild(t);
    requestAnimationFrame(() => t.classList.add('show'));
    setTimeout(() => {
        t.classList.remove('show');
        setTimeout(() => t.remove(), 260);
    }, 1400);
}

function rocket() {
    const r = document.createElement('div');
    r.className = 'rocket';
    r.textContent = 'ğŸš€';
    document.body.appendChild(r);
    setTimeout(() => r.remove(), 1600);
}

function stars(n) {
    const em = ['âœ¨', 'â­ï¸', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ‰', 'ğŸ„'];
    for (let i = 0; i < n; i++) {
        const s = document.createElement('span');
        s.className = 'burst';
        s.textContent = em[i % em.length];
        s.style.left = (Math.random() * 100) + 'vw';
        s.style.animationDuration = (1 + Math.random() * 1.2) + 's';
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 1800);
    }
}

async function copyTarget(sel) {
    const txt = $(sel)?.textContent || '';
    if (!txt.trim()) {
        toast('è¯·å…ˆç”Ÿæˆå†…å®¹');
        return;
    }
    try {
        await navigator.clipboard.writeText(txt);
    } catch (_) {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
    }
    toast('âœ”ï¸ ç‰›é€¼ç‰›é€¼ Â· å·²å¤åˆ¶');
    rocket();
    stars(28);
}

// --- Core Application Logic ---

function build() {
    const branch = $('#branch').value.trim() || 'å¦é—¨åˆ†è¡Œç§‘æŠ€ä¸šåŠ¡éƒ¨';
    const cust = $('#cust').value.trim() || 'å¦é—¨æŸæŸç§‘æŠ€æœ‰é™å…¬å¸';
    const prods = $$('#prodChips .chip.sel').map(x => x.dataset.v);
    const segs = $$('#segChips .chip.sel').map(x => x.dataset.v);
    const gb = $('#gb').value;
    const use = $('#use').value;
    const stock = $('#stockChips .chip.sel')?.dataset.v || 'å¦';
    const amt = parseFloat($('#amt').value) || 500;
    const tenor = $('#tenor').value;
    const rate = parseFloat($('#rate').value) || 2.60;
    const lpr = parseFloat($('#lpr').value) || 3.00;
    const ftp = parseFloat($('#ftp').value) || 1.90;
    const stockRate = parseFloat($('#stockRate').value);
    const eva = $('#eva').value.trim();
    const note = $('#note').value.trim();
    const industry = $('#industry')?.value || 'é€šç”¨';

    const dL = Math.round((rate - lpr) * 100);
    const dF = Math.round((rate - ftp) * 100);
    const J = judgeLayer(rate, tenor, segs);
    const segMain = PHRASES.segGroupMap[segs[0]] || 'éä¸Šè¿°å®¢ç¾¤';
    const thrRef = (PHRASES.THRESH[tenor] || {})[segMain];

    const title = generateTitle(branch, cust);
    const { part1, part2, part3, part4, part5, part6, part7 } = generateBodyParts({ J, thrRef, rate, lpr, ftp, dL, dF, amt, tenor, prods, gb, use, stock, stockRate, segs, industry, eva, note });
    const summary = generateSummary({ cust, amt, tenor, rate, dL, dF, segMain, thrRef });

    const fullText = [title, part1, part2, part3, part4, part5, part6, part7].join('\n\n');
    $('#out').textContent = fullText;
    $('#summaryOut').textContent = summary;
    updateUI(J, dL, dF, thrRef, segMain, tenor);
}

function generateTitle(branch, cust) {
    const TPL = PHRASES.titleTemplates || {};
    return TPL.main ? TPL.main.replace('{branch}', branch).replace('{cust}', cust).replace('{zlSuffix}', '') : `${branch}å…³äº${cust}è´·æ¬¾åˆ©ç‡ä¼˜æƒ çš„ç”³è¯·`;
}

function generateSummary(data) {
    const _tpl = PHRASES.summaryTemplate || [];
    const map = {
        ...data,
        rate: data.rate.toFixed(2),
        bpLpr: (data.dL >= 0 ? '+' : '') + data.dL,
        bpFtp: (data.dF >= 0 ? '+' : '') + data.dF,
        thrRef: (typeof data.thrRef === 'number' ? data.thrRef.toFixed(2) : '')
    };
    return '- ' + _tpl.map(line => line.replace(/\{(\w+)\}/g, (_, k) => (map[k] ?? ''))).filter(Boolean).join('\n- ');
}

function generateBodyParts(data) {
    const { J, thrRef, rate, lpr, ftp, dL, dF, amt, tenor, prods, gb, use, stock, stockRate, segs, industry, eva, note } = data;
    const IT = PHRASES.industryTemplates[industry] || {};
    const segMain = PHRASES.segGroupMap[segs[0]] || 'éä¸Šè¿°å®¢ç¾¤';

    const apprRefLine = (typeof thrRef === 'number') ? `å¯¹åº”åˆ†è¡Œå®¡æ‰¹æƒé™ï¼š${segMain}Â·${tenor} ${thrRef.toFixed(2)}%ã€‚` : '';
    const benchLine = `å‚è€ƒåŸºå‡†ï¼šä¸€å¹´æœŸLPR ${lpr.toFixed(2)}%ï¼ŒFTP ${ftp.toFixed(2)}%ã€‚`;
    const rateLine = `åˆ©ç‡å¯¹æ¯”ï¼šæ‹Ÿæ‰§è¡Œåˆ©ç‡ ${rate.toFixed(2)}%ï¼›è¾ƒä¸€å¹´æœŸLPRï¼ˆ${lpr.toFixed(2)}%ï¼‰${dL < 0 ? 'ä¸‹æµ®' : 'ä¸Šæµ®'}${Math.abs(dL)}BPï¼›ä¸FTPï¼ˆ${ftp.toFixed(2)}%ï¼‰åˆ©å·® ${dF >= 0 ? '+' : ''}${dF}BPã€‚`;
    const part1 = ['ä¸€ã€è´·æ¬¾åˆ©ç‡è¦ç´ ', `å®¡æ‰¹æƒé™å£å¾„ï¼š${J.layer}`, apprRefLine, benchLine, rateLine].filter(Boolean).join('\n');

    const apply = `æ‹Ÿæ–°å¢/è°ƒæ•´æˆä¿¡${amt}ä¸‡å…ƒï¼ŒæœŸé™${tenor}ï¼Œå“ç§ä¸º${prods.join('ã€') || 'æµåŠ¨èµ„é‡‘è´·æ¬¾'}ï¼Œæ‹…ä¿æ–¹å¼ä¸º${gb}ï¼Œç”¨é€”ä¸º${use}ï¼Œæ‹Ÿæ‰§è¡Œåˆ©ç‡${rate.toFixed(2)}%ã€‚`;
    const stockExplain = (stock === 'æ˜¯' && !isNaN(stockRate)) ? `å­˜é‡è°ƒæ•´è¯´æ˜ï¼šå­˜é‡æ‰§è¡Œåˆ©ç‡ ${stockRate.toFixed(2)}%ï¼Œæ‹Ÿè°ƒæ•´è‡³ ${rate.toFixed(2)}%ï¼Œå˜åŠ¨å¹…åº¦ ${Math.abs(Math.round((rate - stockRate) * 100))}BPã€‚` : '';
    const part2 = ['äºŒã€ç”³è¯·äº‹é¡¹', apply, stockExplain].filter(Boolean).join('\n');

    const segLine = (segs.length ? segs : ['æ™®æƒ å°å¾®']).flatMap(s => PHRASES.SEG_TEXT[PHRASES.segGroupMap[s]] || []).slice(0, 2).join(' ');
    const part3 = ['ä¸‰ã€å®¢æˆ·èµ„è´¨ä¸ç»è¥æƒ…å†µ', segLine, IT.qual].filter(Boolean).join('\n');

    const measures = (IT.measures || []).map((x, i) => `ï¼ˆ${i + 1}ï¼‰${x}`).join('\n');
    const part4 = `å››ã€é…å¥—æªæ–½ä¸ååŒå®‰æ’\n${measures}`;

    const evaText = eva ? `ç»è¥ä¸­å°æµ‹ç®—ï¼šEVA ${Number(eva).toFixed(2)}ã€‚` : 'EVA ä»¥ä¸­å°å£å¾„ä¸ºå‡†ã€‚';
    const part5 = `äº”ã€æ”¶ç›Šæµ‹ç®—ä¸EVA\n${evaText}`;

    const costLine = (PHRASES.costByAppr && (PHRASES.costByAppr[segMain] || PHRASES.costByAppr['é»˜è®¤'])) || 'èµ„é‡‘æˆæœ¬ç»æµ‹ç®—å¯æ§ã€‚';
    const part6 = `å…­ã€ç»¼åˆç†ç”±ä¸å»ºè®®\n${costLine}`;

    const fixedNote1 = '1. å·²å®Œæˆå…³è”æ–¹æŸ¥éªŒï¼Œéæˆ‘è¡Œå…³è”æ–¹ã€‚';
    const fixedNote2 = '2. æœ¬æ¬¡ä¸æ¶‰åŠè±å…è‡ªå¾‹åŠ ç‚¹ã€‚\nè¯·å®¡é˜…æ‰¹å‡†ã€‚';
    const userNote = note ? `\n\nè¡¥å……è¯´æ˜ï¼š\n${note}` : '';
    const part7 = `ä¸ƒã€å…¶ä»–æ³¨æ„äº‹é¡¹\n${fixedNote1}\n${fixedNote2}${userNote}`;

    return { part1, part2, part3, part4, part5, part6, part7 };
}

function updateUI(J, dL, dF, thrRef, segMain, tenor) {
    $('#log').textContent = 'å·²å®æ—¶æ›´æ–°';
    const badge = $('#apprBadge'), bt = $('#apprBadgeText');
    bt.textContent = J.layer;
    badge.className = 'pill'; 
    if (J.layer.startsWith('åˆ†è¡Œ')) badge.classList.add('ok');
    else if (J.layer.startsWith('æ€»è¡Œ')) badge.classList.add('warn');
    else badge.classList.add('err');

    const hints = $('#smartHints');
    hints.innerHTML = '';
    const addHint = (text) => { const h = document.createElement('div'); h.className = 'hint'; h.textContent = text; hints.appendChild(h); };
    addHint(`å®¡æ‰¹åˆ¤æ–­ï¼š${J.msg}`);
    addHint(`åˆ©å·®(LPR)ï¼š${dL >= 0 ? '+' : ''}${dL}BPï¼›åˆ©å·®(FTP)ï¼š${dF >= 0 ? '+' : ''}${dF}BP`);
    
    const rateHint = $('#rateHint');
    rateHint.textContent = (typeof thrRef === 'number') ? `å»ºè®®ï¼š${thrRef.toFixed(2)}%ï¼ˆ${tenor}Â·${segMain}ï¼‰` : 'å»ºè®®ï¼šâ€”';
}

function judgeLayer(rate, tenor, segs) {
    const segMain = PHRASES.segGroupMap[segs[0]] || 'éä¸Šè¿°å®¢ç¾¤';
    const thr = (PHRASES.THRESH[tenor] || {})[segMain];
    if (thr == null) return { layer: 'åˆ†è¡Œå®¡æ‰¹æƒé™', msg: 'æŒ‰åˆ¶åº¦å£å¾„æ ¸å¯¹ã€‚' };
    if (rate >= thr) return { layer: 'åˆ†è¡Œå®¡æ‰¹æƒé™', msg: 'ç¬¦åˆåˆ†è¡Œå®¡æ‰¹æƒé™ã€‚' };
    const floor = 2.28; // Simplified floor
    if (rate >= floor) return { layer: 'æ€»è¡Œæ¡çº¿è´Ÿè´£äººå®¡æ‰¹', msg: 'ä½äºåˆ†è¡Œæƒé™ï¼Œæè¯·æ€»è¡Œæ¡çº¿è´Ÿè´£äººå®¡æ‰¹ã€‚' };
    return { layer: 'è¶…æ”¿ç­–ä¸‹é™ï¼ˆä¸äºˆå—ç†ï¼‰', msg: `ä½äºå½“å‰åˆ¶åº¦ä¸‹é™ï¼ˆ${floor.toFixed(2)}%ï¼‰ï¼Œä¸åœ¨æœ¬æ‰¹æ¬¡æƒé™èŒƒå›´ã€‚` };
}

// --- UI Interaction & Population ---

function setupEventListeners() {
    document.body.addEventListener('click', e => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (t.classList.contains('chip')) handleChipClick(t);
    });

    $$('input, select, textarea').forEach(el => {
        el.addEventListener('input', build);
    });

    $('#btnCopy').onclick = () => copyTarget('#out');
    $('#btnCopySummary').onclick = () => copyTarget('#summaryOut');
    $('#btnDocx').onclick = buildWord;
    $('#btnOcr').onclick = ocrClick;
    $('#applySuggest').onclick = applySuggestedRate;
    $('#btnCheer').onclick = () => $('#cheerModal').classList.add('show');
    $('#cheerClose').onclick = () => $('#cheerModal').classList.remove('show');
    $('#cheerModal').addEventListener('click', e => { if (e.target === $('#cheerModal')) $('#cheerModal').classList.remove('show'); });
}

function handleChipClick(t) {
    const parent = t.parentElement;
    const isMultiSelect = parent.id === 'segChips' || parent.id === 'prodChips';
    
    if (!isMultiSelect) { // Single-select logic for presets and stock
        if (t.classList.contains('sel')) return;
        parent.querySelectorAll('.chip.sel').forEach(c => c.classList.remove('sel'));
    }

    t.classList.toggle('sel');
    t.classList.add('jump');
    setTimeout(() => t.classList.remove('jump'), 320);

    if (parent.id === 'presetChips') {
        applyPreset(JSON.parse(t.dataset.preset));
    } else {
        if (parent.id === 'stockChips') {
            $('#stockRow').style.display = (t.dataset.v === 'æ˜¯') ? '' : 'none';
        }
        build();
    }
}

function applyPreset(p) {
    const { seg, tenor, prod, gb, use, stock, stockRate, rate } = p || {};
    
    updateChipSelection('segChips', seg, true);
    updateChipSelection('prodChips', prod, true);
    updateChipSelection('stockChips', stock || 'å¦', false);

    $('#gb').value = gb || 'ä¸åŠ¨äº§æŠµæŠ¼';
    $('#use').value = use || 'æ—¥å¸¸ç»è¥å‘¨è½¬';
    $('#tenor').value = tenor || '1å¹´';
    
    const segMain = PHRASES.segGroupMap[(Array.isArray(seg) ? seg[0] : seg) || 'æ™®æƒ å°å¾®'];
    const thr = (PHRASES.THRESH[$('#tenor').value] || {})[segMain || 'æ™®æƒ '];
    $('#rate').value = Number(rate ?? thr ?? 2.60).toFixed(2);

    $('#stockRow').style.display = stock === 'æ˜¯' ? '' : 'none';
    if (stock === 'æ˜¯' && stockRate) $('#stockRate').value = Number(stockRate).toFixed(2);

    build();
    toast('å·²åº”ç”¨åœºæ™¯é¢„è®¾');
    stars(8);
}

function applySuggestedRate() {
    const segs = $$('#segChips .chip.sel').map(x => x.dataset.v);
    const tenor = $('#tenor').value;
    const segMain = PHRASES.segGroupMap[segs[0]] || 'éä¸Šè¿°å®¢ç¾¤';
    const thr = (PHRASES.THRESH[tenor] || {})[segMain];
    if (typeof thr === 'number') {
        $('#rate').value = thr.toFixed(2);
        build();
        toast('å·²åº”ç”¨å»ºè®®åˆ©ç‡');
    } else {
        toast('æš‚æ— å»ºè®®å€¼ï¼Œè¯·æ‰‹åŠ¨å¡«å†™');
    }
}

function populateUI(data) {
    const populateSelect = (id, list) => {
        const select = $(`#${id}`);
        select.innerHTML = '';
        list.forEach(item => { const o = document.createElement('option'); o.textContent = item; select.appendChild(o); });
    };

    populateSelect('industry', Object.keys(data.industryTemplates || {}));
    populateSelect('gb', data.collateral || []);
    populateSelect('use', data.purposes || []);

    buildChips('segChips', Object.keys(data.segGroupMap || {}), ['æ™®æƒ å°å¾®'], true);
    buildChips('prodChips', data.products || [], ['æµåŠ¨èµ„é‡‘è´·æ¬¾'], true);

    const presetContainer = $('#presetChips');
    presetContainer.innerHTML = '';
    (data.presets || []).forEach(p => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.dataset.preset = JSON.stringify(p);
        chip.textContent = p.label;
        presetContainer.appendChild(chip);
    });
}

function buildChips(containerId, items, selected, isMulti) {
    const container = $(`#${containerId}`);
    if (!container) return;
    container.innerHTML = '';
    items.forEach(item => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.dataset.v = item;
        chip.textContent = item;
        if (isMulti ? selected.includes(item) : selected === item) {
            chip.classList.add('sel');
        }
        container.appendChild(chip);
    });
}

function updateChipSelection(containerId, selection, isMulti) {
    $$(`#${containerId} .chip`).forEach(chip => {
        const value = chip.dataset.v;
        const shouldBeSelected = isMulti 
            ? Array.isArray(selection) && selection.includes(value)
            : selection === value;
        chip.classList.toggle('sel', shouldBeSelected);
    });
}

// --- OCR & DOCX Logic ---
let ocrLoaded = false;
async function ensureOCR() { if (ocrLoaded) return; await new Promise((res, rej) => { const s = document.createElement('script'); s.src = 'https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js'; s.onload = () => { ocrLoaded = true; res(); }; s.onerror = () => rej(new Error('OCRåº“åŠ è½½å¤±è´¥')); document.head.appendChild(s); }); }
async function ocrClick() { const fs = $('#ocrImg').files; if (!fs || !fs.length) { alert('è¯·é€‰æ‹©åŒ…å« EVA çš„æˆªå›¾'); return; } $('#ocrLog').textContent = 'è¯†åˆ«ä¸­â€¦'; try { await ensureOCR(); const v = await runOCR(fs); if (v != null) { $('#eva').value = Number(v).toFixed(2); $('#ocrLog').textContent = 'å·²è¯†åˆ«ï¼šEVA=' + Number(v).toFixed(2); build(); } else { $('#ocrLog').textContent = 'æœªè¯†åˆ«åˆ° EVAï¼Œå¯æ‰‹å¡«'; } } catch (e) { console.warn(e); $('#ocrLog').textContent = 'è¯†åˆ«å¤±è´¥ï¼ˆå¯æ‰‹å¡«ï¼‰'; } }
async function runOCR(files) { let best = null; for (const f of files) { const url = URL.createObjectURL(f); try { const r = await Tesseract.recognize(url, 'chi_sim+eng'); const text = (r.data.text || '').replace(/\s+/g, ' '); const patterns = [/EVAï¼ˆæ•´ç¬”ä¸šåŠ¡ï¼‰[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i, /EVA[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i, /ï¼¥ï¼¶ï¼¡[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i]; for (const re of patterns) { const m = text.match(re); if (m) { const val = parseFloat(m[1]); if (!isNaN(val)) { best = val; break; } } } } finally { URL.revokeObjectURL(url); } } return best; }

let docxLoaded = false;
async function ensureDocx() { 
    if (docxLoaded) return; 
    const candidates = [
        'https://unpkg.com/docx@8.5.0/build/index.js',
        'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js',
        './docx.min.js'
    ]; 
    for (const c of candidates) { 
        try { 
            await new Promise((res, rej) => { 
                const s = document.createElement('script'); 
                s.src = c; 
                s.onload = () => { 
                    docxLoaded = true; 
                    res(); 
                }; 
                s.onerror = rej; 
                document.head.appendChild(s); 
            }); 
            if (window.docx) return; 
        } catch (_) { 
            console.warn(`Failed to load docx from ${c}`);
        } 
    } 
    throw new Error('æœªèƒ½åŠ è½½ docx åº“'); 
}

async function buildWord() {
    const txt = $('#out').textContent || '';
    if (!txt.trim()) { toast('è¯·å…ˆç”Ÿæˆå†…å®¹'); return; }
    toast('â³ æ­£åœ¨ç”ŸæˆWordæ–‡æ¡£â€¦');
    rocket();
    try {
        await ensureDocx();
        
        // æ£€æŸ¥docxåº“æ˜¯å¦æ­£ç¡®åŠ è½½
        if (!window.docx || !window.docx.Document) {
            throw new Error('docxåº“æœªæ­£ç¡®åŠ è½½');
        }
        
        const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, ImageRun, PageBreak } = window.docx;

        const p = (text) => new Paragraph({ 
            children: [new TextRun({ 
                text: text || '', 
                font: 'ä»¿å®‹_GB2312', 
                size: 24 
            })], 
            spacing: { after: 160 } 
        });
        const h1 = (text) => new Paragraph({ 
            text: text || '', 
            heading: HeadingLevel.HEADING_1, 
            alignment: AlignmentType.CENTER, 
            spacing: { after: 240 } 
        });
        const h2 = (text) => new Paragraph({ 
            text: text || '', 
            heading: HeadingLevel.HEADING_2, 
            spacing: { after: 120 } 
        });

        const summary = $('#summaryOut').textContent || '';
        const titleLine = (txt.split('\n')[0] || '').trim();
        const bodyText = txt.substring(titleLine.length).trim();

        const docChildren = [];
        if (titleLine) docChildren.push(h1(titleLine));
        
        docChildren.push(h2('OA æ‘˜è¦'));
        summary.split(/\n/).forEach(line => {
            if (line.trim()) docChildren.push(p(line));
        });
        
        docChildren.push(new Paragraph({ children: [new PageBreak()] }));
        
        docChildren.push(h2('æ­£æ–‡'));
        bodyText.split(/\n/).forEach(line => {
            if (line.trim()) {
                if (/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/.test(line.trim())) {
                    docChildren.push(h2(line));
                } else {
                    docChildren.push(p(line));
                }
            }
        });

        const imgs = Array.from($('#ocrImg').files || []);
        if (imgs.length > 0) {
            docChildren.push(h2('é™„ä»¶ï¼šEVAæˆªå›¾'));
            for (let i = 0; i < imgs.length; i++) {
                const file = imgs[i];
                try {
                    const buffer = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = e => reject(e.target.error);
                        reader.readAsArrayBuffer(file);
                    });
                    docChildren.push(p(`æˆªå›¾ ${i + 1}`), new Paragraph({ 
                        children: [new ImageRun({ 
                            data: buffer, 
                            transformation: { width: 540, height: 405 } 
                        })] 
                    }));
                } catch (imgError) {
                    console.warn(`Failed to process image ${i + 1}:`, imgError);
                    docChildren.push(p(`æˆªå›¾ ${i + 1} (å¤„ç†å¤±è´¥)`));
                }
            }
        }

        const doc = new Document({ sections: [{ children: docChildren }] });
        const blob = await Packer.toBlob(doc);
        const ds = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        downloadBlob(`åˆ©ç‡ä¼˜æƒ ç­¾æŠ¥_${ds}.docx`, blob);
        toast('âœ”ï¸ ç¾ä¸½ç¾ä¸½ Â· å·²ç”Ÿæˆ Word');
        stars(18);
    } catch (e) {
        console.error('Word generation error:', e);
        toast(`ç”ŸæˆWordå¤±è´¥: ${e.message}`);
    }
}

function downloadBlob(name, blob) { const a = document.createElement('a'); const url = URL.createObjectURL(blob); a.href = url; a.download = name; document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1200); }

// --- Initial Load ---
function main() {
    setupEventListeners();
    populateUI(PHRASES);
    build();
}

main();

</script>
</body>
</html>
