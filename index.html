<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<title>新开户尽职调查表 · 智能生成器</title>
  <style>
    :root{
      --bg:#fef6ff;
      --bg2:#f2fbff;
      --paper:#ffffffcc;
      --ink:#191635;
      --muted:#7c7a93;
      --line:#e8e5ff;
      --accent:#ff80b5;
      --accent-2:#8b6dff;
      --accent-3:#5ee3ff;
      --radius:20px;
      --shadow:0 18px 35px rgba(94,109,255,.15);
    }
    *{box-sizing:border-box;font-family:'SF Pro Display','PingFang SC',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{
      margin:0;
      min-height:100vh;
      background:radial-gradient(circle at 20% 20%,rgba(255,128,181,.25),transparent 50%),
                radial-gradient(circle at 90% 10%,rgba(94,227,255,.25),transparent 45%),
                linear-gradient(180deg,var(--bg) 0%,var(--bg2) 60%,#fdfdff 100%);
      color:var(--ink);
      padding-bottom:140px;
    }
    .shell{max-width:960px;margin:0 auto;padding:32px clamp(16px,4vw,36px) 70px}
    header.hero{display:flex;gap:18px;align-items:center;margin-bottom:24px;flex-wrap:wrap}
    .logo{width:58px;height:58px;border-radius:22px;background:linear-gradient(135deg,#ff99d6,#ff7ac1 40%,#8b6dff 80%,#5ee3ff);box-shadow:0 12px 30px rgba(255,122,193,.35)}
    h1{margin:0;font-weight:700;font-size:clamp(22px,5vw,34px);letter-spacing:.2px;color:#1f1b45}
    .hero p{margin:6px 0 0;color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px}
    .card{background:var(--paper);border-radius:var(--radius);border:1px solid rgba(255,255,255,.7);box-shadow:var(--shadow);padding:22px;backdrop-filter:blur(10px)}
    .card h2{margin:0 0 14px;font-size:18px;color:#332c63;display:flex;align-items:center;gap:6px}
    .card h2::after{content:'';flex:1;height:2px;background:linear-gradient(90deg,rgba(255,128,181,.28),transparent)}
    label{display:block;font-size:14px;color:#49446b;margin-bottom:6px;font-weight:600}
    input[type=text],input[type=file]{width:100%;border:1px solid var(--line);border-radius:16px;padding:12px 15px;font-size:15px;color:var(--ink);outline:none;background:#fff;transition:border .2s,box-shadow .2s}
    input[type=text]:focus,input[type=file]:focus{border-color:#b3a2ff;box-shadow:0 0 0 4px rgba(179,162,255,.2)}
    .field{margin-bottom:18px}
    .hint{font-size:13px;color:var(--muted);margin-top:6px}
    .photos{display:flex;flex-direction:column;gap:14px}
    .preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px}
    .thumb{width:100%;aspect-ratio:4/3;border-radius:16px;object-fit:cover;border:1px dashed rgba(255,128,181,.45);box-shadow:inset 0 0 0 2px rgba(255,255,255,.6)}
    .dock{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(170%) blur(14px);border-top:1px solid rgba(255,255,255,.6);box-shadow:0 -8px 20px rgba(25,22,53,.08)}
    .dock-inner{max-width:960px;margin:0 auto;padding:16px clamp(16px,4vw,32px);display:flex;gap:14px;align-items:center}
    .btn{flex:1;border:none;border-radius:18px;padding:16px 20px;font-size:16px;font-weight:600;color:#fff;background:linear-gradient(100deg,var(--accent),var(--accent-2),var(--accent-3));box-shadow:0 16px 30px rgba(137,109,255,.35);cursor:pointer;transition:transform .15s,box-shadow .15s}
    .btn:active{transform:translateY(1px);box-shadow:0 6px 15px rgba(137,109,255,.35)}
    .status{font-size:13px;color:var(--muted)}
    @media (max-width:720px){
      header.hero{flex-direction:column;align-items:flex-start}
      .grid{grid-template-columns:1fr}
      .dock-inner{flex-direction:column;align-items:stretch}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="hero">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>新开户尽职调查表 · 智能生成器</h1>
        <p>本地计算 · 不出网 · 填写三项核心信息 + 走访照片，即可生成新版模板</p>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>① 客户信息</h2>
        <div class="field">
          <label for="customer">客户名称</label>
          <input id="customer" type="text" placeholder="如：厦门市星晨科技有限公司" />
        </div>
        <div class="field">
          <label for="industry">行业分类</label>
          <input id="industry" type="text" placeholder="如：C3830 专用设备制造" />
        </div>
        <div class="field" style="margin-bottom:4px">
          <label for="address">经营地址</label>
          <input id="address" type="text" placeholder="如：厦门市湖里区高林中一路 188 号" />
        </div>
        <div class="hint">仅三项必填，其余字段默认留空，方便后续人工勾选。</div>
      </section>

      <section class="card">
        <h2>② 模板文件</h2>
        <label for="tpl">导入《新开户尽职调查表模版.docx》</label>
        <input id="tpl" type="file" accept=".docx" />
        <div class="hint">模板只需导入一次，后续会缓存。若模板更新，可重新导入。</div>
      </section>
    </div>

    <section class="card" style="margin-top:18px">
      <h2>③ 上门核实图片</h2>
      <div class="photos">
        <input id="photos" type="file" accept="image/*" multiple />
        <div class="hint">自动排成两列，插入“上门核实图片”段落下方，每行至多 2 张。</div>
        <div class="preview" id="preview"></div>
      </div>
    </section>
  </div>

  <div class="dock">
    <div class="dock-inner">
      <div class="status" id="status">待生成…</div>
      <button class="btn" id="btnGen">生成 DOCX</button>
    </div>
  </div>


  
  <script>
  'use strict';
  const statusEl = document.getElementById('status');
  function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }

  async function ensurePizZip(){
    if(window.PizZip){ return; }
    const sources = [
      'https://cdn.jsdelivr.net/npm/pizzip@3.1.7/dist/pizzip.js',
      'https://unpkg.com/pizzip@3.1.7/dist/pizzip.js'
    ];
    for (const url of sources){
      try{
        await new Promise((resolve,reject)=>{
          const s=document.createElement('script');
          s.src=url;
          s.onload=resolve;
          s.onerror=reject;
          document.head.appendChild(s);
        });
        if(window.PizZip){ return; }
      }catch(err){
        console.warn('加载 PizZip 失败，尝试下一源', err);
      }
    }
    throw new Error('PizZip 加载失败，请联网后刷新页面。');
  }

  const W_NS = 'http://schemas.openxmlformats.org/wordprocessingml/2006/main';
  const PLACEHOLDERS = ['客户名称','行业分类','经营地址'];

  const tplInput = document.getElementById('tpl');
  let tplBuffer = null;
  if(tplInput){
    tplInput.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file){ tplBuffer=null; setStatus('尚未导入模板'); return; }
      try{
        tplBuffer = await file.arrayBuffer();
        setStatus('已缓存模板：'+file.name);
      }catch(err){
        console.error(err);
        tplBuffer=null;
        setStatus('模板读取失败');
        alert('无法读取模板：'+err.message);
      }
    });
  }

  const photoInput = document.getElementById('photos');
  const previewBox = document.getElementById('preview');
  let selectedPhotos = [];
  if(photoInput){
    photoInput.addEventListener('change', (e)=>{
      selectedPhotos = Array.from(e.target.files || []);
      if(previewBox){
        previewBox.innerHTML='';
        selectedPhotos.forEach((file)=>{
          const url = URL.createObjectURL(file);
          const img = document.createElement('img');
          img.className='thumb';
          img.src=url;
          img.onload=()=>URL.revokeObjectURL(url);
          previewBox.appendChild(img);
        });
      }
      setStatus(selectedPhotos.length?`已选择 ${selectedPhotos.length} 张照片`:'未添加照片');
    });
  }

  function ensurePhotoBlock(xml){
    const block = '<w:p><w:r><w:t>[[PHOTO]]</w:t></w:r></w:p>';
    const marker = /(<w:p[^>]*>[\s\S]*?上门核实图片[\s\S]*?<\/w:p>)/;
    if(marker.test(xml)){
      return xml.replace(marker, '$1'+block);
    }
    const bodyClose= /<\/w:body>\s*<\/w:document>/;
    if(bodyClose.test(xml)){
      return xml.replace(bodyClose, block+'</w:body></w:document>');
    }
    return xml+block;
  }

  function sanitizeFileName(name){
    return (name||'未命名').replace(/[\/:*?"<>|]/g,'_');
  }

  function replacePlaceholdersXML(xml,map){
    const parser = new DOMParser();
    const dom = parser.parseFromString(xml,'application/xml');
    if(dom.getElementsByTagName('parsererror').length){
      throw new Error('模板解析失败，请确认 DOCX 正常。');
    }
    const stats = {};
    const regMap = {};
    Object.keys(map).forEach((key)=>{
      stats[key]=0;
      regMap[key]=new RegExp('{{\s*'+key+'\s*}}','g');
    });
    const paragraphs = Array.from(dom.getElementsByTagNameNS(W_NS,'p'));
    paragraphs.forEach((p)=>{
      const texts = Array.from(p.getElementsByTagNameNS(W_NS,'t'));
      if(!texts.length) return;
      const original = texts.map((t)=>t.textContent||'').join('');
      let updated = original;
      let changed = false;
      Object.keys(map).forEach((key)=>{
        const regex = regMap[key];
        const matches = updated.match(regex);
        if(matches){
          stats[key]+=matches.length;
          updated = updated.replace(regex, map[key]);
          changed = true;
        }
      });
      if(changed){
        texts[0].textContent = updated;
        for(let i=1;i<texts.length;i++){
          const run = texts[i].parentNode;
          texts[i].parentNode.removeChild(texts[i]);
          if(run && !run.textContent){
            run.parentNode && run.parentNode.removeChild(run);
          }
        }
      }
    });
    const serializer = new XMLSerializer();
    return { xml: serializer.serializeToString(dom), stats };
  }

  function inchToEmu(inches){ return Math.round(inches * 914400); }
  function nextMedia(zip){
    const files = Object.keys(zip.files).filter((k)=>k.indexOf('word/media/')===0);
    const nums = files.map((f)=>{ const m=f.match(/image(\d+)\./); return m?parseInt(m[1],10):0; });
    const n = nums.length ? Math.max.apply(null,nums)+1 : 1;
    return 'word/media/image'+n+'.jpeg';
  }
  function nextRid(rels){
    const ids=[]; const re=/Id="rId(\d+)"/g; let m;
    while((m=re.exec(rels))){ ids.push(parseInt(m[1],10)); }
    const max = ids.length?Math.max.apply(null,ids):800;
    return 'rId'+(max+1);
  }

  function addImageRelationship(zip, rels, base64){
    const media = nextMedia(zip);
    zip.file(media, base64, { base64:true });
    const rid = nextRid(rels);
    const updated = rels.replace('</Relationships>',`
  <Relationship Id="${rid}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="${media.replace('word/','')}"/>
</Relationships>`);
    return { rid, rels: updated };
  }

  function buildDrawingXml(rid, widthIn, heightIn, docPrId){
    const w = inchToEmu(widthIn);
    const h = inchToEmu(heightIn);
    return `<w:p><w:r><w:drawing><wp:inline distT="0" distB="0" distL="0" distR="0" xmlns:wp="http://schemas.openxmlformats.org/officeDocument/2006/wordprocessingDrawing">`
      +`<wp:extent cx="${w}" cy="${h}"/>`
      +`<wp:docPr id="${docPrId}" name="Photo${docPrId}"/>`
      +`<a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main">`
      +`<a:graphicData uri="http://schemas.openxmlformats.org/officeDocument/2006/relationships/picture">`
      +`<pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">`
      +`<pic:nvPicPr><pic:cNvPr id="0" name="visit"/><pic:cNvPicPr/></pic:nvPicPr>`
      +`<pic:blipFill><a:blip r:embed="${rid}" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"/><a:stretch><a:fillRect/></a:stretch></pic:blipFill>`
      +`<pic:spPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="${w}" cy="${h}"/></a:xfrm><a:prstGeom prst="rect"><a:avLst/></a:prstGeom></pic:spPr>`
      +`</pic:pic></a:graphicData></a:graphic></wp:inline></w:drawing></w:r></w:p>`;
  }

  function readImageFile(file){
    return new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=()=>{
        const img=new Image();
        img.onload=()=>resolve(img);
        img.onerror=()=>reject(new Error('无法读取图片：'+file.name));
        img.src=reader.result;
      };
      reader.onerror=()=>reject(new Error('图片加载失败：'+file.name));
      reader.readAsDataURL(file);
    });
  }

  async function convertFileToBase64(file){
    const img = await readImageFile(file);
    const maxEdge = 2000;
    const largest = Math.max(img.width, img.height);
    const scale = largest>maxEdge ? maxEdge/largest : 1;
    const canvas = document.createElement('canvas');
    canvas.width = Math.max(1, Math.round(img.width * scale));
    canvas.height = Math.max(1, Math.round(img.height * scale));
    const ctx = canvas.getContext('2d');
    ctx.fillStyle='#fff';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    const base64 = canvas.toDataURL('image/jpeg',0.92).split(',')[1];
    return { base64, ratio: canvas.height / canvas.width };
  }

  async function preparePhotoRuns(files){
    const runs=[];
    for(const file of files){
      try{
        const { base64, ratio } = await convertFileToBase64(file);
        const widthIn = 6;
        const heightIn = Math.min(7.2, widthIn * ratio);
        runs.push({ base64, widthIn, heightIn, name: file.name });
      }catch(err){
        console.error('处理照片失败', file.name, err);
        alert('处理照片失败：'+file.name+'，已跳过。');
      }
    }
    return runs;
  }

  function injectPhotoRuns(zip, runs){
    if(!runs.length) return;
    const relPath='word/_rels/document.xml.rels';
    let rels = zip.file(relPath).asText();
    let docXml = zip.file('word/document.xml').asText();
    let block='';
    let docPr=300;
    runs.forEach((run, idx)=>{
      const result = addImageRelationship(zip, rels, run.base64);
      rels = result.rels;
      block += buildDrawingXml(result.rid, run.widthIn, run.heightIn, docPr++);
      block += '<w:p/>';
      if((idx % 2 === 1) && idx < runs.length-1){
        block += '<w:p><w:r><w:br w:type="page"/></w:r></w:p>';
      }
    });
    zip.file(relPath, rels);
    const rePh=/<w:t[^>]*>\[\[PHOTO\]\]<\/w:t>/;
    if(rePh.test(docXml)){
      docXml = docXml.replace(rePh, block);
    }else{
      docXml = docXml.replace(/<\/w:body>\s*<\/w:document>/, block+'</w:body></w:document>');
    }
    zip.file('word/document.xml', docXml);
  }

  function downloadBlob(blob,name){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1200);
  }

  async function generate(){
    try{
      const customer = document.getElementById('customer').value.trim();
      const industry = document.getElementById('industry').value.trim();
      const address = document.getElementById('address').value.trim();
      if(!customer){ alert('请填写客户名称'); return; }
      if(!industry){ alert('请填写行业分类'); return; }
      if(!address){ alert('请填写经营地址'); return; }
      let buffer = tplBuffer;
      if(!buffer){
        const file = tplInput && tplInput.files[0];
        if(!file){ alert('请导入模板文件'); return; }
        buffer = await file.arrayBuffer();
      }
      await ensurePizZip();
      const zip = new PizZip(buffer);
      const docPath = 'word/document.xml';
      let xml = zip.file(docPath).asText();
      const replacements = { '客户名称':customer, '行业分类':industry, '经营地址':address };
      const replaced = replacePlaceholdersXML(xml, replacements);
      const missing = PLACEHOLDERS.filter((key)=>replaced.stats[key]===0);
      if(missing.length){
        throw new Error('模板中缺少占位符：'+missing.join(','));
      }
      setStatus('占位符命中：'+PLACEHOLDERS.map((k)=>k+replaced.stats[k]).join('，'));
      xml = replaced.xml;
      const needPhotos = selectedPhotos.length>0;
      if(needPhotos){ xml = ensurePhotoBlock(xml); }
      zip.file(docPath, xml);
      if(needPhotos){
        const runs = await preparePhotoRuns(selectedPhotos);
        injectPhotoRuns(zip, runs);
      }
      const blob = zip.generate({ type:'blob' });
      const fileName = sanitizeFileName(customer)+'新开户尽职调查表.docx';
      downloadBlob(blob, fileName);
      setStatus('✅ 已生成 '+fileName);
    }catch(err){
      console.error(err);
      setStatus('❌ 生成失败');
      alert('生成失败：'+err.message);
    }
  }

  const btn = document.getElementById('btnGen');
  if(btn){ btn.addEventListener('click', generate); }
  </script>


</body>
</html>
