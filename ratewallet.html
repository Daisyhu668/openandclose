<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>åˆ©ç‡ä¼˜æƒ ç­¾æŠ¥ Â· æ™ºèƒ½ç”Ÿæˆå™¨</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
:root{
  --ink:#0b1220; --muted:#667085; --line:#e6e9ef;
  --mario-red:#e11d48; --sky:#38bdf8; --coin:#f59e0b; --green:#10b981;
  --paper:rgba(255,255,255,.9); --radius:18px;
  --shadow:0 14px 34px rgba(2,6,23,.12), 0 2px 8px rgba(2,6,23,.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;color:var(--ink);
  font:15.5px/1.6 -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Hiragino Sans GB",Segoe UI,Roboto,Helvetica,Arial}
.bg{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg,#e0f2fe 0%, #f0f9ff 40%, #fff 100%)}
.bg::before{content:"";position:absolute;inset:-8% -8%;background-size:cover;background-position:center;filter:blur(16px) opacity(.25)}
.wrap{max-width:1080px;margin:0 auto;padding:22px 16px 120px}
header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.logo{width:42px;height:42px;border-radius:12px;background:
  radial-gradient(40% 40% at 30% 30%,#fff,transparent 70%),
  conic-gradient(from 200deg,var(--mario-red),#ef4444 30%,#fb7185 60%,var(--mario-red));
  box-shadow:0 10px 26px rgba(225,29,72,.28),0 2px 8px rgba(16,24,40,.08)}
h1{margin:0;font-weight:800;font-size:clamp(20px,2.6vw,28px);letter-spacing:.2px}
.sub{color:var(--muted);font-size:13px;margin-top:2px}

.card{background:var(--paper);backdrop-filter:saturate(150%) blur(10px);
  border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.grid2{display:grid;grid-template-columns:1.08fr .92fr;gap:14px}
.row{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:center;margin:10px 0}
label{color:#475569}
input[type=text],input[type=number],select,textarea{
  width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;color:var(--ink);
  padding:10px 12px;outline:none;transition:border .15s,box-shadow .15s}
input:focus,select:focus,textarea:focus{border-color:#bae6fd;box-shadow:0 0 0 5px rgba(56,189,248,.18)}
textarea{min-height:120px}

.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{border:2px solid #e2e8f0;border-radius:14px;padding:8px 14px;background:linear-gradient(180deg,#fff,#f8fafc);
  color:#0b1220;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
.chip:hover{transform:translateY(-1px)}
.chip.sel{background:linear-gradient(180deg,#fef3c7,#fde68a); border-color:#f59e0b; box-shadow:0 6px 14px rgba(245,158,11,.25)}

.badge{border-radius:999px;padding:7px 12px;font-weight:700}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
.pill.ok{background:linear-gradient(180deg,#ecfeff,#dbeafe);border-color:#bfdbfe;color:#1e3a8a}
.pill.warn{background:linear-gradient(180deg,#fff7ed,#ffedd5);border-color:#fed7aa;color:#7c2d12}
.pill.err{background:linear-gradient(180deg,#fef2f2,#fee2e2);border-color:#fecaca;color:#7f1d1d}
.btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;border:none;border-radius:14px;padding:12px 16px;color:#fff;
  background:linear-gradient(90deg,var(--mario-red) 0%, var(--coin) 100%);box-shadow:0 10px 24px rgba(225,29,72,.28);cursor:pointer;font-weight:800;letter-spacing:.2px}
.btn:active{transform:translateY(1px)}
.btn.sky{background:linear-gradient(90deg,#0ea5e9, #22d3ee)}
.btn.ghost{background:#f3f5fb;color:#1f2a44;border:1px solid var(--line);box-shadow:none}
.dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:rgba(255,255,255,.86);
  backdrop-filter:saturate(150%) blur(10px);border-top:1px solid var(--line)}
.dock-inner{max-width:1080px;margin:0 auto;padding:12px 16px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
.log{margin-left:auto;color:var(--muted);font-size:12.5px}
#out{white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:12px;border-radius:12px;min-height:160px}
.hints{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.hint{font-size:12px;color:#475569;padding:6px 10px;border:1px dashed #e2e8f0;border-radius:10px;background:#fff}
.subtle{font-size:12px;color:#64748b}
.titlebar{display:flex;align-items:center;gap:8px}
.titlebar .coin{filter:drop-shadow(0 6px 10px rgba(245,158,11,.35))}

/* Mario-lite åŠ¨æ•ˆ */
@keyframes jump { 0%{transform:translateY(0)} 40%{transform:translateY(-8px)} 100%{transform:translateY(0)} }
.jump{animation:jump .28s ease-out}
.rocket{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);font-size:26px;animation:fly 1.5s ease-out forwards;z-index:50}
@keyframes fly{0%{transform:translate(-50%,0) scale(1);opacity:1}100%{transform:translate(-50%,-82vh) scale(1.2);opacity:0}}
.burst{position:fixed;bottom:0;font-size:22px;animation:fall 1.6s ease-out forwards;z-index:45}
@keyframes fall{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-80vh) scale(1.3);opacity:0}}
.toast{position:fixed;left:50%;bottom:88px;transform:translateX(-50%) scale(.96);opacity:0;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:60}
.toast.show{opacity:1;transform:translateX(-50%) scale(1);transition:all .18s ease}

/* å°ç –å—åˆ†éš”ï¼ˆMarioï¼‰ */
.brick{height:10px;background:repeating-linear-gradient(90deg,#f59e0b 0 12px,#d97706 12px 24px);opacity:.2;border-radius:10px;margin:6px 0}

/* ä½œè€…å¼¹çª— */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:80}
.modal .panel{background:#fff;border-radius:16px;max-width:460px;width:calc(100% - 40px);padding:18px;box-shadow:var(--shadow)}
.modal .panel .close{position:absolute;right:12px;top:10px;cursor:pointer;color:#64748b}
.modal.show{display:flex}

/* å°å± */
@media (max-width:860px){.grid2{grid-template-columns:1fr}.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="bg" id="bg"></div>

<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <div class="titlebar">
        <h1>åˆ©ç‡ä¼˜æƒ ç­¾æŠ¥ Â· æ™ºèƒ½ç”Ÿæˆå™¨</h1>
        <span id="apprBadge" class="pill ok" title="ç³»ç»ŸæŒ‰é˜ˆå€¼è‡ªåŠ¨åˆ¤æ–­">
          <span>å®¡æ‰¹å£å¾„</span>
          <span id="apprBadgeText">åˆ†è¡Œå®¡æ‰¹æƒé™</span>
        </span>
        <span class="coin" aria-hidden="true">ğŸª™</span>
      </div>
      <div class="sub">å¦é—¨åˆ†è¡Œç§‘æŠ€ä¸šåŠ¡éƒ¨ï¼ˆé»˜è®¤ï¼Œå¯æ”¹ï¼‰ Â· è§’è‰²ï¼šå¯¹å…¬å®¢æˆ·ç»ç†ï¼ˆ20å¹´ï¼‰</div>
    </div>
  </header>

  <div class="grid2">
    <div class="card">
      <div class="row"><label>åˆ†è¡Œï¼ˆé»˜è®¤ï¼‰</label><input id="branch" type="text" value="å¦é—¨åˆ†è¡Œ"></div>
      <div class="row"><label>éƒ¨é—¨ï¼ˆé»˜è®¤ï¼‰</label><input id="dept" type="text" value="ç§‘æŠ€ä¸šåŠ¡éƒ¨"></div>
      <div class="row"><label>å®¢æˆ·åç§°</label><input id="cust" type="text" placeholder="å¦‚ï¼šå¦é—¨æŸæŸç§‘æŠ€æœ‰é™å…¬å¸"></div>

      <div class="row"><label>å®¡æ‰¹å£å¾„</label>
        <select id="appr">
          <option>åˆ†è¡Œå®¡æ‰¹æƒé™</option>
          <option>æ€»è¡Œæ¡çº¿è´Ÿè´£äººå®¡æ‰¹</option>
          <option>è¶…æ”¿ç­–ä¸‹é™ï¼ˆä¸äºˆå—ç†ï¼‰</option>
        </select>
      </div>

      <div class="row"><label>åœºæ™¯é¢„è®¾</label>
        <div class="chips" id="presetChips">
          <!-- åŠ¨æ€æ³¨å…¥ï¼šåŸºäº THRESH è‡ªåŠ¨ç”Ÿæˆå¸¸ç”¨é¢„è®¾ -->
        </div>
      </div>

      <div class="row"><label>è¾“å‡ºé£æ ¼</label>
        <select id="tone">
          <option value="pro">ç¨³å¥ä¸“ä¸šï¼ˆé»˜è®¤ï¼‰</option>
          <option value="brief">ç®€æ´ç²¾è¦</option>
          <option value="full">è¯¦å°½å……åˆ†</option>
        </select>
      </div>
      <div class="row"><label>è¡Œä¸š</label>
        <select id="industry"><option value="é€šç”¨">é€šç”¨</option></select>
      </div>

      <div class="row"><label>æˆä¿¡å“ç§ï¼ˆå¤šé€‰ï¼‰</label>
        <div class="chips" id="prodChips">
          <span class="chip sel" data-v="æµåŠ¨èµ„é‡‘è´·æ¬¾">æµåŠ¨èµ„é‡‘è´·æ¬¾</span>
          <span class="chip" data-v="ç¨æ˜“è´·">ç¨æ˜“è´·</span>
          <span class="chip" data-v="æˆé•¿ä¼´ä¾£">æˆé•¿ä¼´ä¾£</span>
          <span class="chip" data-v="ç§‘æŠ€è´·">ç§‘æŠ€è´·</span>
          <span class="chip" data-v="ç¥¨æ®è´´ç°">ç¥¨æ®è´´ç°</span>
          <span class="chip" data-v="æŠµæŠ¼è´·æ¬¾">æŠµæŠ¼è´·æ¬¾</span>
          <span class="chip" data-v="ä¿¡ç”¨è´·æ¬¾">ä¿¡ç”¨è´·æ¬¾</span>
          <span class="chip" data-v="é“¶æ‹…åˆä½œ">é“¶æ‹…åˆä½œ</span>
        </div>
      </div>

      <div class="row"><label>æ‹…ä¿æ–¹å¼ï¼ˆå•é€‰ï¼‰</label>
        <select id="gb">
          <option>ä¸åŠ¨äº§æŠµæŠ¼</option>
          <option>æ‹…ä¿å…¬å¸100%ä¿è¯</option>
          <option>çŸ¥è¯†äº§æƒè´¨æŠ¼</option>
          <option>ä¿¡ç”¨</option>
        </select>
      </div>

      <div class="row"><label>è´·æ¬¾ç”¨é€”ï¼ˆå•é€‰ï¼‰</label>
        <select id="use">
          <option>å¤‡è´§/é‡‡è´­</option>
          <option>æ”¯ä»˜å·¥èµ„</option>
          <option>æ—¥å¸¸è¥è¿æ”¯å‡º</option>
          <option>é¡¹ç›®å‘¨è½¬</option>
        </select>
      </div>

      <div class="row"><label>å®¢ç¾¤ï¼ˆå¤šé€‰ï¼‰</label>
        <div class="chips" id="segChips">
          <span class="chip sel" data-v="æ™®æƒ ">æ™®æƒ </span>
          <span class="chip" data-v="ç§‘æŠ€/ç»¿è‰²">ç§‘æŠ€/ç»¿è‰²</span>
          <span class="chip" data-v="å›½ä¼/æ€»æˆ˜/å°å•†">å›½ä¼/æ€»æˆ˜/å°å•†</span>
          <span class="chip" data-v="éä¸Šè¿°å®¢ç¾¤">éä¸Šè¿°å®¢ç¾¤</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row"><label>é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label><input id="amt" type="number" placeholder="å¦‚ï¼š500" value="500"></div>
      <div class="row"><label>æœŸé™</label>
        <select id="tenor">
          <option>1å¹´</option><option>6ä¸ªæœˆ</option><option>2å¹´</option><option>3å¹´</option><option>4å¹´</option>
        </select>
      </div>
      <div class="row"><label>æ‰§è¡Œåˆ©ç‡(%)</label>
        <div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="rate" type="number" step="0.01" value="2.60" style="width:180px">
            <span class="hint" id="rateHint">å»ºè®®ï¼šâ€”</span>
            <button class="btn badge sky" id="applySuggest" type="button">åº”ç”¨å»ºè®®</button>
          </div>
        </div>
      </div>
      <div class="row"><label>LPR(ä¸€å¹´æœŸ%)</label><input id="lpr" type="number" step="0.01" value="3.00"></div>
      <div class="row"><label>FTP(%)</label><input id="ftp" type="number" step="0.01" value="1.80"></div>

      <div class="row"><label>æ˜¯å¦å­˜é‡</label>
        <select id="stock">
          <option value="å¦" selected>å¦</option>
          <option value="æ˜¯">æ˜¯</option>
        </select>
      </div>
      <div class="row" id="stockRow" style="display:none">
        <label>å­˜é‡åˆ©ç‡(%)</label><input id="stockRate" type="number" step="0.01" placeholder="å¦‚ï¼š3.20">
      </div>

      <div class="row"><label>EVAï¼ˆå¯æ‰‹å¡«ï¼‰</label><input id="eva" type="text" placeholder="å¦‚ï¼š13.93"></div>
      <div class="row"><label>OCR è¯†åˆ« EVA</label>
        <div>
          <input id="ocrImg" type="file" accept="image/*" multiple />
          <div class="small" id="ocrLog">ï¼ˆå¯é€‰ï¼›è¯†åˆ«å¤±è´¥ä¸å½±å“ï¼‰</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row"><label>è¡¥å……è¯´æ˜ï¼ˆå›ºå®šä¸¤å¥ä¸ºä¸»ï¼‰</label>
      <textarea id="note" placeholder="å·²å®Œæˆå…³è”æ–¹æŸ¥éªŒï¼Œç¡®è®¤å®¢æˆ·ä¸ºéæˆ‘è¡Œå…³è”æ–¹ã€‚æœ¬æ¬¡ä¸ç”³è¯·è‡ªå¾‹åŠ ç‚¹è±å…ã€‚"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="row" style="grid-template-columns:1fr"><label style="grid-column:1/-1">é¢„è§ˆï¼ˆåŒæ è¾“å‡ºï¼‰</label>
      <div class="hints" id="smartHints"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div class="titlebar" style="justify-content:space-between">
            <div style="font-weight:700">OA æ‘˜è¦</div>
            <button class="btn badge sky" id="btnCopySummary" type="button">å¤åˆ¶æ‘˜è¦</button>
          </div>
          <div id="summaryOut" style="white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:12px;border-radius:12px;min-height:120px"></div>
        </div>
        <div>
          <div class="titlebar" style="justify-content:space-between">
            <div style="font-weight:700">æ­£æ–‡ï¼ˆå®Œæ•´ï¼‰</div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="btnCopy" type="button">å¤åˆ¶æ­£æ–‡</button>
              <button class="btn ghost" id="btnDocx" type="button">ç”Ÿæˆ Wordï¼ˆå«å›¾ç‰‡ï¼‰</button>
            </div>
          </div>
          <div id="out"></div>
        </div>
      </div>
      <div class="subtle">æç¤ºï¼šæ‘˜è¦é€‚é… OA å­—æ®µï¼Œæ­£æ–‡ç”¨äºé™„ä»¶æˆ–å®Œæ•´ç­¾æŠ¥ã€‚</div>
    </div>
  </div>
</div>

<div class="dock">
  <div class="dock-inner">
    <button class="btn sky" id="btnBuild">æ›´æ–°é¢„è§ˆ</button>
    <button class="btn" id="btnCopy">å¤åˆ¶æ­£æ–‡<span class="jump">ğŸ„</span></button>
    <button class="btn ghost" id="btnDocx">ç”Ÿæˆ Wordï¼ˆå«å›¾ç‰‡ï¼‰</button>
    <button class="btn ghost" id="btnCheer">æˆ‘çˆ±ä½œè€…</button>
    <span class="log" id="log">å°±ç»ª</span>
  </div>
</div>

<!-- æˆ‘çˆ±ä½œè€…å¼¹çª— -->
<div id="cheerModal" class="modal" style="display:none">
  <div class="panel" style="position:relative">
    <span class="close" id="cheerClose" title="å…³é—­">âœ–</span>
    <h3 style="margin:0 0 8px 0">æˆ‘çˆ±ä½œè€… Â· XD.Hu</h3>
    <p class="small">è¿™æ¬¾ç­¾æŠ¥ç”Ÿæˆå™¨ç”±ä½œè€…ä¸šä½™æ—¶é—´æ‰“é€ ï¼Œç›®æ ‡æ˜¯ï¼šæ›´å¿«ã€æ›´å‡†ã€æ›´åˆè§„åœ°å®Œæˆæ—¥å¸¸ OAã€‚</p>
    <p class="small">å¦‚æœè§‰å¾—å¥½ç”¨ï¼Œæ¬¢è¿å¤¸ä½œè€…ï¼šcoolkiy@gmail.com</p>
    <p class="small">æ„Ÿè°¢æ”¯æŒä¸å»ºè®®ï¼</p>
  </div>
</div>

<script>
'use strict';
/* èƒŒæ™¯ï¼šä»æœ¬åœ° bg/ ç›®å½•éšæœºä¸€å¼ ï¼ˆä½ å·²æ”¾å¥½ï¼‰ */
const BG_LIST = ['bg-1.jpg','bg-2.jpg','bg-3.jpg','bg-4.jpg'];
(function setBg(){
  const pick = BG_LIST[Math.floor(Math.random()*BG_LIST.length)];
  const s = document.createElement('style'); s.textContent = `.bg::before{background-image:url("${pick}")}`; document.head.appendChild(s);
})();
/* ç®€æ˜“é€‰æ‹©å™¨ä¸èŠ¯ç‰‡äº¤äº’ */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
document.body.addEventListener('click', e=>{
  const t = e.target;
  if(!(t instanceof HTMLElement) || !t.classList.contains('chip')) return;
  t.classList.toggle('sel'); t.classList.add('jump');
  setTimeout(()=>t.classList.remove('jump'),320);
});
/* é¢„è®¾åœºæ™¯ä¸€é”®å¡«å…… */
function applyPreset(p){
  const {seg='æ™®æƒ ', tenor='1å¹´', rate, prod, gb, use, stock, stockRate} = p||{};
  // å®¢ç¾¤
  $$('#segChips .chip').forEach(x=>{ x.classList.toggle('sel', x.dataset.v===seg); });
  // äº§å“
  const defaultProd = (tenor==='6ä¸ªæœˆ' && prod==null) ? 'ç¥¨æ®è´´ç°' : (prod||'æµåŠ¨èµ„é‡‘è´·æ¬¾');
  $$('#prodChips .chip').forEach(x=>{ x.classList.toggle('sel', x.dataset.v===defaultProd); });
  // ç”¨é€”ä¸æ‹…ä¿
  const useSel=$('#use'); useSel.value = use || (defaultProd==='ç¥¨æ®è´´ç°' ? 'æ—¥å¸¸è¥è¿æ”¯å‡º' : 'æ—¥å¸¸ç»è¥å‘¨è½¬');
  const gbSel = $('#gb'); gbSel.value = gb || 'ä¸åŠ¨äº§æŠµæŠ¼';
  // æœŸé™ä¸åˆ©ç‡
  $('#tenor').value = tenor;
  // ä¾æ®é˜ˆå€¼å»ºè®®åˆ©ç‡ï¼Œè‹¥æä¾›åˆ™ä½¿ç”¨æä¾›å€¼
  const thr = (THRESH[tenor]||{})[seg];
  const r = (typeof rate==='number') ? rate : (typeof thr==='number' ? thr : 2.60);
  $('#rate').value = Number(r).toFixed(2);
  // å­˜é‡
  if(stock==='æ˜¯'){ $('#stock').value='æ˜¯'; $('#stockRow').style.display=''; if(stockRate) $('#stockRate').value=Number(stockRate).toFixed(2); }
  else { $('#stock').value='å¦'; $('#stockRow').style.display='none'; }
  build(); toast('å·²åº”ç”¨åœºæ™¯é¢„è®¾'); stars(8);
}
document.getElementById('presetChips')?.addEventListener('click', (e)=>{
  const t=e.target; if(!(t instanceof HTMLElement)) return; const data=t.dataset;
  if(!data.seg || !data.tenor) return;
  const payload={ seg:data.seg, tenor:data.tenor };
  if(data.prod) payload.prod=data.prod; if(data.gb) payload.gb=data.gb; if(data.use) payload.use=data.use;
  if(data.rate){ const v=parseFloat(data.rate); if(!isNaN(v)) payload.rate=v; }
  if(data.stock){ payload.stock=data.stock; if(data.stockRate){ const v=parseFloat(data.stockRate); if(!isNaN(v)) payload.stockRate=v; } }
  applyPreset(payload);
});

function buildPresets(){
  const host = document.getElementById('presetChips'); if(!host) return;
  host.innerHTML='';
  const defs = [
    {label:'æ™®æƒ æ ‡å‡†', seg:'æ™®æƒ ', tenor:'1å¹´', prod:'æµåŠ¨èµ„é‡‘è´·æ¬¾', gb:'ä¸åŠ¨äº§æŠµæŠ¼', use:'æ—¥å¸¸ç»è¥å‘¨è½¬'},
    {label:'çŸ­æœŸè´´ç°', seg:'æ™®æƒ ', tenor:'6ä¸ªæœˆ', prod:'ç¥¨æ®è´´ç°', use:'æ—¥å¸¸è¥è¿æ”¯å‡º'},
    {label:'ç§‘æŠ€/ç»¿è‰²æ ‡å‡†', seg:'ç§‘æŠ€/ç»¿è‰²', tenor:'1å¹´', prod:'ç§‘æŠ€è´·', use:'ç ”å‘æŠ•å…¥'},
    {label:'å›½ä¼/å°å•†æ ‡å‡†', seg:'å›½ä¼/æ€»æˆ˜/å°å•†', tenor:'1å¹´'},
    {label:'é€šç”¨æ ‡å‡†', seg:'éä¸Šè¿°å®¢ç¾¤', tenor:'1å¹´'}
  ];
  defs.forEach(d=>{
    const s=document.createElement('span'); s.className='chip';
    s.dataset.seg=d.seg; s.dataset.tenor=d.tenor;
    if(d.rate) s.dataset.rate=String(d.rate);
    if(d.prod) s.dataset.prod=d.prod; if(d.gb) s.dataset.gb=d.gb; if(d.use) s.dataset.use=d.use;
    s.textContent=d.label; host.appendChild(s);
  });
}
/* å­˜é‡æ˜¾éš */
$('#stock').addEventListener('change', e=>{
  $('#stockRow').style.display = e.target.value==='æ˜¯' ? '' : 'none';
  build();
});
/* Mario é£åŠ¨æ•ˆ */
function toast(txt){ const t=document.createElement('div'); t.className='toast'; t.textContent=txt; document.body.appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),260); },1400); }
function rocket(){ const r=document.createElement('div'); r.className='rocket'; r.textContent='ğŸš€'; document.body.appendChild(r); setTimeout(()=>r.remove(),1600); }
function stars(n){ const em=['âœ¨','â­ï¸','ğŸ’«','ğŸŒŸ','ğŸ‰','ğŸ„']; for(let i=0;i<n;i++){ const s=document.createElement('span'); s.className='burst'; s.textContent=em[i%em.length]; s.style.left=(Math.random()*100)+'vw'; s.style.animationDuration=(1+Math.random()*1.2)+'s'; document.body.appendChild(s); setTimeout(()=>s.remove(),1800); } }

/* é˜ˆå€¼è¡¨ï¼ˆä¸å¯è§ï¼Œä»…ç”¨äºåˆ¤æ–­å±‚çº§ï¼‰ */
let THRESH = {
  "6ä¸ªæœˆ":{"å›½ä¼/æ€»æˆ˜/å°å•†":2.28,"ç§‘æŠ€/ç»¿è‰²":2.28,"æ™®æƒ ":2.28,"éä¸Šè¿°å®¢ç¾¤":2.28},
  "1å¹´":{"å›½ä¼/æ€»æˆ˜/å°å•†":2.31,"ç§‘æŠ€/ç»¿è‰²":2.50,"æ™®æƒ ":2.60,"éä¸Šè¿°å®¢ç¾¤":2.70},
  "2å¹´":{"å›½ä¼/æ€»æˆ˜/å°å•†":2.44,"ç§‘æŠ€/ç»¿è‰²":2.50,"æ™®æƒ ":2.60,"éä¸Šè¿°å®¢ç¾¤":2.70},
  "3å¹´":{"å›½ä¼/æ€»æˆ˜/å°å•†":2.54,"ç§‘æŠ€/ç»¿è‰²":2.64,"æ™®æƒ ":2.54,"éä¸Šè¿°å®¢ç¾¤":2.70},
  "4å¹´":{"å›½ä¼/æ€»æˆ˜/å°å•†":2.63,"ç§‘æŠ€/ç»¿è‰²":2.63,"æ™®æƒ ":2.63,"éä¸Šè¿°å®¢ç¾¤":2.70}
};
/* å®¢ç¾¤è¯­æ–™ï¼ˆæŒ‰ç»„æ‹¼æ¥ï¼Œä¸ä¹±å¥—ï¼‰ */
let SEG_TEXT = {
  "å›½ä¼/æ€»æˆ˜/å°å•†":[
    "è‚¡ä¸œèƒŒæ™¯ç¨³å¥ï¼Œæ²»ç†ç»“æ„æ¸…æ™°ï¼Œä¸»è¦ç»è¥æŒ‡æ ‡ç¨³å®šã€‚",
    "ä¸æˆ‘è¡Œåˆä½œæŒç»­ï¼Œè´¦æˆ·äº¤æ˜“æ­£å¸¸ï¼Œç»“ç®—ç•™å­˜åº¦è¾ƒé«˜ã€‚"
  ],
  "ç§‘æŠ€/ç»¿è‰²":[
    "é€šè¿‡é«˜æ–°/ä¸“ç²¾ç‰¹æ–°/ç»¿è‰²ç›¸å…³èµ„è´¨è®¤å®šï¼Œç¬¦åˆæ”¿ç­–å¯¼å‘ã€‚",
    "ä¸šåŠ¡æ¨¡å¼è½»èµ„äº§ã€å›æ¬¾èŠ‚å¥æ˜ç¡®ï¼Œèèµ„éœ€æ±‚ä¸äº§é”€åŒ¹é…ã€‚"
  ],
  "æ™®æƒ ":[
    "ç¬¦åˆæ™®æƒ å°å¾®å£å¾„ï¼Œç»è¥åœºæ™¯çœŸå®ï¼Œä¸»è¥æ”¶å…¥ç¨³å®šã€‚",
    "å›æ¬¾è·¯å¾„æ¸…æ™°ï¼Œèµ°è´¦è§„èŒƒï¼Œè¿‘ä¸¤å¹´æ— é‡å¤§ä¸è‰¯ã€‚"
  ],
  "éä¸Šè¿°å®¢ç¾¤":[
    "ä¸šåŠ¡æ¨¡å¼æ¸…æ™°ã€å®¢æˆ·åŸºç¡€ç¨³å›ºï¼Œä¸»è¦æ”¶å…¥æ¥æºç¨³å®šã€‚",
    "èµ„é‡‘æ”¶ä»˜è·¯å¾„æ˜ç¡®ï¼Œå¼‚å¸¸äº¤æ˜“æ’æŸ¥æœªè§å¼‚å¸¸ã€‚"
  ]
};
/* å¯é€‰ï¼šå¤–éƒ¨ phrases.json è¦†ç›–é˜ˆå€¼/è¯­æ–™/é»˜è®¤é¡¹ */
async function loadPhrasesIfAny(){
  try{
    const r = await fetch('phrases.json',{cache:'no-store'});
    if(!r.ok) return;
    const j = await r.json();
    if(j.THRESH) Object.assign(THRESH, j.THRESH);
    if(j.threshold){
      // å…¼å®¹ 6M/1Y/.. â†’ ä¸­æ–‡
      const map = { '6M':'6ä¸ªæœˆ','1Y':'1å¹´','2Y':'2å¹´','3Y':'3å¹´','4Y':'4å¹´' };
      Object.entries(j.threshold).forEach(([k,v])=>{ if(map[k]) THRESH[map[k]] = v; });
    }
    if(j.SEG_TEXT) Object.assign(SEG_TEXT, j.SEG_TEXT);
    if(j.seg){
      // åˆå¹¶æ›´ç»†åˆ†å®¢ç¾¤åˆ°ç°æœ‰å››ç»„ç”¨äºæè¿°
      if(!SEG_TEXT['éä¸Šè¿°å®¢ç¾¤']) SEG_TEXT['éä¸Šè¿°å®¢ç¾¤']=[];
      Object.entries(j.seg).forEach(([k,txt])=>{ SEG_TEXT['éä¸Šè¿°å®¢ç¾¤'].push(String(txt)); });
    }
    // UI é»˜è®¤
    if(j.uiDefaults){
      if(j.uiDefaults.branch) $('#branch').value=j.uiDefaults.branch;
      if(j.uiDefaults.dept)   $('#dept').value=j.uiDefaults.dept;
    }
    // åˆ—è¡¨å¡«å……
    if(Array.isArray(j.products)){
      const host = document.getElementById('prodChips'); host.innerHTML='';
      j.products.forEach(p=>{ const s=document.createElement('span'); s.className='chip'; s.dataset.v=p; s.textContent=p; host.appendChild(s); });
      // é»˜è®¤å‹¾é€‰é¦–é¡¹
      host.firstElementChild?.classList.add('sel');
    }
    if(Array.isArray(j.purposes)){
      const sel=$('#use'); sel.innerHTML=''; j.purposes.forEach(p=>{ const o=document.createElement('option'); o.textContent=p; sel.appendChild(o); });
    }
    if(Array.isArray(j.collateral)){
      const sel=$('#gb'); sel.innerHTML=''; j.collateral.forEach(p=>{ const o=document.createElement('option'); o.textContent=p; sel.appendChild(o); });
    }
    if(j.rate){ if(j.rate.lprDefault) $('#lpr').value=Number(j.rate.lprDefault).toFixed(2); if(j.rate.ftpDefault) $('#ftp').value=Number(j.rate.ftpDefault).toFixed(2); }
    // ç†ç”±åº“
    window._PHRASES_ = j;
    // è¡Œä¸šæ¨¡æ¿
    if(j.industryTemplates){
      window._IND_TPLS = j.industryTemplates;
      const sel = document.getElementById('industry');
      if(sel){ sel.innerHTML=''; Object.keys(j.industryTemplates).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); }); }
    }
  }catch(_){}
}

/* ç”³è¯·äº‹é¡¹å¥ç‰‡ */
function itemsLine(amt,tenor,prods,rate,gb,use,stock,stockRate){
  const p = prods.length? prods.join('ã€') : 'æµåŠ¨èµ„é‡‘è´·æ¬¾';
  const base = `æ‹Ÿæ–°å¢/è°ƒæ•´æˆä¿¡${amt}ä¸‡å…ƒï¼ŒæœŸé™${tenor}ï¼Œå“ç§ä¸º${p}ï¼Œæ‹…ä¿æ–¹å¼ä¸º${gb}ï¼Œç”¨é€”ä¸º${use}ï¼Œæ‹Ÿæ‰§è¡Œåˆ©ç‡${rate.toFixed(2)}%ã€‚`;
  if(stock==='æ˜¯' && !isNaN(stockRate)) return `å­˜é‡æ‰§è¡Œåˆ©ç‡${stockRate.toFixed(2)}%ï¼Œ${base}`;
  return base;
}

/* EVA & æ”¶ç›Šè¯­æ–™ï¼ˆä¸¥æ ¼ä¸¤ä½å°æ•°ï¼‰ */
function two(x){ return Number(x).toFixed(2); }
function evaBlock(eva, rr){
  const evaTxt = (eva? two(eva): 'ï¼ˆä»¥ä¸­å°å£å¾„ä¸ºå‡†ï¼‰');
  const rrTxt  = (rr? two(rr): '');
  return `ç»è¥ä¸­å°æµ‹ç®—ï¼šEVA ${evaTxt}${rr?`ï¼›ç»¼åˆé£é™©èµ„äº§æ”¶ç›Šå›æŠ¥ç‡çº¦ ${rrTxt}%`:""}ã€‚`;
}

/* åˆ©ç‡å·®è®¡ç®—ï¼ˆBPï¼‰ä¸æªè¾ */
function bp(a,b){ return Math.round((a - b) * 100); }
function dirWord(diff){ return diff < 0 ? 'ä¸‹æµ®' : 'ä¸Šæµ®'; }

/* å®¡æ‰¹å±‚çº§åˆ¤å®š */
function judgeLayer(rate, tenor, segs){
  const P = window._PHRASES_ || {};
  const floor = (P.threshold && typeof P.threshold.lowerFloor==='number') ? P.threshold.lowerFloor : 2.28;
  const seg = segs[0] || 'æ™®æƒ ';
  const thr = (THRESH[tenor]||{})[seg];
  if(thr==null) return {layer:'åˆ†è¡Œå®¡æ‰¹æƒé™', msg:'æŒ‰åˆ¶åº¦å£å¾„æ ¸å¯¹ã€‚'};
  if(rate >= thr) return {layer:'åˆ†è¡Œå®¡æ‰¹æƒé™', msg:'ç¬¦åˆåˆ†è¡Œå®¡æ‰¹æƒé™ã€‚'};
  if(rate >= floor) return {layer:'æ€»è¡Œæ¡çº¿è´Ÿè´£äººå®¡æ‰¹', msg:'ä½äºåˆ†è¡Œæƒé™ï¼Œæè¯·æ€»è¡Œæ¡çº¿è´Ÿè´£äººå®¡æ‰¹ã€‚'};
  return {layer:'è¶…æ”¿ç­–ä¸‹é™ï¼ˆä¸äºˆå—ç†ï¼‰', msg:`ä½äºå½“å‰åˆ¶åº¦ä¸‹é™ï¼ˆ${floor.toFixed(2)}%ï¼‰ï¼Œä¸åœ¨æœ¬æ‰¹æ¬¡æƒé™èŒƒå›´ã€‚`};
}

/* OCR â€”â€” å¼ºåŒ–ï¼šä»…æŠ“ EVA å€¼ï¼Œæ”¯æŒå…¨è§’ï¼¥ï¼¶ï¼¡ï¼Œä¿è¯ä¸¤ä½å°æ•° */
let ocrLoaded=false;
async function ensureOCR(){
  if(ocrLoaded) return;
  await new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js';
    s.onload=()=>res(); s.onerror=()=>rej(new Error('OCRåº“åŠ è½½å¤±è´¥')); document.head.appendChild(s);
  });
  ocrLoaded=true;
}
async function runOCR(files){
  await ensureOCR();
  let best=null;
  for(const f of files){
    const url=URL.createObjectURL(f);
    try{
      const r = await Tesseract.recognize(url,'chi_sim+eng',{tessedit_char_whitelist:'0123456789.-:%EVA()æ•´ç¬”ä¸šåŠ¡å›æŠ¥ç‡'});
      const text = (r.data.text||'').replace(/\s+/g,' ');
      const patterns = [
        /EVAï¼ˆæ•´ç¬”ä¸šåŠ¡ï¼‰[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i,
        /EVA[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i,
        /ï¼¥ï¼¶ï¼¡[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i
      ];
      for (const re of patterns){
        const m = text.match(re);
        if(m){ const val = parseFloat(m[1]); if(!isNaN(val)){ best = val; break; } }
      }
    }finally{ URL.revokeObjectURL(url); }
  }
  return best;
}
$('#ocrImg').addEventListener('change', ()=>$('#ocrLog').textContent='');
async function ocrClick(){
  const fs = $('#ocrImg').files;
  if(!fs || !fs.length){ alert('è¯·é€‰æ‹©åŒ…å« EVA çš„æˆªå›¾'); return; }
  $('#ocrLog').textContent='è¯†åˆ«ä¸­â€¦';
  try{
    const v = await runOCR(fs);
    if(v!=null){ $('#eva').value=Number(v).toFixed(2); $('#ocrLog').textContent='å·²è¯†åˆ«ï¼šEVA='+Number(v).toFixed(2); }
    else { $('#ocrLog').textContent='æœªè¯†åˆ«åˆ° EVAï¼Œå¯æ‰‹å¡«'; }
  }catch(e){ console.warn(e); $('#ocrLog').textContent='è¯†åˆ«å¤±è´¥ï¼ˆå¯æ‰‹å¡«ï¼‰'; }
}

/* ç”Ÿæˆæ­£æ–‡ */
function build(){
  const branch = $('#branch').value.trim() || 'å¦é—¨åˆ†è¡Œ';
  const dept   = $('#dept').value.trim() || 'ç§‘æŠ€ä¸šåŠ¡éƒ¨';
  const cust   = $('#cust').value.trim() || 'å¦é—¨æŸæŸç§‘æŠ€æœ‰é™å…¬å¸';
  const prods  = $$('#prodChips .chip.sel').map(x=>x.dataset.v);
  const segs   = $$('#segChips .chip.sel').map(x=>x.dataset.v);
  const amt    = parseFloat($('#amt').value)||500;
  const tenor  = $('#tenor').value;
  const rate   = parseFloat($('#rate').value)||2.60;
  const lpr    = parseFloat($('#lpr').value)||3.00;
  const ftp    = parseFloat($('#ftp').value)||1.80;
  const stock  = $('#stock').value;
  const stockRate = parseFloat($('#stockRate').value);
  const gb     = $('#gb').value;
  const use    = $('#use').value;
  const eva    = $('#eva').value.trim();
  const note   = $('#note').value.trim() || 'å·²å®Œæˆå…³è”æ–¹æŸ¥éªŒï¼Œç¡®è®¤å®¢æˆ·ä¸ºéæˆ‘è¡Œå…³è”æ–¹ã€‚æœ¬æ¬¡ä¸ç”³è¯·è‡ªå¾‹åŠ ç‚¹è±å…ã€‚';
  const tone   = $('#tone').value || 'pro';
  const industry = (document.getElementById('industry')?.value)||'é€šç”¨';

  const dL = bp(rate, lpr);
  const dF = bp(rate, ftp);
  const rateLine = `åˆ©ç‡å¯¹æ¯”ï¼šæ‹Ÿæ‰§è¡Œåˆ©ç‡ ${rate.toFixed(2)}%ï¼›è¾ƒä¸€å¹´æœŸLPRï¼ˆ${lpr.toFixed(2)}%ï¼‰${dirWord(dL)}${Math.abs(dL)}BPï¼›ä¸FTPï¼ˆ${ftp.toFixed(2)}%ï¼‰åˆ©å·® ${dF>=0?'+':''}${dF}BPã€‚`;
  const benchLine = `å‚è€ƒåŸºå‡†ï¼šä¸€å¹´æœŸLPR ${lpr.toFixed(2)}%ï¼ŒFTP ${ftp.toFixed(2)}%ã€‚`;

  const J = judgeLayer(rate, tenor, segs);
  const segLine = (segs.length? segs : ['æ™®æƒ ']).flatMap(s=>SEG_TEXT[s]).slice(0, tone==='brief'?1:2).join(' ');
  const apply = itemsLine(amt,tenor,prods,rate,gb,use,stock,stockRate);
  const elements = `${benchLine}\n${rateLine}`;
  const stockExplain = (stock==='æ˜¯' && !isNaN(stockRate)) ? `å­˜é‡è°ƒæ•´è¯´æ˜ï¼šå­˜é‡æ‰§è¡Œåˆ©ç‡ ${stockRate.toFixed(2)}%ï¼Œæ‹Ÿè°ƒæ•´è‡³ ${rate.toFixed(2)}%ï¼Œå˜åŠ¨å¹…åº¦ ${Math.abs(bp(rate, stockRate))}BPã€‚` : '';
  // ç»„åˆç†ç”±ï¼ˆå¯ä»çŸ­è¯­åº“æå–ï¼‰
  const P = window._PHRASES_ || {};
  const IND_TPLS = window._IND_TPLS || {};
  const IT = IND_TPLS[industry] || {};
  const reasons = [];
  const costLine = (P.costByAppr && (P.costByAppr[segs[0]] || P.costByAppr['é»˜è®¤'])) || 'èµ„é‡‘æˆæœ¬ç»æµ‹ç®—å¯æ§ï¼ŒæœŸé™ç»“æ„ä¸é¡¹ç›®ç°é‡‘æµåŒ¹é…ã€‚';
  reasons.push(costLine);
  reasons.push(`èµ„é‡‘ç”¨é€”ä¸ç»è¥åœºæ™¯åŒ¹é…ï¼Œèµ„é‡‘é—­ç¯å¯æ§ï¼›æ‹…ä¿/æŠµæŠ¼æªæ–½æ˜ç¡®ã€‚`);
  if(tone!=='brief') reasons.push(evaBlock(eva, ''));
  if(P.reasons && Array.isArray(P.reasons.contrib)) reasons.push(P.reasons.contrib[0]);
  const reason = reasons.filter(Boolean).slice(0, tone==='brief'?2 : tone==='pro'?3:4).join('\n');

  const title = `${branch}${dept}å…³äº${cust}è´·æ¬¾åˆ©ç‡ä¼˜æƒ çš„ç”³è¯·`;
  const part1 = `ä¸€ã€é¡¹ç›®æ¦‚å†µä¸è¦ç´ \nå®¡æ‰¹æƒé™å£å¾„ï¼š${J.layer}\n${elements}`;
  const part2 = `äºŒã€ç”³è¯·äº‹é¡¹\n${apply}${stockExplain?`\n${stockExplain}`:''}`;
  const part3 = `ä¸‰ã€å®¢æˆ·èµ„è´¨ä¸ç»è¥æƒ…å†µ\n${segLine}${IT.qual?`\n${IT.qual}`:''}`;
  let measuresArr = (P.reasons && Array.isArray(P.reasons.measures)) ? P.reasons.measures.slice() : [];
  if(Array.isArray(IT.measures)) measuresArr = measuresArr.concat(IT.measures);
  const measures = measuresArr.slice(0, tone==='brief'?2:3).map((x,i)=>`ï¼ˆ${i+1}ï¼‰${x}`).join('\n') || 'ï¼ˆ1ï¼‰ç°é‡‘ç®¡ç†ä¸æ”¶ä»˜ä¼˜åŒ–ï¼›\nï¼ˆ2ï¼‰ä¾›åº”é“¾ååŒï¼›\nï¼ˆ3ï¼‰é£é™©ç‚¹å¯¹å†²å®‰æ’ã€‚';
  const part4 = `å››ã€é…å¥—æªæ–½ä¸ååŒå®‰æ’\n${measures}`;
  const part5 = `äº”ã€æ”¶ç›Šæµ‹ç®—ä¸EVA\n${eva ? `ç»è¥ä¸­å°æµ‹ç®—ï¼šEVA ${two(eva)}ã€‚` : 'EVA ä»¥ä¸­å°å£å¾„ä¸ºå‡†ã€‚'}`;
  const part6 = `å…­ã€ç»¼åˆç†ç”±ä¸å»ºè®®\n${reason}`;
  const part7 = `ä¸ƒã€å…¶ä»–äº‹é¡¹è¯´æ˜\n${note}\n\nè¯·å®¡é˜…æ‰¹å‡†ã€‚`;

  // å¯é€‰ï¼šè¯¦å°½é£æ ¼å¢åŠ åˆè§„æ ¸å¯¹
  let full = `${title}\n\n${part1}\n\n${part2}\n\n${part3}\n\n${part4}\n\n${part5}\n\n${part6}\n\n${part7}`;
  const checklist = (window._PHRASES_ && Array.isArray(window._PHRASES_.complianceChecklist)) ? window._PHRASES_.complianceChecklist : null;
  if(tone==='full' && checklist){
    const list = checklist.map((x,i)=>`ï¼ˆ${i+1}ï¼‰${x}`).join('\n');
    full += `\n\nå…«ã€é£é™©æ§åˆ¶ä¸åˆè§„æ ¸å¯¹\n${list}`;
    if(Array.isArray(IT.risk) && IT.risk.length){
      const risk = IT.risk.map((x,i)=>`ï¼ˆ${i+1}ï¼‰${x}`).join('\n');
      full += `\n\nä¹ã€è¡Œä¸šè¦ç‚¹ä¸é£é™©æç¤º\n${risk}`;
    }
  }
  $('#out').textContent = full;
  // æ‘˜è¦
  const summary = [
    `å®¢æˆ·ï¼š${cust}`,
    `é‡‘é¢ä¸æœŸé™ï¼š${amt}ä¸‡å…ƒï¼Œ${tenor}`,
    `åˆ©ç‡è¦ç´ ï¼šæ‰§è¡Œ ${rate.toFixed(2)}%ï¼›è¾ƒLPR ${dL>=0?'+':''}${dL}BPï¼Œä¸FTP ${dF>=0?'+':''}${dF}BP`,
    `å®¡æ‰¹å£å¾„ï¼š${J.layer}`,
    `å“ç§/ç”¨é€”/æ‹…ä¿ï¼š${(prods[0]||'æµåŠ¨èµ„é‡‘è´·æ¬¾')} / ${use} / ${gb}`,
    stockExplain? stockExplain : null,
    IT.qual? `è¡Œä¸šæ¦‚å†µï¼š${IT.qual}` : null
  ].filter(Boolean).join('\n- ');
  document.getElementById('summaryOut').textContent = summary ? ('- '+summary) : '';
  $('#appr').value = J.layer;
  $('#log').textContent='å·²ç”Ÿæˆé¢„è§ˆ';
  // é¡¶éƒ¨å®¡æ‰¹å¾½ç« 
  const badge=$('#apprBadge'); const bt=$('#apprBadgeText');
  if(bt) bt.textContent = J.layer;
  if(badge){ badge.classList.remove('ok','warn','err');
    if(J.layer.startsWith('åˆ†è¡Œ')) badge.classList.add('ok');
    else if(J.layer.startsWith('æ€»è¡Œ')) badge.classList.add('warn');
    else badge.classList.add('err');
  }
  // æ™ºèƒ½æç¤º
  const hints=$('#smartHints'); if(hints){
    hints.innerHTML='';
    const h1=document.createElement('div'); h1.className='hint'; h1.textContent = `å®¡æ‰¹åˆ¤æ–­ï¼š${J.msg}`;
    const h2=document.createElement('div'); h2.className='hint'; h2.textContent = `åˆ©å·®(LPR)ï¼š${dL>=0?'+':''}${dL}BPï¼›åˆ©å·®(FTP)ï¼š${dF>=0?'+':''}${dF}BP`;
    const h3=document.createElement('div'); h3.className='hint'; h3.textContent = 'åˆè§„æç¤ºï¼šå·²é‡‡ç”¨è§„èŒƒè¡¨è¿°ï¼Œé¿å…ä¸å½“å¼•å¯¼æ€§æªè¾ã€‚';
    hints.appendChild(h1); hints.appendChild(h2); hints.appendChild(h3);
  }
  // å»ºè®®åˆ©ç‡æç¤º
  const seg = segs[0] || 'æ™®æƒ ';
  const thr = (THRESH[tenor]||{})[seg];
  const hint = document.getElementById('rateHint');
  if(hint){ hint.textContent = (typeof thr==='number') ? `å»ºè®®ï¼š${thr.toFixed(2)}%ï¼ˆ${tenor}Â·${seg}ï¼‰` : 'å»ºè®®ï¼šâ€”'; }
  // è¡Œä¸šåœºæ™¯æç¤º
  if(IT && IT.scenes){
    const hs = document.createElement('div'); hs.className='hint';
    const s = IT.scenes; // å…è®¸å­—ç¬¦ä¸²æˆ–å¯¹è±¡
    if(typeof s==='string') hs.textContent = `è¡Œä¸šå»ºè®®ï¼š${s}`;
    else hs.textContent = `è¡Œä¸šå»ºè®®ï¼š${s.prod||'â€”'} / ${s.tenor||'â€”'} / ${s.use||'â€”'}`;
    const hintsBox=$('#smartHints'); if(hintsBox) hintsBox.appendChild(hs);
  }
}
/* å¤åˆ¶ */
async function copyTarget(sel){
  const txt = document.querySelector(sel)?.textContent || '';
  if(!txt.trim()){ toast('è¯·å…ˆâ€œæ›´æ–°é¢„è§ˆâ€'); return; }
  try{ await navigator.clipboard.writeText(txt); }catch(_){
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
  }
  toast('âœ”ï¸ ä½œè€…ç‰›é€¼ Â· å·²å¤åˆ¶'); rocket(); stars(28);
}
/* åŠ è½½ docxï¼ˆæœ¬åœ°/ä¸¤çº§CDNå›é€€ï¼‰ */
async function ensureDocx(){
  if(window.docx) return;
  async function load(src){
    await new Promise((res,rej)=>{
      const s=document.createElement('script'); s.src=src; s.onload=()=>res(); s.onerror=()=>rej(); document.head.appendChild(s);
    });
  }
  const candidates = [
    './docx.min.js','../docx.min.js','../../docx.min.js','/docx.min.js',
    'https://unpkg.com/docx@8.5.0/build/index.js',
    'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js'
  ];
  for(const c of candidates){ try{ await load(c); if(window.docx) return; }catch(_){} }
  throw new Error('æœªèƒ½åŠ è½½ docx åº“ï¼ˆç¦»çº¿ç¯å¢ƒä¸‹ä»…æ”¯æŒâ€œä¸€é”®å¤åˆ¶â€ï¼‰');
}
/* ç”Ÿæˆ DOCXï¼šæ‘˜è¦+æ­£æ–‡+EVAæˆªå›¾ */
async function buildDocx(){
  const txt = $('#out').textContent || '';
  if(!txt.trim()){ toast('è¯·å…ˆâ€œæ›´æ–°é¢„è§ˆâ€'); return; }
  toast('â³ æ­£åœ¨ç”Ÿæˆâ€¦'); rocket();
  try{
    await ensureDocx();
  }catch(e){
    throw e;
  }
  const {Document,Packer,Paragraph,TextRun,HeadingLevel,AlignmentType,ImageRun,PageBreak,PageOrientation} = window.docx;

  function p(text){ return new Paragraph({ children:[ new TextRun({ text, font:'SF Pro Text' }) ], spacing:{ after:160 } }); }
  function h2(text){ return new Paragraph({ text, heading:HeadingLevel.HEADING_2, spacing:{ after:120 } }); }
  function title(text){ return new Paragraph({ children:[ new TextRun({ text, bold:true, size:28, font:'SF Pro Text' }) ], alignment:AlignmentType.CENTER, spacing:{ after:240 } }); }

  const summary = $('#summaryOut').textContent || '';
  const full    = txt;
  const body = [];
  const titleLine = (full.split('\n')[0]||'').trim();
  if(titleLine) body.push(title(titleLine));
  body.push(h2('OA æ‘˜è¦'));
  summary.split(/\n/).forEach(line=> body.push(p(line)));
  body.push(new Paragraph({ children:[ new PageBreak() ] }));
  full.split(/\n/).forEach(s=>{
    if(/^([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€)/.test(s.trim())) body.push(h2(s)); else body.push(p(s));
  });

  const imgs = $('#ocrImg').files || [];
  for (let i=0;i<imgs.length;i++){
    const ab = await imgs[i].arrayBuffer();
    body.push(new Paragraph({ spacing:{ after:100 } }));
    body.push(new Paragraph({ children:[ new TextRun({ text:`EVAæˆªå›¾ ${i+1}`, italics:true, color:'666666' }) ]}));
    body.push(new Paragraph({ children:[ new ImageRun({ data:new Uint8Array(ab), transformation:{ width:540, height: (540*4/3) } }) ]}));
  }

  const doc = new Document({
    sections:[{
      properties:{
        page:{ margin:{ top:720, right:720, bottom:720, left:720 }, size:{ orientation:PageOrientation.PORTRAIT } }
      },
      children: body
    }]
  });
  const blob = await Packer.toBlob(doc);
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  const ds = new Date().toISOString().slice(0,10).replace(/-/g,'');
  a.download = 'åˆ©ç‡ä¼˜æƒ ç­¾æŠ¥_'+ds+'.docx'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},1200);
  toast('âœ”ï¸ ä½œè€…ç‰›é€¼ Â· å·²ç”Ÿæˆ DOCX'); stars(18);
}

async function buildWordHtmlDoc(){
  const summary = $('#summaryOut').innerText || '';
  const full = $('#out').innerText || '';
  const files = Array.from($('#ocrImg').files || []);
  async function toDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }
  const dataUrls = await Promise.all(files.map(toDataURL));
  const safe = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const imgs = dataUrls.map((src,i)=>`<p><em>EVAæˆªå›¾ ${i+1}</em></p><p><img src="${src}" style="max-width:700px"/></p>`).join('\n');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>åˆ©ç‡ä¼˜æƒ ç­¾æŠ¥</title></head><body>
  <h2>OA æ‘˜è¦</h2><pre>${safe(summary)}</pre>
  <h2>æ­£æ–‡</h2><pre>${safe(full)}</pre>
  ${imgs}
  </body></html>`;
  const blob = new Blob([html], {type:'application/msword'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  const ds = new Date().toISOString().slice(0,10).replace(/-/g,'');
  a.download = 'åˆ©ç‡ä¼˜æƒ ç­¾æŠ¥_'+ds+'.doc'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},1200);
  toast('âœ”ï¸ å·²ç”Ÿæˆ Wordï¼ˆHTML å†…åµŒï¼‰'); stars(12);
}

async function buildWord(){
  try{ await buildDocx(); }
  catch(e){ console.warn('docx å¤±è´¥ï¼Œè½¬ä¸º HTML .doc', e); await buildWordHtmlDoc(); }
}

/* ä½œè€…å¼¹çª—ï¼šä¸è·³è½¬é‚®ç®±ï¼Œä»…æç¤º */
const cheerModal = $('#cheerModal');
$('#btnCheer').onclick = ()=>{ cheerModal.classList.add('show'); };
$('#cheerClose').onclick = ()=>{ cheerModal.classList.remove('show'); };
cheerModal.addEventListener('click', (e)=>{ if(e.target===cheerModal) cheerModal.classList.remove('show'); });

/* äº‹ä»¶ */
$('#btnBuild').onclick = build;
$('#btnCopy').onclick  = ()=>copyTarget('#out');
document.getElementById('btnCopySummary').onclick = ()=>copyTarget('#summaryOut');
$('#btnDocx').onclick  = buildWord;
/* ç§»åŠ¨ç«¯é•¿æŒ‰é¢„è§ˆæ¡†å¤åˆ¶ */
(function(){
  let pressTimer=null;
  const target = document.getElementById('out');
  if(!target) return;
  const start = () => { pressTimer = setTimeout(()=>copyTarget('#out'), 550); };
  const cancel = () => { if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } };
  target.addEventListener('touchstart', start, {passive:true});
  target.addEventListener('touchend', cancel);
  target.addEventListener('touchmove', cancel);
  target.addEventListener('mousedown', start);
  ['mouseup','mouseleave'].forEach(ev=>target.addEventListener(ev, cancel));
})();
document.getElementById('ocrImg').insertAdjacentHTML('afterend','<div style="margin-top:8px"><button class="btn badge sky" id="btnOcr">è¯†åˆ«EVA</button></div>');
document.body.addEventListener('click', (e)=>{ if(e.target && e.target.id==='btnOcr') ocrClick(); });

// ä¸€é”®åº”ç”¨å»ºè®®åˆ©ç‡
document.addEventListener('click',(e)=>{
  if(e.target && e.target.id==='applySuggest'){
    const segs   = $$('#segChips .chip.sel').map(x=>x.dataset.v);
    const tenor  = $('#tenor').value;
    const seg    = segs[0] || 'æ™®æƒ ';
    const thr    = (THRESH[tenor]||{})[seg];
    if(typeof thr==='number'){ $('#rate').value=thr.toFixed(2); build(); toast('å·²åº”ç”¨å»ºè®®åˆ©ç‡'); }
    else { toast('æš‚æ— å»ºè®®å€¼ï¼Œè¯·æ‰‹åŠ¨å¡«å†™'); }
  }
});

/* åˆå§‹ï¼šå¯é€‰ phrases.json â†’ build */
loadPhrasesIfAny().finally(()=>{ buildPresets(); build(); });
</script>
</body>
</html>
