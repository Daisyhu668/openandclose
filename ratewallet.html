<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>利率优惠签报 · 智能生成器</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
:root{
  --ink:#0b1220; --muted:#667085; --line:#e6e9ef;
  --mario-red:#e11d48; --sky:#38bdf8; --coin:#f59e0b; --green:#10b981;
  --paper:rgba(255,255,255,.9); --radius:18px;
  --shadow:0 14px 34px rgba(2,6,23,.12), 0 2px 8px rgba(2,6,23,.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;color:var(--ink);
  font:15.5px/1.6 -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Hiragino Sans GB",Segoe UI,Roboto,Helvetica,Arial}
.bg{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg,#e0f2fe 0%, #f0f9ff 40%, #fff 100%)}
.bg::before{content:"";position:absolute;inset:-8% -8%;background-size:cover;background-position:center;filter:blur(16px) opacity(.25)}
.wrap{max-width:1080px;margin:0 auto;padding:22px 16px 120px}
header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.logo{width:42px;height:42px;border-radius:12px;background:
  radial-gradient(40% 40% at 30% 30%,#fff,transparent 70%),
  conic-gradient(from 200deg,var(--mario-red),#ef4444 30%,#fb7185 60%,var(--mario-red));
  box-shadow:0 10px 26px rgba(225,29,72,.28),0 2px 8px rgba(16,24,40,.08)}
h1{margin:0;font-weight:800;font-size:clamp(20px,2.6vw,28px);letter-spacing:.2px}
.sub{color:var(--muted);font-size:13px;margin-top:2px}

.card{background:var(--paper);backdrop-filter:saturate(150%) blur(10px);
  border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.grid2{display:grid;grid-template-columns:1.08fr .92fr;gap:14px}
.row{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:center;margin:10px 0}
label{color:#475569}
input[type=text],input[type=number],select,textarea{
  width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;color:var(--ink);
  padding:10px 12px;outline:none;transition:border .15s,box-shadow .15s}
input:focus,select:focus,textarea:focus{border-color:#bae6fd;box-shadow:0 0 0 5px rgba(56,189,248,.18)}
textarea{min-height:120px}

.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{border:2px solid #e2e8f0;border-radius:14px;padding:8px 14px;background:linear-gradient(180deg,#fff,#f8fafc);
  color:#0b1220;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
.chip:hover{transform:translateY(-1px)}
.chip.sel{background:linear-gradient(180deg,#fef3c7,#fde68a); border-color:#f59e0b; box-shadow:0 6px 14px rgba(245,158,11,.25)}

.badge{border-radius:999px;padding:7px 12px;font-weight:700}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
.pill.ok{background:linear-gradient(180deg,#ecfeff,#dbeafe);border-color:#bfdbfe;color:#1e3a8a}
.pill.warn{background:linear-gradient(180deg,#fff7ed,#ffedd5);border-color:#fed7aa;color:#7c2d12}
.pill.err{background:linear-gradient(180deg,#fef2f2,#fee2e2);border-color:#fecaca;color:#7f1d1d}
.btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;border:none;border-radius:14px;padding:12px 16px;color:#fff;
  background:linear-gradient(90deg,var(--mario-red) 0%, var(--coin) 100%);box-shadow:0 10px 24px rgba(225,29,72,.28);cursor:pointer;font-weight:800;letter-spacing:.2px}
.btn:active{transform:translateY(1px)}
.btn.sky{background:linear-gradient(90deg,#0ea5e9, #22d3ee)}
.btn.ghost{background:#f3f5fb;color:#1f2a44;border:1px solid var(--line);box-shadow:none}
.dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:rgba(255,255,255,.86);
  backdrop-filter:saturate(150%) blur(10px);border-top:1px solid var(--line)}
.dock-inner{max-width:1080px;margin:0 auto;padding:12px 16px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
.log{margin-left:auto;color:var(--muted);font-size:12.5px}
#out{white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:12px;border-radius:12px;min-height:160px}
.hints{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.hint{font-size:12px;color:#475569;padding:6px 10px;border:1px dashed #e2e8f0;border-radius:10px;background:#fff}
.subtle{font-size:12px;color:#64748b}
.titlebar{display:flex;align-items:center;gap:8px}
.titlebar .coin{filter:drop-shadow(0 6px 10px rgba(245,158,11,.35))}

/* Mario-lite 动效 */
@keyframes jump { 0%{transform:translateY(0)} 40%{transform:translateY(-8px)} 100%{transform:translateY(0)} }
.jump{animation:jump .28s ease-out}
.rocket{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);font-size:26px;animation:fly 1.5s ease-out forwards;z-index:50}
@keyframes fly{0%{transform:translate(-50%,0) scale(1);opacity:1}100%{transform:translate(-50%,-82vh) scale(1.2);opacity:0}}
.burst{position:fixed;bottom:0;font-size:22px;animation:fall 1.6s ease-out forwards;z-index:45}
@keyframes fall{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-80vh) scale(1.3);opacity:0}}
.toast{position:fixed;left:50%;bottom:88px;transform:translateX(-50%) scale(.96);opacity:0;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:60}
.toast.show{opacity:1;transform:translateX(-50%) scale(1);transition:all .18s ease}

/* 小砖块分隔（Mario） */
.brick{height:10px;background:repeating-linear-gradient(90deg,#f59e0b 0 12px,#d97706 12px 24px);opacity:.2;border-radius:10px;margin:6px 0}

/* 作者弹窗 */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:80}
.modal .panel{background:#fff;border-radius:16px;max-width:460px;width:calc(100% - 40px);padding:18px;box-shadow:var(--shadow)}
.modal .panel .close{position:absolute;right:12px;top:10px;cursor:pointer;color:#64748b}
.modal.show{display:flex}

/* 小屏 */
@media (max-width:860px){.grid2{grid-template-columns:1fr}.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="bg" id="bg"></div>

<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <div class="titlebar">
        <h1>利率优惠签报 · 智能生成器</h1>
        <span id="apprBadge" class="pill ok" title="系统按阈值自动判断">
          <span>审批口径</span>
          <span id="apprBadgeText">分行审批权限</span>
        </span>
        <span class="coin" aria-hidden="true">🪙</span>
      </div>
      <div class="sub">厦门分行科技业务部（默认，可改） · 角色：对公客户经理（20年）</div>
    </div>
  </header>

  <div class="grid2">
    <div class="card">
      <div class="row"><label>分行（默认）</label><input id="branch" type="text" value="厦门分行"></div>
      <div class="row"><label>部门（默认）</label><input id="dept" type="text" value="科技业务部"></div>
      <div class="row"><label>客户名称</label><input id="cust" type="text" placeholder="如：厦门某某科技有限公司"></div>

      <div class="row"><label>审批口径</label>
        <select id="appr">
          <option>分行审批权限</option>
          <option>总行条线负责人审批</option>
          <option>超政策下限（不予受理）</option>
        </select>
      </div>

      <div class="row"><label>场景预设</label>
        <div class="chips" id="presetChips">
          <!-- 动态注入：基于 THRESH 自动生成常用预设 -->
        </div>
      </div>

      <div class="row"><label>输出风格</label>
        <select id="tone">
          <option value="pro">稳健专业（默认）</option>
          <option value="brief">简洁精要</option>
          <option value="full">详尽充分</option>
        </select>
      </div>
      <div class="row"><label>行业</label>
        <select id="industry"><option value="通用">通用</option></select>
      </div>

      <div class="row"><label>授信品种（多选）</label>
        <div class="chips" id="prodChips">
          <span class="chip sel" data-v="流动资金贷款">流动资金贷款</span>
          <span class="chip" data-v="税易贷">税易贷</span>
          <span class="chip" data-v="成长伴侣">成长伴侣</span>
          <span class="chip" data-v="科技贷">科技贷</span>
          <span class="chip" data-v="票据贴现">票据贴现</span>
          <span class="chip" data-v="抵押贷款">抵押贷款</span>
          <span class="chip" data-v="信用贷款">信用贷款</span>
          <span class="chip" data-v="银担合作">银担合作</span>
        </div>
      </div>

      <div class="row"><label>担保方式（单选）</label>
        <select id="gb">
          <option>不动产抵押</option>
          <option>担保公司100%保证</option>
          <option>知识产权质押</option>
          <option>信用</option>
        </select>
      </div>

      <div class="row"><label>贷款用途（单选）</label>
        <select id="use">
          <option>备货/采购</option>
          <option>支付工资</option>
          <option>日常营运支出</option>
          <option>项目周转</option>
        </select>
      </div>

      <div class="row"><label>客群（多选）</label>
        <div class="chips" id="segChips">
          <span class="chip sel" data-v="普惠">普惠</span>
          <span class="chip" data-v="科技/绿色">科技/绿色</span>
          <span class="chip" data-v="国企/总战/台商">国企/总战/台商</span>
          <span class="chip" data-v="非上述客群">非上述客群</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row"><label>金额（万元）</label><input id="amt" type="number" placeholder="如：500" value="500"></div>
      <div class="row"><label>期限</label>
        <select id="tenor">
          <option>1年</option><option>6个月</option><option>2年</option><option>3年</option><option>4年</option>
        </select>
      </div>
      <div class="row"><label>执行利率(%)</label>
        <div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="rate" type="number" step="0.01" value="2.60" style="width:180px">
            <span class="hint" id="rateHint">建议：—</span>
            <button class="btn badge sky" id="applySuggest" type="button">应用建议</button>
          </div>
        </div>
      </div>
      <div class="row"><label>LPR(一年期%)</label><input id="lpr" type="number" step="0.01" value="3.00"></div>
      <div class="row"><label>FTP(%)</label><input id="ftp" type="number" step="0.01" value="1.80"></div>

      <div class="row"><label>是否存量</label>
        <select id="stock">
          <option value="否" selected>否</option>
          <option value="是">是</option>
        </select>
      </div>
      <div class="row" id="stockRow" style="display:none">
        <label>存量利率(%)</label><input id="stockRate" type="number" step="0.01" placeholder="如：3.20">
      </div>

      <div class="row"><label>EVA（可手填）</label><input id="eva" type="text" placeholder="如：13.93"></div>
      <div class="row"><label>OCR 识别 EVA</label>
        <div>
          <input id="ocrImg" type="file" accept="image/*" multiple />
          <div class="small" id="ocrLog">（可选；识别失败不影响）</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row"><label>补充说明（固定两句为主）</label>
      <textarea id="note" placeholder="已完成关联方查验，确认客户为非我行关联方。本次不申请自律加点豁免。"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="row" style="grid-template-columns:1fr"><label style="grid-column:1/-1">预览（双栏输出）</label>
      <div class="hints" id="smartHints"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div class="titlebar" style="justify-content:space-between">
            <div style="font-weight:700">OA 摘要</div>
            <button class="btn badge sky" id="btnCopySummary" type="button">复制摘要</button>
          </div>
          <div id="summaryOut" style="white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:12px;border-radius:12px;min-height:120px"></div>
        </div>
        <div>
          <div class="titlebar" style="justify-content:space-between">
            <div style="font-weight:700">正文（完整）</div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="btnCopy" type="button">复制正文</button>
              <button class="btn ghost" id="btnDocx" type="button">生成 Word（含图片）</button>
            </div>
          </div>
          <div id="out"></div>
        </div>
      </div>
      <div class="subtle">提示：摘要适配 OA 字段，正文用于附件或完整签报。</div>
    </div>
  </div>
</div>

<div class="dock">
  <div class="dock-inner">
    <button class="btn sky" id="btnBuild">更新预览</button>
    <button class="btn" id="btnCopy">复制正文<span class="jump">🍄</span></button>
    <button class="btn ghost" id="btnDocx">生成 Word（含图片）</button>
    <button class="btn ghost" id="btnCheer">我爱作者</button>
    <span class="log" id="log">就绪</span>
  </div>
</div>

<!-- 我爱作者弹窗 -->
<div id="cheerModal" class="modal" style="display:none">
  <div class="panel" style="position:relative">
    <span class="close" id="cheerClose" title="关闭">✖</span>
    <h3 style="margin:0 0 8px 0">我爱作者 · XD.Hu</h3>
    <p class="small">这款签报生成器由作者业余时间打造，目标是：更快、更准、更合规地完成日常 OA。</p>
    <p class="small">如果觉得好用，欢迎夸作者：coolkiy@gmail.com</p>
    <p class="small">感谢支持与建议！</p>
  </div>
</div>

<script>
'use strict';
/* 背景：从本地 bg/ 目录随机一张（你已放好） */
const BG_LIST = ['bg-1.jpg','bg-2.jpg','bg-3.jpg','bg-4.jpg'];
(function setBg(){
  const pick = BG_LIST[Math.floor(Math.random()*BG_LIST.length)];
  const s = document.createElement('style'); s.textContent = `.bg::before{background-image:url("${pick}")}`; document.head.appendChild(s);
})();
/* 简易选择器与芯片交互 */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
document.body.addEventListener('click', e=>{
  const t = e.target;
  if(!(t instanceof HTMLElement) || !t.classList.contains('chip')) return;
  t.classList.toggle('sel'); t.classList.add('jump');
  setTimeout(()=>t.classList.remove('jump'),320);
});
/* 预设场景一键填充 */
function applyPreset(p){
  const {seg='普惠', tenor='1年', rate, prod, gb, use, stock, stockRate} = p||{};
  // 客群
  $$('#segChips .chip').forEach(x=>{ x.classList.toggle('sel', x.dataset.v===seg); });
  // 产品
  const defaultProd = (tenor==='6个月' && prod==null) ? '票据贴现' : (prod||'流动资金贷款');
  $$('#prodChips .chip').forEach(x=>{ x.classList.toggle('sel', x.dataset.v===defaultProd); });
  // 用途与担保
  const useSel=$('#use'); useSel.value = use || (defaultProd==='票据贴现' ? '日常营运支出' : '日常经营周转');
  const gbSel = $('#gb'); gbSel.value = gb || '不动产抵押';
  // 期限与利率
  $('#tenor').value = tenor;
  // 依据阈值建议利率，若提供则使用提供值
  const thr = (THRESH[tenor]||{})[seg];
  const r = (typeof rate==='number') ? rate : (typeof thr==='number' ? thr : 2.60);
  $('#rate').value = Number(r).toFixed(2);
  // 存量
  if(stock==='是'){ $('#stock').value='是'; $('#stockRow').style.display=''; if(stockRate) $('#stockRate').value=Number(stockRate).toFixed(2); }
  else { $('#stock').value='否'; $('#stockRow').style.display='none'; }
  build(); toast('已应用场景预设'); stars(8);
}
document.getElementById('presetChips')?.addEventListener('click', (e)=>{
  const t=e.target; if(!(t instanceof HTMLElement)) return; const data=t.dataset;
  if(!data.seg || !data.tenor) return;
  const payload={ seg:data.seg, tenor:data.tenor };
  if(data.prod) payload.prod=data.prod; if(data.gb) payload.gb=data.gb; if(data.use) payload.use=data.use;
  if(data.rate){ const v=parseFloat(data.rate); if(!isNaN(v)) payload.rate=v; }
  if(data.stock){ payload.stock=data.stock; if(data.stockRate){ const v=parseFloat(data.stockRate); if(!isNaN(v)) payload.stockRate=v; } }
  applyPreset(payload);
});

function buildPresets(){
  const host = document.getElementById('presetChips'); if(!host) return;
  host.innerHTML='';
  const defs = [
    {label:'普惠标准', seg:'普惠', tenor:'1年', prod:'流动资金贷款', gb:'不动产抵押', use:'日常经营周转'},
    {label:'短期贴现', seg:'普惠', tenor:'6个月', prod:'票据贴现', use:'日常营运支出'},
    {label:'科技/绿色标准', seg:'科技/绿色', tenor:'1年', prod:'科技贷', use:'研发投入'},
    {label:'国企/台商标准', seg:'国企/总战/台商', tenor:'1年'},
    {label:'通用标准', seg:'非上述客群', tenor:'1年'}
  ];
  defs.forEach(d=>{
    const s=document.createElement('span'); s.className='chip';
    s.dataset.seg=d.seg; s.dataset.tenor=d.tenor;
    if(d.rate) s.dataset.rate=String(d.rate);
    if(d.prod) s.dataset.prod=d.prod; if(d.gb) s.dataset.gb=d.gb; if(d.use) s.dataset.use=d.use;
    s.textContent=d.label; host.appendChild(s);
  });
}
/* 存量显隐 */
$('#stock').addEventListener('change', e=>{
  $('#stockRow').style.display = e.target.value==='是' ? '' : 'none';
  build();
});
/* Mario 风动效 */
function toast(txt){ const t=document.createElement('div'); t.className='toast'; t.textContent=txt; document.body.appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),260); },1400); }
function rocket(){ const r=document.createElement('div'); r.className='rocket'; r.textContent='🚀'; document.body.appendChild(r); setTimeout(()=>r.remove(),1600); }
function stars(n){ const em=['✨','⭐️','💫','🌟','🎉','🍄']; for(let i=0;i<n;i++){ const s=document.createElement('span'); s.className='burst'; s.textContent=em[i%em.length]; s.style.left=(Math.random()*100)+'vw'; s.style.animationDuration=(1+Math.random()*1.2)+'s'; document.body.appendChild(s); setTimeout(()=>s.remove(),1800); } }

/* 阈值表（不可见，仅用于判断层级） */
let THRESH = {
  "6个月":{"国企/总战/台商":2.28,"科技/绿色":2.28,"普惠":2.28,"非上述客群":2.28},
  "1年":{"国企/总战/台商":2.31,"科技/绿色":2.50,"普惠":2.60,"非上述客群":2.70},
  "2年":{"国企/总战/台商":2.44,"科技/绿色":2.50,"普惠":2.60,"非上述客群":2.70},
  "3年":{"国企/总战/台商":2.54,"科技/绿色":2.64,"普惠":2.54,"非上述客群":2.70},
  "4年":{"国企/总战/台商":2.63,"科技/绿色":2.63,"普惠":2.63,"非上述客群":2.70}
};
/* 客群语料（按组拼接，不乱套） */
let SEG_TEXT = {
  "国企/总战/台商":[
    "股东背景稳健，治理结构清晰，主要经营指标稳定。",
    "与我行合作持续，账户交易正常，结算留存度较高。"
  ],
  "科技/绿色":[
    "通过高新/专精特新/绿色相关资质认定，符合政策导向。",
    "业务模式轻资产、回款节奏明确，融资需求与产销匹配。"
  ],
  "普惠":[
    "符合普惠小微口径，经营场景真实，主营收入稳定。",
    "回款路径清晰，走账规范，近两年无重大不良。"
  ],
  "非上述客群":[
    "业务模式清晰、客户基础稳固，主要收入来源稳定。",
    "资金收付路径明确，异常交易排查未见异常。"
  ]
};
/* 可选：外部 phrases.json 覆盖阈值/语料/默认项 */
async function loadPhrasesIfAny(){
  try{
    const r = await fetch('phrases.json',{cache:'no-store'});
    if(!r.ok) return;
    const j = await r.json();
    if(j.THRESH) Object.assign(THRESH, j.THRESH);
    if(j.threshold){
      // 兼容 6M/1Y/.. → 中文
      const map = { '6M':'6个月','1Y':'1年','2Y':'2年','3Y':'3年','4Y':'4年' };
      Object.entries(j.threshold).forEach(([k,v])=>{ if(map[k]) THRESH[map[k]] = v; });
    }
    if(j.SEG_TEXT) Object.assign(SEG_TEXT, j.SEG_TEXT);
    if(j.seg){
      // 合并更细分客群到现有四组用于描述
      if(!SEG_TEXT['非上述客群']) SEG_TEXT['非上述客群']=[];
      Object.entries(j.seg).forEach(([k,txt])=>{ SEG_TEXT['非上述客群'].push(String(txt)); });
    }
    // UI 默认
    if(j.uiDefaults){
      if(j.uiDefaults.branch) $('#branch').value=j.uiDefaults.branch;
      if(j.uiDefaults.dept)   $('#dept').value=j.uiDefaults.dept;
    }
    // 列表填充
    if(Array.isArray(j.products)){
      const host = document.getElementById('prodChips'); host.innerHTML='';
      j.products.forEach(p=>{ const s=document.createElement('span'); s.className='chip'; s.dataset.v=p; s.textContent=p; host.appendChild(s); });
      // 默认勾选首项
      host.firstElementChild?.classList.add('sel');
    }
    if(Array.isArray(j.purposes)){
      const sel=$('#use'); sel.innerHTML=''; j.purposes.forEach(p=>{ const o=document.createElement('option'); o.textContent=p; sel.appendChild(o); });
    }
    if(Array.isArray(j.collateral)){
      const sel=$('#gb'); sel.innerHTML=''; j.collateral.forEach(p=>{ const o=document.createElement('option'); o.textContent=p; sel.appendChild(o); });
    }
    if(j.rate){ if(j.rate.lprDefault) $('#lpr').value=Number(j.rate.lprDefault).toFixed(2); if(j.rate.ftpDefault) $('#ftp').value=Number(j.rate.ftpDefault).toFixed(2); }
    // 理由库
    window._PHRASES_ = j;
    // 行业模板
    if(j.industryTemplates){
      window._IND_TPLS = j.industryTemplates;
      const sel = document.getElementById('industry');
      if(sel){ sel.innerHTML=''; Object.keys(j.industryTemplates).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); }); }
    }
  }catch(_){}
}

/* 申请事项句片 */
function itemsLine(amt,tenor,prods,rate,gb,use,stock,stockRate){
  const p = prods.length? prods.join('、') : '流动资金贷款';
  const base = `拟新增/调整授信${amt}万元，期限${tenor}，品种为${p}，担保方式为${gb}，用途为${use}，拟执行利率${rate.toFixed(2)}%。`;
  if(stock==='是' && !isNaN(stockRate)) return `存量执行利率${stockRate.toFixed(2)}%，${base}`;
  return base;
}

/* EVA & 收益语料（严格两位小数） */
function two(x){ return Number(x).toFixed(2); }
function evaBlock(eva, rr){
  const evaTxt = (eva? two(eva): '（以中台口径为准）');
  const rrTxt  = (rr? two(rr): '');
  return `经营中台测算：EVA ${evaTxt}${rr?`；综合风险资产收益回报率约 ${rrTxt}%`:""}。`;
}

/* 利率差计算（BP）与措辞 */
function bp(a,b){ return Math.round((a - b) * 100); }
function dirWord(diff){ return diff < 0 ? '下浮' : '上浮'; }

/* 审批层级判定 */
function judgeLayer(rate, tenor, segs){
  const P = window._PHRASES_ || {};
  const floor = (P.threshold && typeof P.threshold.lowerFloor==='number') ? P.threshold.lowerFloor : 2.28;
  const seg = segs[0] || '普惠';
  const thr = (THRESH[tenor]||{})[seg];
  if(thr==null) return {layer:'分行审批权限', msg:'按制度口径核对。'};
  if(rate >= thr) return {layer:'分行审批权限', msg:'符合分行审批权限。'};
  if(rate >= floor) return {layer:'总行条线负责人审批', msg:'低于分行权限，提请总行条线负责人审批。'};
  return {layer:'超政策下限（不予受理）', msg:`低于当前制度下限（${floor.toFixed(2)}%），不在本批次权限范围。`};
}

/* OCR —— 强化：仅抓 EVA 值，支持全角ＥＶＡ，保证两位小数 */
let ocrLoaded=false;
async function ensureOCR(){
  if(ocrLoaded) return;
  await new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js';
    s.onload=()=>res(); s.onerror=()=>rej(new Error('OCR库加载失败')); document.head.appendChild(s);
  });
  ocrLoaded=true;
}
async function runOCR(files){
  await ensureOCR();
  let best=null;
  for(const f of files){
    const url=URL.createObjectURL(f);
    try{
      const r = await Tesseract.recognize(url,'chi_sim+eng',{tessedit_char_whitelist:'0123456789.-:%EVA()整笔业务回报率'});
      const text = (r.data.text||'').replace(/\s+/g,' ');
      const patterns = [
        /EVA（整笔业务）[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i,
        /EVA[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i,
        /ＥＶＡ[^0-9\-]*([+\-]?\d+(?:\.\d+)?)/i
      ];
      for (const re of patterns){
        const m = text.match(re);
        if(m){ const val = parseFloat(m[1]); if(!isNaN(val)){ best = val; break; } }
      }
    }finally{ URL.revokeObjectURL(url); }
  }
  return best;
}
$('#ocrImg').addEventListener('change', ()=>$('#ocrLog').textContent='');
async function ocrClick(){
  const fs = $('#ocrImg').files;
  if(!fs || !fs.length){ alert('请选择包含 EVA 的截图'); return; }
  $('#ocrLog').textContent='识别中…';
  try{
    const v = await runOCR(fs);
    if(v!=null){ $('#eva').value=Number(v).toFixed(2); $('#ocrLog').textContent='已识别：EVA='+Number(v).toFixed(2); }
    else { $('#ocrLog').textContent='未识别到 EVA，可手填'; }
  }catch(e){ console.warn(e); $('#ocrLog').textContent='识别失败（可手填）'; }
}

/* 生成正文 */
function build(){
  const branch = $('#branch').value.trim() || '厦门分行';
  const dept   = $('#dept').value.trim() || '科技业务部';
  const cust   = $('#cust').value.trim() || '厦门某某科技有限公司';
  const prods  = $$('#prodChips .chip.sel').map(x=>x.dataset.v);
  const segs   = $$('#segChips .chip.sel').map(x=>x.dataset.v);
  const amt    = parseFloat($('#amt').value)||500;
  const tenor  = $('#tenor').value;
  const rate   = parseFloat($('#rate').value)||2.60;
  const lpr    = parseFloat($('#lpr').value)||3.00;
  const ftp    = parseFloat($('#ftp').value)||1.80;
  const stock  = $('#stock').value;
  const stockRate = parseFloat($('#stockRate').value);
  const gb     = $('#gb').value;
  const use    = $('#use').value;
  const eva    = $('#eva').value.trim();
  const note   = $('#note').value.trim() || '已完成关联方查验，确认客户为非我行关联方。本次不申请自律加点豁免。';
  const tone   = $('#tone').value || 'pro';
  const industry = (document.getElementById('industry')?.value)||'通用';

  const dL = bp(rate, lpr);
  const dF = bp(rate, ftp);
  const rateLine = `利率对比：拟执行利率 ${rate.toFixed(2)}%；较一年期LPR（${lpr.toFixed(2)}%）${dirWord(dL)}${Math.abs(dL)}BP；与FTP（${ftp.toFixed(2)}%）利差 ${dF>=0?'+':''}${dF}BP。`;
  const benchLine = `参考基准：一年期LPR ${lpr.toFixed(2)}%，FTP ${ftp.toFixed(2)}%。`;

  const J = judgeLayer(rate, tenor, segs);
  const segLine = (segs.length? segs : ['普惠']).flatMap(s=>SEG_TEXT[s]).slice(0, tone==='brief'?1:2).join(' ');
  const apply = itemsLine(amt,tenor,prods,rate,gb,use,stock,stockRate);
  const elements = `${benchLine}\n${rateLine}`;
  const stockExplain = (stock==='是' && !isNaN(stockRate)) ? `存量调整说明：存量执行利率 ${stockRate.toFixed(2)}%，拟调整至 ${rate.toFixed(2)}%，变动幅度 ${Math.abs(bp(rate, stockRate))}BP。` : '';
  // 组合理由（可从短语库提取）
  const P = window._PHRASES_ || {};
  const IND_TPLS = window._IND_TPLS || {};
  const IT = IND_TPLS[industry] || {};
  const reasons = [];
  const costLine = (P.costByAppr && (P.costByAppr[segs[0]] || P.costByAppr['默认'])) || '资金成本经测算可控，期限结构与项目现金流匹配。';
  reasons.push(costLine);
  reasons.push(`资金用途与经营场景匹配，资金闭环可控；担保/抵押措施明确。`);
  if(tone!=='brief') reasons.push(evaBlock(eva, ''));
  if(P.reasons && Array.isArray(P.reasons.contrib)) reasons.push(P.reasons.contrib[0]);
  const reason = reasons.filter(Boolean).slice(0, tone==='brief'?2 : tone==='pro'?3:4).join('\n');

  const title = `${branch}${dept}关于${cust}贷款利率优惠的申请`;
  const part1 = `一、项目概况与要素\n审批权限口径：${J.layer}\n${elements}`;
  const part2 = `二、申请事项\n${apply}${stockExplain?`\n${stockExplain}`:''}`;
  const part3 = `三、客户资质与经营情况\n${segLine}${IT.qual?`\n${IT.qual}`:''}`;
  let measuresArr = (P.reasons && Array.isArray(P.reasons.measures)) ? P.reasons.measures.slice() : [];
  if(Array.isArray(IT.measures)) measuresArr = measuresArr.concat(IT.measures);
  const measures = measuresArr.slice(0, tone==='brief'?2:3).map((x,i)=>`（${i+1}）${x}`).join('\n') || '（1）现金管理与收付优化；\n（2）供应链协同；\n（3）风险点对冲安排。';
  const part4 = `四、配套措施与协同安排\n${measures}`;
  const part5 = `五、收益测算与EVA\n${eva ? `经营中台测算：EVA ${two(eva)}。` : 'EVA 以中台口径为准。'}`;
  const part6 = `六、综合理由与建议\n${reason}`;
  const part7 = `七、其他事项说明\n${note}\n\n请审阅批准。`;

  // 可选：详尽风格增加合规核对
  let full = `${title}\n\n${part1}\n\n${part2}\n\n${part3}\n\n${part4}\n\n${part5}\n\n${part6}\n\n${part7}`;
  const checklist = (window._PHRASES_ && Array.isArray(window._PHRASES_.complianceChecklist)) ? window._PHRASES_.complianceChecklist : null;
  if(tone==='full' && checklist){
    const list = checklist.map((x,i)=>`（${i+1}）${x}`).join('\n');
    full += `\n\n八、风险控制与合规核对\n${list}`;
    if(Array.isArray(IT.risk) && IT.risk.length){
      const risk = IT.risk.map((x,i)=>`（${i+1}）${x}`).join('\n');
      full += `\n\n九、行业要点与风险提示\n${risk}`;
    }
  }
  $('#out').textContent = full;
  // 摘要
  const summary = [
    `客户：${cust}`,
    `金额与期限：${amt}万元，${tenor}`,
    `利率要素：执行 ${rate.toFixed(2)}%；较LPR ${dL>=0?'+':''}${dL}BP，与FTP ${dF>=0?'+':''}${dF}BP`,
    `审批口径：${J.layer}`,
    `品种/用途/担保：${(prods[0]||'流动资金贷款')} / ${use} / ${gb}`,
    stockExplain? stockExplain : null,
    IT.qual? `行业概况：${IT.qual}` : null
  ].filter(Boolean).join('\n- ');
  document.getElementById('summaryOut').textContent = summary ? ('- '+summary) : '';
  $('#appr').value = J.layer;
  $('#log').textContent='已生成预览';
  // 顶部审批徽章
  const badge=$('#apprBadge'); const bt=$('#apprBadgeText');
  if(bt) bt.textContent = J.layer;
  if(badge){ badge.classList.remove('ok','warn','err');
    if(J.layer.startsWith('分行')) badge.classList.add('ok');
    else if(J.layer.startsWith('总行')) badge.classList.add('warn');
    else badge.classList.add('err');
  }
  // 智能提示
  const hints=$('#smartHints'); if(hints){
    hints.innerHTML='';
    const h1=document.createElement('div'); h1.className='hint'; h1.textContent = `审批判断：${J.msg}`;
    const h2=document.createElement('div'); h2.className='hint'; h2.textContent = `利差(LPR)：${dL>=0?'+':''}${dL}BP；利差(FTP)：${dF>=0?'+':''}${dF}BP`;
    const h3=document.createElement('div'); h3.className='hint'; h3.textContent = '合规提示：已采用规范表述，避免不当引导性措辞。';
    hints.appendChild(h1); hints.appendChild(h2); hints.appendChild(h3);
  }
  // 建议利率提示
  const seg = segs[0] || '普惠';
  const thr = (THRESH[tenor]||{})[seg];
  const hint = document.getElementById('rateHint');
  if(hint){ hint.textContent = (typeof thr==='number') ? `建议：${thr.toFixed(2)}%（${tenor}·${seg}）` : '建议：—'; }
  // 行业场景提示
  if(IT && IT.scenes){
    const hs = document.createElement('div'); hs.className='hint';
    const s = IT.scenes; // 允许字符串或对象
    if(typeof s==='string') hs.textContent = `行业建议：${s}`;
    else hs.textContent = `行业建议：${s.prod||'—'} / ${s.tenor||'—'} / ${s.use||'—'}`;
    const hintsBox=$('#smartHints'); if(hintsBox) hintsBox.appendChild(hs);
  }
}
/* 复制 */
async function copyTarget(sel){
  const txt = document.querySelector(sel)?.textContent || '';
  if(!txt.trim()){ toast('请先“更新预览”'); return; }
  try{ await navigator.clipboard.writeText(txt); }catch(_){
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
  }
  toast('✔︎ 作者牛逼 · 已复制'); rocket(); stars(28);
}
/* 加载 docx（本地/两级CDN回退） */
async function ensureDocx(){
  if(window.docx) return;
  async function load(src){
    await new Promise((res,rej)=>{
      const s=document.createElement('script'); s.src=src; s.onload=()=>res(); s.onerror=()=>rej(); document.head.appendChild(s);
    });
  }
  const candidates = [
    './docx.min.js','../docx.min.js','../../docx.min.js','/docx.min.js',
    'https://unpkg.com/docx@8.5.0/build/index.js',
    'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js'
  ];
  for(const c of candidates){ try{ await load(c); if(window.docx) return; }catch(_){} }
  throw new Error('未能加载 docx 库（离线环境下仅支持“一键复制”）');
}
/* 生成 DOCX：摘要+正文+EVA截图 */
async function buildDocx(){
  const txt = $('#out').textContent || '';
  if(!txt.trim()){ toast('请先“更新预览”'); return; }
  toast('⏳ 正在生成…'); rocket();
  try{
    await ensureDocx();
  }catch(e){
    throw e;
  }
  const {Document,Packer,Paragraph,TextRun,HeadingLevel,AlignmentType,ImageRun,PageBreak,PageOrientation} = window.docx;

  function p(text){ return new Paragraph({ children:[ new TextRun({ text, font:'SF Pro Text' }) ], spacing:{ after:160 } }); }
  function h2(text){ return new Paragraph({ text, heading:HeadingLevel.HEADING_2, spacing:{ after:120 } }); }
  function title(text){ return new Paragraph({ children:[ new TextRun({ text, bold:true, size:28, font:'SF Pro Text' }) ], alignment:AlignmentType.CENTER, spacing:{ after:240 } }); }

  const summary = $('#summaryOut').textContent || '';
  const full    = txt;
  const body = [];
  const titleLine = (full.split('\n')[0]||'').trim();
  if(titleLine) body.push(title(titleLine));
  body.push(h2('OA 摘要'));
  summary.split(/\n/).forEach(line=> body.push(p(line)));
  body.push(new Paragraph({ children:[ new PageBreak() ] }));
  full.split(/\n/).forEach(s=>{
    if(/^([一二三四五六七八九十]+、)/.test(s.trim())) body.push(h2(s)); else body.push(p(s));
  });

  const imgs = $('#ocrImg').files || [];
  for (let i=0;i<imgs.length;i++){
    const ab = await imgs[i].arrayBuffer();
    body.push(new Paragraph({ spacing:{ after:100 } }));
    body.push(new Paragraph({ children:[ new TextRun({ text:`EVA截图 ${i+1}`, italics:true, color:'666666' }) ]}));
    body.push(new Paragraph({ children:[ new ImageRun({ data:new Uint8Array(ab), transformation:{ width:540, height: (540*4/3) } }) ]}));
  }

  const doc = new Document({
    sections:[{
      properties:{
        page:{ margin:{ top:720, right:720, bottom:720, left:720 }, size:{ orientation:PageOrientation.PORTRAIT } }
      },
      children: body
    }]
  });
  const blob = await Packer.toBlob(doc);
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  const ds = new Date().toISOString().slice(0,10).replace(/-/g,'');
  a.download = '利率优惠签报_'+ds+'.docx'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},1200);
  toast('✔︎ 作者牛逼 · 已生成 DOCX'); stars(18);
}

async function buildWordHtmlDoc(){
  const summary = $('#summaryOut').innerText || '';
  const full = $('#out').innerText || '';
  const files = Array.from($('#ocrImg').files || []);
  async function toDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }
  const dataUrls = await Promise.all(files.map(toDataURL));
  const safe = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const imgs = dataUrls.map((src,i)=>`<p><em>EVA截图 ${i+1}</em></p><p><img src="${src}" style="max-width:700px"/></p>`).join('\n');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>利率优惠签报</title></head><body>
  <h2>OA 摘要</h2><pre>${safe(summary)}</pre>
  <h2>正文</h2><pre>${safe(full)}</pre>
  ${imgs}
  </body></html>`;
  const blob = new Blob([html], {type:'application/msword'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  const ds = new Date().toISOString().slice(0,10).replace(/-/g,'');
  a.download = '利率优惠签报_'+ds+'.doc'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},1200);
  toast('✔︎ 已生成 Word（HTML 内嵌）'); stars(12);
}

async function buildWord(){
  try{ await buildDocx(); }
  catch(e){ console.warn('docx 失败，转为 HTML .doc', e); await buildWordHtmlDoc(); }
}

/* 作者弹窗：不跳转邮箱，仅提示 */
const cheerModal = $('#cheerModal');
$('#btnCheer').onclick = ()=>{ cheerModal.classList.add('show'); };
$('#cheerClose').onclick = ()=>{ cheerModal.classList.remove('show'); };
cheerModal.addEventListener('click', (e)=>{ if(e.target===cheerModal) cheerModal.classList.remove('show'); });

/* 事件 */
$('#btnBuild').onclick = build;
$('#btnCopy').onclick  = ()=>copyTarget('#out');
document.getElementById('btnCopySummary').onclick = ()=>copyTarget('#summaryOut');
$('#btnDocx').onclick  = buildWord;
/* 移动端长按预览框复制 */
(function(){
  let pressTimer=null;
  const target = document.getElementById('out');
  if(!target) return;
  const start = () => { pressTimer = setTimeout(()=>copyTarget('#out'), 550); };
  const cancel = () => { if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } };
  target.addEventListener('touchstart', start, {passive:true});
  target.addEventListener('touchend', cancel);
  target.addEventListener('touchmove', cancel);
  target.addEventListener('mousedown', start);
  ['mouseup','mouseleave'].forEach(ev=>target.addEventListener(ev, cancel));
})();
document.getElementById('ocrImg').insertAdjacentHTML('afterend','<div style="margin-top:8px"><button class="btn badge sky" id="btnOcr">识别EVA</button></div>');
document.body.addEventListener('click', (e)=>{ if(e.target && e.target.id==='btnOcr') ocrClick(); });

// 一键应用建议利率
document.addEventListener('click',(e)=>{
  if(e.target && e.target.id==='applySuggest'){
    const segs   = $$('#segChips .chip.sel').map(x=>x.dataset.v);
    const tenor  = $('#tenor').value;
    const seg    = segs[0] || '普惠';
    const thr    = (THRESH[tenor]||{})[seg];
    if(typeof thr==='number'){ $('#rate').value=thr.toFixed(2); build(); toast('已应用建议利率'); }
    else { toast('暂无建议值，请手动填写'); }
  }
});

/* 初始：可选 phrases.json → build */
loadPhrasesIfAny().finally(()=>{ buildPresets(); build(); });
</script>
</body>
</html>
