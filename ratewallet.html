<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>利率优惠签报 · 纯文本一键复制（含OCR）</title>
<style>
  :root{
    /* 清爽苹果风 + 细微动效 */
    --bg1:#f7f8fc; --bg2:#eef2ff;
    --paper:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --brand:#0a84ff; --brand2:#64d2ff; --ok:#34c759; --warn:#ff9f0a;
    --radius:16px; --shadow:0 10px 24px rgba(15,23,42,.06),0 2px 6px rgba(15,23,42,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font:15.5px/1.6 -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC",Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);
    background:linear-gradient(160deg,var(--bg1),var(--bg2))}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 120px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .logo{width:40px;height:40px;border-radius:12px;background:
    conic-gradient(from 220deg,var(--brand),#0f7dff 40%,var(--brand2) 80%,var(--brand));
    box-shadow:0 8px 18px rgba(10,132,255,.25)}
  h1{margin:0;font-weight:750;font-size:clamp(19px,2.4vw,26px);
    background:linear-gradient(90deg,#0f172a,#334155,#0f172a);-webkit-background-clip:text;background-clip:text;color:transparent}
  .sub{color:var(--muted);font-size:13px}

  .grid2{display:grid;grid-template-columns:1.06fr .94fr;gap:14px}
  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .section-title{font-weight:700;margin:2px 0 10px}
  .row{display:grid;grid-template-columns:130px 1fr;gap:10px;align-items:center;margin:10px 0}
  label{color:#475569}
  input[type=text], input[type=number], textarea{
    width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;color:var(--ink);
    padding:11px 12px;outline:none;transition:border .15s,box-shadow .15s
  }
  input:focus,textarea:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(10,132,255,.08)}
  textarea{min-height:120px}
  input[type=file]{font-size:13px;color:#475569}

  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #dde3f0;border-radius:999px;padding:7px 12px;background:linear-gradient(180deg,#fff,#f7f9fd);
    color:#1f2a44;cursor:pointer;transition:all .15s ease;box-shadow:inset 0 -1px 0 rgba(0,0,0,.03)}
  .chip:hover{transform:translateY(-1px)}
  .chip.sel{background:linear-gradient(180deg,#2563eb,#1d4ed8);color:#fff;border-color:transparent;box-shadow:0 6px 14px rgba(37,99,235,.25)}

  .dock{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.82);backdrop-filter:saturate(160%) blur(10px);
    border-top:1px solid var(--line);z-index:20}
  .dock-inner{max-width:1100px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center}
  .btn{display:inline-flex;align-items:center;justify-content:center;border:none;border-radius:12px;padding:11px 14px;color:#fff;
    background:linear-gradient(90deg,var(--brand),var(--brand2));box-shadow:0 10px 22px rgba(10,132,255,.25);cursor:pointer;font-weight:700}
  .btn.ghost{background:#eef2ff;color:#1f2a44;border:1px solid var(--line);box-shadow:none}
  .hint{color:var(--muted);font-size:12.5px}
  @media (max-width:860px){.grid2{grid-template-columns:1fr}.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>利率优惠签报 · 文本生成 & 一键复制</h1>
      <div class="sub">本地生成，不上传；可选OCR识别EVA；长按或点按钮即可复制全文</div>
    </div>
  </header>

  <div class="grid2">
    <div class="card">
      <div class="section-title">① 基本信息</div>
      <div class="row"><label>分行</label><input id="branch" type="text" value="厦门分行"/></div>
      <div class="row"><label>部门</label><input id="dept" type="text" value="科技业务部"/></div>
      <div class="row"><label>企业名称</label><input id="company" type="text" placeholder="如：厦门利邦荣财务有限责任公司"/></div>
      <div class="row"><label>审批权限</label>
        <div class="chips" id="permChips">
          <span class="chip sel" data-v="分行审批权限">分行审批权限</span>
          <span class="chip" data-v="二级分行审批权限">二级分行审批权限</span>
          <span class="chip" data-v="总行授权范围内">总行授权范围内</span>
          <span class="chip" data-v="其他">其他</span>
        </div>
      </div>
      <div class="row"><label>授信品种</label>
        <div class="chips" id="prodChips">
          <span class="chip sel" data-v="普惠小微贷款">普惠小微贷款</span>
          <span class="chip" data-v="科技金融贷款">科技金融贷款</span>
          <span class="chip" data-v="绿色金融贷款">绿色金融贷款</span>
          <span class="chip" data-v="一般工商贷款">一般工商贷款</span>
        </div>
      </div>
      <div class="row"><label>客群/资质</label>
        <div class="chips" id="segChips">
          <span class="chip sel" data-v="普惠小微">普惠小微</span>
          <span class="chip" data-v="科技企业">科技企业</span>
          <span class="chip" data-v="绿色企业">绿色企业</span>
          <span class="chip" data-v="一般客群">一般客群</span>
          <span class="chip" data-v="上市公司">上市公司</span>
          <span class="chip" data-v="台资企业">台资企业</span>
          <span class="chip" data-v="国有控股">国有控股</span>
          <span class="chip" data-v="民营控股">民营控股</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">② 关键参数</div>
      <div class="row"><label>金额（万元）</label><input id="amt" type="number" inputmode="decimal" placeholder="如：500"/></div>
      <div class="row"><label>期限</label><input id="tenor" type="text" placeholder="如：1年 / 12个月"/></div>
      <div class="row"><label>执行利率（%）</label><input id="rate" type="number" inputmode="decimal" placeholder="如：2.60"/></div>
      <div class="row"><label>存量利率（%）</label><input id="stockRate" type="number" inputmode="decimal" placeholder="可选，如：3.20"/></div>
      <div class="row"><label>LPR（%）</label><input id="lpr" type="number" inputmode="decimal" value="3.00"/></div>
      <div class="row"><label>FTP（%）</label><input id="ftp" type="number" inputmode="decimal" value="1.80"/></div>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="section-title">③ EVA（可手填或OCR识别）</div>
      <div class="row"><label>EVA（数值）</label><input id="eva" type="number" inputmode="decimal" placeholder="如：0.86"/></div>
      <div class="row"><label>上传截图</label>
        <div>
          <input id="evaImg" type="file" accept="image/*" multiple/>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn ghost" id="btnOcr">OCR 识别 EVA</button>
            <span class="hint" id="ocrLog">未识别</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">④ 其他补充（可选）</div>
      <textarea id="extra" placeholder="其他补充说明（如配套业务、代发、结算集中、风险控制等）"></textarea>
      <div class="hint" style="margin-top:6px">不涉及“自律加点豁免”默认无需披露；如涉及，请在申请要素中自行补充。</div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">⑤ 预览与复制</div>
    <textarea id="preview" readonly placeholder="这里将自动生成签报正文，长按可全选复制…"></textarea>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button class="btn" id="btnCopy">复制全文</button>
      <span class="hint" id="copyHint">已实时生成，支持长按全选复制</span>
    </div>
  </div>
</div>

<div class="dock">
  <div class="dock-inner">
    <button class="btn ghost" id="btnReset">清空表单</button>
    <span class="hint" id="status">就绪</span>
  </div>
</div>

<script>
'use strict';
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));

/*—— 交互：chips ——*/
document.body.addEventListener('click',(e)=>{
  const t=e.target;
  if(!(t instanceof HTMLElement) || !t.classList.contains('chip')) return;
  const g=t.parentElement; if(!g) return;
  // 审批权限、授信品种 → 单选；客群/资质 → 多选
  if(g.id==='permChips' || g.id==='prodChips'){
    g.querySelectorAll('.chip').forEach(x=>x.classList.remove('sel'));
    t.classList.add('sel');
  }else{
    t.classList.toggle('sel');
  }
  buildPreview();
});

/*—— 文本工具 ——*/
function bpDiff(rate, base){
  if(!isFinite(rate)||!isFinite(base)) return '';
  const bp=Math.round((rate-base)*100);
  if(bp===0) return '与'+fmtPct(base)+'持平';
  return (bp<0?('下浮 '+Math.abs(bp)+'BP'):('上浮 '+bp+'BP'))+'（较 '+fmtPct(base)+'）';
}
function ftpPhrase(rate, ftp){
  if(!isFinite(rate)||!isFinite(ftp)) return '';
  const bp=Math.round((rate-ftp)*100);
  return (bp>=0?('高于 FTP（'+fmtPct(ftp)+'） '+bp+'BP'):('低于 FTP（'+fmtPct(ftp)+'） '+Math.abs(bp)+'BP'));
}
function fmtPct(v){ return isFinite(v)?(Number(v).toFixed(2)+'%'):'—' }
function getSelText(boxId){ return $$('#'+boxId+' .chip.sel').map(x=>x.dataset.v) }

/*—— 生成各段 ——*/
function buildTitle(branch, dept, company){
  const b = (branch||'').trim()||'厦门分行';
  const d = (dept||'').trim()||'科技业务部';
  const c = (company||'').trim()||'（填写企业名称）';
  return `${b}${d}关于${c}贷款利率优惠的申请`;
}
function buildFactorSection(){
  const perm = getSelText('permChips')[0]||'分行审批权限';
  const prod = getSelText('prodChips')[0]||'普惠小微贷款';
  const amt = $('#amt').value.trim();
  const tenor = $('#tenor').value.trim();
  const rate = parseFloat($('#rate').value);
  const stock = parseFloat($('#stockRate').value);
  const lpr = parseFloat($('#lpr').value||'3.00');
  const ftp = parseFloat($('#ftp').value||'1.80');

  const line1 = `- 对应审批权限：${perm}。`;
  const line2 = `- 申请事项：金额 ${amt||'—'} 万元，期限 ${tenor||'—'}，授信品种 ${prod}，拟执行利率 ${isFinite(rate)?fmtPct(rate):'—'}。`;
  const line3 = isFinite(rate)&&isFinite(lpr) ? `- 利率口径：较一年期 LPR ${bpDiff(rate,lpr)}；${ftpPhrase(rate,ftp)}。` : `- 利率口径：—。`;
  const line4 = isFinite(stock) ? `- 存量贷款执行利率 ${fmtPct(stock)}，本次申请调整为 ${isFinite(rate)?fmtPct(rate):'—'}。` : null;
  return ['二、贷款利率要素', line1, line2, line3].concat(line4?[line4]:[]).join('\n');
}
function buildQualification(){
  const segs = getSelText('segChips');
  const segLine = segs.length? `- 客群类别：${segs.join('、')}。` : `- 客群类别：一般客群。`;
  // 资质措辞（通用、安全）
  const qual = [
    '- 股权与控股：治理结构清晰、实际控制人背景稳健，信用记录良好。',
    '- 综合经营：经营真实有效，主营与行业对标匹配，账户交易正常、结算集中度较高。'
  ];
  return ['三、客户资质说明', segLine].concat(qual).join('\n');
}
function buildApplyReasons(){
  const segs = getSelText('segChips');
  const rate = parseFloat($('#rate').value);
  const lpr = parseFloat($('#lpr').value||'3.00');
  const ftp = parseFloat($('#ftp').value||'1.80');
  const eva = parseFloat($('#eva').value);
  const extra = $('#extra').value.trim();

  const lines = [];
  // 资金成本与匹配性
  const match = [];
  if(segs.includes('绿色企业')) match.push('可匹配绿色债等低成本资金来源，资金成本可控');
  if(segs.includes('科技企业')) match.push('可匹配科技债等低成本资金来源，资金成本可控');
  match.push('贷款资金封闭运行，投向合规，流向可全程监控');
  lines.push('1. 资金成本与匹配性：'+match.join('，')+'。');

  // 收益测算与EVA
  const evaTxt = isFinite(eva) ? `经营中台测算 EVA 为 ${eva.toFixed(2)}，` : '经营中台测算 EVA 为正（数值见附件/系统），';
  const spread = (isFinite(rate)&&isFinite(ftp)) ? `利差可覆盖资金成本、风险成本与运营费用，` : '';
  lines.push(`2. 收益测算与 EVA：${evaTxt}${spread}整体利润空间为正。`);

  // 综合贡献
  const contrib = [
    '预计带动结算业务量与中间业务收入提升',
    '引导客户集中结算并提升归行资金比例',
    '推进代发工资、POS收单、跨境结算等综合金融服务'
  ];
  lines.push('3. 综合贡献与配套业务：'+contrib.join('；')+'。');

  // 风险与合规
  lines.push('4. 风险与合规：客户为非关联方；不涉及自律加点豁免；资料真实、流程合规，贷后监测与限额管理同步落实。');

  if(extra) lines.push('5. 其他补充：'+extra);

  return ['五、申请理由'].concat(lines).join('\n');
}
function buildApplyItems(){
  const amt = $('#amt').value.trim() || '—';
  const tenor = $('#tenor').value.trim() || '—';
  const rate = $('#rate').value.trim() || '—';
  const stock = $('#stockRate').value.trim();
  const prod = getSelText('prodChips')[0]||'普惠小微贷款';

  const base = [
    `- 本次拟新增授信额度 ${amt} 万元，期限 ${tenor}，授信品种为【${prod}】，拟执行利率 ${rate?rate+'%':'—'}。`
  ];
  if(stock){
    base.push(`- 存量贷款执行利率 ${stock}%（如适用），本次申请调整为 ${rate?rate+'%':'—'}，调整后仍保持合理利差。`);
  }
  base.push('- 拟采取的风险缓释措施完备，担保/抵质押安排合规可执行。');
  return ['四、申请事项'].concat(base).join('\n');
}
function buildEvaSec(){
  const eva = $('#eva').value.trim();
  return ['六、EVA 摘要', (eva?`- EVA 数值：${eva}`:'- EVA 数值：未提供（如有请补充或以OCR识别）')].join('\n');
}
function buildHeader(){
  const title = buildTitle($('#branch').value,$('#dept').value,$('#company').value);
  const factors = buildFactorSection();
  const qual = buildQualification();
  const items = buildApplyItems();
  const reasons = buildApplyReasons();
  const eva = buildEvaSec();
  return `${title}\n\n一、申请要素\n（本段已结构化生成，详见下文“二、贷款利率要素”）\n\n${factors}\n\n${qual}\n\n${items}\n\n${reasons}\n\n${eva}\n\n七、其他事项\n- 已完成关联关系核查，未发现关联交易风险（如需可附截图）。\n- 本次申请不涉及自律加点豁免；如后续涉及，将按要求补充报备材料并报相关条线审核。`;
}
function buildPreview(){
  $('#preview').value = buildHeader();
  $('#status').textContent='已更新';
}

/*—— 事件绑定：任一输入变化即重算 ——*/
['branch','dept','company','amt','tenor','rate','stockRate','lpr','ftp','eva','extra'].forEach(id=>{
  const el=$('#'+id); if(el){ el.addEventListener('input', buildPreview); }
});
buildPreview();

/*—— 复制 ——*/
$('#btnCopy').onclick = async ()=>{
  const txt=$('#preview').value;
  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(txt);
    }else{
      const ta=$('#preview'); ta.select(); document.execCommand('copy');
    }
    $('#copyHint').textContent='✅ 已复制到剪贴板';
  }catch(e){
    $('#copyHint').textContent='❌ 复制失败，可长按全选再复制';
  }
};
// 移动端长按全选
(function enableLongPress(){
  const ta=$('#preview'); if(!ta) return;
  let t; ta.addEventListener('touchstart',()=>{ t=setTimeout(()=>{ ta.select(); },500); });
  ta.addEventListener('touchend',()=>clearTimeout(t));
})();

/*—— 重置 ——*/
$('#btnReset').onclick = ()=>{
  ['company','amt','tenor','rate','stockRate','eva','extra'].forEach(id=>$('#'+id).value='');
  $('#lpr').value='3.00'; $('#ftp').value='1.80';
  // 恢复默认 chips
  $$('#permChips .chip').forEach(x=>x.classList.remove('sel')); $$('#permChips .chip')[0].classList.add('sel');
  $$('#prodChips .chip').forEach(x=>x.classList.remove('sel')); $$('#prodChips .chip')[0].classList.add('sel');
  $$('#segChips .chip').forEach(x=>x.classList.remove('sel')); ['普惠小微'].forEach(v=>{ const n=$$('#segChips .chip').find(x=>x.dataset.v===v); if(n) n.classList.add('sel'); });
  buildPreview();
};

/*—— OCR：Tesseract.js（在线加载，失败不影响） ——*/
let ocrReady=false, ocrLoading=false;
async function ensureOCR(){
  if(ocrReady||ocrLoading) return ocrReady;
  ocrLoading=true;
  try{
    await new Promise((res,rej)=>{
      const s=document.createElement('script'); s.src='https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js';
      s.onload=()=>res(); s.onerror=()=>rej(new Error('load fail')); document.head.appendChild(s);
    });
    ocrReady=true; $('#ocrLog').textContent='OCR 已加载';
  }catch(_){ $('#ocrLog').textContent='OCR 加载失败（可手填）'; }
  ocrLoading=false; return ocrReady;
}
function extractEvaFrom(text){
  // 优先匹配“EVA 1.23 / EVA：0.86% / EVA=-0.12”
  const m1 = text.match(/E\s*V\s*A[^0-9\-]*([-+]?\d+(?:\.\d+)?)(\s*%?)/i);
  if(m1) return parseFloat(m1[1]);
  // 退而求其次：找类似“EVA值为 1.23”周边数字
  const m2 = text.match(/值为\s*([-+]?\d+(?:\.\d+)?)/i);
  if(m2) return parseFloat(m2[1]);
  // 再不行：拿全文中出现次数最多的 0.x 或 x.xx（有风险，仅兜底）
  const nums = (text.match(/[-+]?\d+(?:\.\d+)?/g)||[]).map(Number).filter(n=>isFinite(n));
  if(nums.length) {
    // 取接近 0~5 区间的数作为可能的 EVA
    const cand = nums.filter(n=>Math.abs(n)<=10);
    if(cand.length) return cand[0];
  }
  return NaN;
}
$('#btnOcr').onclick = async ()=>{
  const files = $('#evaImg').files;
  if(!files || !files.length){ $('#ocrLog').textContent='未选择截图'; return; }
  const ok = await ensureOCR(); if(!ok){ alert('OCR 加载失败，可手动填写 EVA 数值'); return; }
  $('#ocrLog').textContent='识别中…';
  try{
    let merged=''; let firstEva;
    for(const f of files){
      const url=URL.createObjectURL(f);
      const r=await Tesseract.recognize(url,'chi_sim+eng'); URL.revokeObjectURL(url);
      const txt=(r&&r.data&&r.data.text)||''; merged+=('\n'+txt);
      if(firstEva==null){
        const v=extractEvaFrom(txt);
        if(isFinite(v)) firstEva=v;
      }
    }
    if(isFinite(firstEva)){ $('#eva').value=String(firstEva); $('#ocrLog').textContent='已识别 EVA='+firstEva.toFixed(2); }
    else { $('#ocrLog').textContent='未识别到 EVA（可手填）'; }
    buildPreview();
  }catch(e){
    console.error(e); $('#ocrLog').textContent='识别失败（可手填）';
  }
};

/*—— 自检（简单用例） ——*/
(function tests(){
  const t1 = bpDiff(2.60,3.00).includes('下浮 40BP');
  const t2 = ftpPhrase(2.60,1.80).includes('高于 FTP') && ftpPhrase(1.60,1.80).includes('低于 FTP');
  console.log('✅ 测试 bpDiff=',t1,' ftpPhrase=',t2);
})();
</script>
</body>
</html>
